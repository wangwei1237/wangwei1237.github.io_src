<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>怎样更好的汇报自己的工作</title>
    <url>/2021/02/25/how-to-report-ourselves-work/</url>
    <content><![CDATA[<p>今年的职称评定工作比以往来的要早一点，好多的同学不得不在春节假期就准备自己的材料。每一次review别人的材料后，总会有一些感想，一直也没有时间整理出来，趁着这次机会，也结合自己过去的实践做一个简单的总结。</p>
<p><img src="/2021/02/25/how-to-report-ourselves-work/4.jpeg" alt></p>
<a id="more"></a>
<h2 id="我如何看待ppt">我如何看待PPT</h2>
<p>2019年，新东方年会的一个节目“释放自我”在互联网圈火了：</p>
<blockquote>
<p>干活的累死累活，有成果那又如何，到头来干不过写PPT的</p>
</blockquote>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=47440004&page=1&danmaku=0" scrolling="no" border="0" frameborder="no" framespacing="0" " allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<p>作为一个技术人，我即反对过度的PPT总结，同时更反对缺乏任何的PPT的总结，只是不要过度包装就好。很多的技术人员会认为只有写写代码才是正事，写PPT纯粹是浪费时间，并且还会说在亚马逊内部，开会时是不会出现画面丰富的PPT的，而是以文字呈现出来的备忘录。</p>
<p>但是，对于职称申请而言，这可不是一次普通的会议。我们要展现出自己的亮点，让评委认可我们的工作，PPT无疑是我们理清工作思路，展现工作成果，分享自己观点的绝佳手段和呈现形式。当对外宣传自己的产品的时候，亚马逊也是采用PPT的方式。</p>
<h2 id="如何框定ppt的版式">如何框定PPT的版式</h2>
<p>当然，对于技术人员而言，PPT不在于有多炫酷、动效有多牛，而在于对内容的合理的组织。缺乏内容的PPT，即便再炫酷也无用。</p>
<p>作为多年的技术人，我写过各种场景的PPT：</p>
<ul>
<li>部门总结大会的</li>
<li>职称申请的</li>
<li>向上汇报的</li>
<li>技术分享会的</li>
<li>技术宣讲会的</li>
<li>……</li>
</ul>
<p>我认为，在PPT的版式上，我们只需要做到让PPT看起来很干净就可以了，没必要在PPT的样式上花费太多的心思。干净要求我们的PPT的内容要：字体统一、样式统一、色调统一，风格统一……</p>
<p>有的同学，动不动就飘红，加粗，加背景，可能是想强调这里是重点，但是当这一页中所有内容都有各种样式的时候，也就分不清哪里是重点，哪里是非重点了。七种颜色一混合，那不就成了白色了吗？</p>
<h2 id="如何进行ppt的整体组织">如何进行PPT的整体组织</h2>
<p>在评审过程中，我发现大部分同学无论是在材料的组织上还是在PPT的组织上，都是乱的一塌糊涂，没有任何逻辑可言，纯粹就是在罗列一件件自己做的事情。</p>
<p>这里我们要清楚一点：材料的意义和作用在于证明我们已经具备了某些方面的能力，材料的功能就是论据。只有材料，没有材料所支持的观点那又有什么意义呢？让评委通过材料来猜吗？</p>
<p>因此，在材料的组织上，我一般推荐使用议论文的三要素来组织：</p>
<ul>
<li>论点</li>
<li>论据</li>
<li>论证</li>
</ul>
<p>我们需要根据要证明的不同能力来对材料进行分类，聚合，然后通过一定的论证方法来整合自己所做的每一件事情。在整合的过程中可以遵循以下的几点：</p>
<ul>
<li>
<p>结构化思维来组织材料：</p>
<ul>
<li>结论先行</li>
<li>以上统下</li>
<li>归纳分组：同类材料归类，有时候同一个材料可能说明我们具备多种能力，那这种情况下，在材料的选择上需要有所取舍，这个材料重点能说明哪些能力？正所谓“横看成岭侧成峰，远近高低各不同”。</li>
<li>逻辑递进：纵向有逻辑关系，横向有递进关系。<br>
<img src="/2021/02/25/how-to-report-ourselves-work/1.jpeg" alt></li>
</ul>
</li>
<li>
<p>每一个大的论点下面可以有多个不同的分论点，但是切忌，分论点不宜过多，最好不要超过3个。</p>
</li>
<li>
<p>不同论点的组织可以采用总分的结构，也可以采用总分总的结构，具体可以根据自己的喜好选择一种。</p>
</li>
<li>
<p>整个PPT的所有页面都是有逻辑关系的，需要认真考虑上下页之间的关联和衔接。</p>
</li>
</ul>
<h2 id="如何选择ppt的材料">如何选择PPT的材料</h2>
<p>在确定了PPT的大的组织方式之后，在正式开始之前，也需要对自己的所有的材料进行甄选，需要明确好要选择那些材料，要放弃那些材料，不同的材料用来支撑那些论点等。在选择材料的时候，可以遵循以下的几点：</p>
<ul>
<li>重要的内容说三遍，对于特别重要的内容，可以重复提及，但是要从不同的层面来提及，而不是简单的重复同样的内容。如果要强调自己的技术能力，可以通过：技术调研，攻克技术难点，自研核心卡脖子技术等多个方面来写。同样是写容貌，可以从沉鱼、落雁、闭月、羞花等方面来反复陈述。</li>
<li>通过别人的评价来证明自己的能力。雷士照明创始人吴长江说：人生五大发展阶段，首先自己要行；其次要有人说你行；再次，说你行的人要行；然后，你说谁行谁就行；最后，谁敢说你不行。因此，在选择别人评价的时候要选择那些重量级的人物，选择那些大家公认的“能行”的人物。</li>
</ul>
<p>当按照结构化思维确定了PPT的整体组织，并且按照PPT的整体组织选定了材料后，如果此时材料仍然比较多，该如何处理呢？怎们来确定哪些材料要放在前面，哪些材料需要删减？我一般采用的方法是把材料划分为5类：</p>
<ul>
<li>痛点材料：解决痛点问题的材料，例如手机上天天有骚扰电话、垃圾短信，有了号码通，一切都解决了。</li>
<li>兴奋点材料：这类材料可以让别人有眼前一亮的“哇塞”感，就好像是炎热夏天时喝下的那口冰红茶。</li>
<li>痒点材料：这种材料解决的问题不一定是痛点问题，但是讲出来之后别人也想尝试。</li>
<li>不痛不痒的材料：可做可不做，但是我们做了，效果层面又不太好说的材料。</li>
<li>常规材料：日常的常规工作。</li>
</ul>
<p>在对材料排序的时候，优先选择痛点材料和兴奋点材料，可以酌情选择痒点材料，尽量删减不痛不痒的材料和常规材料。</p>
<h2 id="如何组织每个材料">如何组织每个材料</h2>
<p>好多的材料都是在记流水账，比如：都是我优化了算法，优化了流程，优化了……我干了这个，做了那个，……</p>
<p>每次看到这种材料，我就会很气愤，我就忍不住的想打低分，这种材料毫无营养可言，毫无信息量可言。</p>
<p>每个材料都应该是一个完整的故事单元，每个材料都应该用最简短的内容体现出最大的信息量，如何才能做到这一点呢？</p>
<p>我一般采用的原则就是STAR原则：</p>
<ul>
<li>S（Situation）情境：做这个事情的背景下是什么？</li>
<li>T（Target）任务/目标：做这个事情要解决什么问题，要达到的目标是什么？</li>
<li>A（Action）行动：在整个项目中我们做了什么？</li>
<li>R（Result）结果：最终的结果如何？价值是怎样的？收益是怎样的？</li>
</ul>
<p><img src="/2021/02/25/how-to-report-ourselves-work/2.png" alt></p>
<p>按照如上的原则组织的材料首先能在背景方面讲所有人拉到一个场景下来思考问题，保证大家的基准是一致的。</p>
<p>另外，背景的意义还在于大家会通过背景来了解到我们所做工作面临的难度，我们要解决的目标的复杂度。难度，复杂度决定了我们的高度。有些时候，难度不是我们说出来的，而是在我们介绍完背景之后大家的共识。</p>
<p>背景要做到少一字则解释不清楚，多一字则是累赘的要求，切忌长篇大论。弱水三千，只取一瓢饮。哐哐哐整页整页的上架构图干嘛呀。</p>
<p>然后在对问题有了一致认识的情况下，才能评估我们拆解的目标是不是合理的，如果连目标都不合理，那么基本上后面所有的内容就没有什么意义了。</p>
<p>有了背景，有了目标，我们的行动才更有意义，才能体现出我们的技术能力，解决问题的能力……</p>
<p>最重要的是，我们做的事情是有结果的，所以最终的结果也是不可获取的内容。只有结果没有过程，那成功就不可复制；只有过程，没有结果，那过程就是垃圾。</p>
<h4 id="司马光砸缸的材料">司马光砸缸的材料</h4>
<p>以司马光砸缸为例，为了体现司马光的英勇果敢，我们可以按STAR原则来组织材料：</p>
<ul>
<li>S：一群小孩在院子里玩闹，其中一个小孩爬到了水缸边沿，一不小心，跌入了水缸没入水中，其他小孩都吓跑了。</li>
<li>T：要把小孩救出来。</li>
<li>A：司马光拿起石头，砸破了水缸。</li>
<li>R：水从水缸里流了出来，小孩得救了。</li>
</ul>
<p><img src="/2021/02/25/how-to-report-ourselves-work/3.jpeg" alt></p>
<p>如果按照之前的材料写法，那么这个材料就成了：司马光拿起石头，砸破了水缸。如果是这样的话，那么我们如何根据这个材料来对司马光做出评价呢？</p>
<h2 id="如何处理不同级别使用同一材料的场景">如何处理不同级别使用同一材料的场景</h2>
<p>我经常会发现很多不同的级别会引用同样的项目，但是在材料的表述上，又基本一致。如果是这样，那么高级别的同学如何能体现出自己的价值呢？</p>
<p>一个项目确实是由一个团队来完成的，但是这个团队的组成是不同的，就像篮球队一样，有：</p>
<ul>
<li>教练</li>
<li>前锋
<ul>
<li>小前锋</li>
<li>大前锋</li>
</ul>
</li>
<li>中锋</li>
<li>后卫
<ul>
<li>控球后卫</li>
<li>得分后卫</li>
</ul>
</li>
</ul>
<p>完成一个项目的众多团队成员中也会有不同的级别，而不同的级别所担负的职能和责任也不尽相同。因此，在这种情况下，在材料的准备上，要体现出符合自己所处级别要求的材料。</p>
<h2 id="如何组织工作收益">如何组织工作收益</h2>
<p>我看到最多的材料收益是下面的样子：</p>
<ul>
<li>我的技术累计代码行数xxx行</li>
<li>我的技术被多少产品线使用</li>
<li>我开发了多少接口</li>
<li>我的接口被调用了多少次</li>
<li>……</li>
</ul>
<p>但是，在我看来，这些不是具体的收益，这些不过是一个结果而已。以司马光砸缸为例，这就好比是：小孩跌入水缸，没入水中，司马光拿起石头，砸破水缸，水流了出来。</p>
<p>如上的这种结果的写法，这种收益的写法，在我看来是不完整的。</p>
<p>我们在写收益的时候，需要特别注意这一点，我们要多问自己几个：然后呢？</p>
<p>水流了出来，然后呢？</p>
<p>水流了出来不是收益，不是价值，小孩得救了才是最大的价值。开发了几百个接口是现实，然后呢？这些接口提升了50%的研发效率，这才是价值。</p>
<p>目标是业务价值，技术改进只是手段而已，做技术改进的目标不是为了多少次的接口调用，而是实现业务价值。因此，在收益部分要明确好目标和手段的关系。</p>
<h2 id="如何组织-个人介绍">如何组织“个人介绍”</h2>
<p>平时就让所有的人就对我们就非常了解是一件非常难的事。因此，在这种场景下，一份完美的个人介绍材料就相当于是：万事开头难。</p>
<p>有些同学在这一页组织的的过于随意，只是简单罗列一下自己的工作经历就草草了事。殊不知，这种内容还不如没有。草草了事往往会给人不好的印象，往往从一开始就拉低了自己在别人中的层级。这种时候就属于：没有印象比有一个比较差的印象要好很多。</p>
<p>其实，个人介绍这一页的内容不在多，而在于引导别人从哪个角度来评价自己，在于引导别人给自己打上一个什么标签，在于引导别人确定自己的层级……</p>
<p>因此，这一页的材料组织要特别用心，要从自己取得的成就来铺开，要针对自己期望的标签来铺开。比如要体现自己的技术卓越，可以从：专利，获得的高价值的技术创新奖等方面来展开。因为，这些奖项的获取，是经过了审核和认证的，是大家公认的，是不需要别人再做二次评估的。</p>
<p>因此，个人介绍中的材料需要本着如下的原则：</p>
<ul>
<li>材料足够精简但要足够闪光</li>
<li>材料不需要别人二次评估</li>
<li>根据期望别人如何定位自己来组织材料</li>
</ul>
<h2 id="如何应对别人的质疑">如何应对别人的质疑</h2>
<p>所有人都会存在心理上的自我保护机制，当别人质疑我们的时候，这种自我保护机制就会不自然开启。此时，为了减轻别人的质疑所产生的紧张和焦虑，我们会找一些表面上冠冕堂皇的理由来为自己辩护以自圆其说，当然这些理由是经不起推敲的，并非真理由，也非好理由。</p>
<p><img src="/2021/02/25/how-to-report-ourselves-work/5.gif" alt></p>
<p>还会有同学自命不凡，觉得评委什么都不懂，就是坐在下面不停的瞎问，所以在回答评委的问题上，也会显得漫不经心。</p>
<p>我们都是凡人，凭什么我们讲的内容别人就不能有疑问呢？凭什么要求别人就必须认同我们的观点呢？</p>
<p>有时候，有质疑就是我们体现自己的绝佳时刻，因为质疑，我们才能利用这种机会来更详细的阐述自己所做的事情的思路和价值。我们之前讲过：重要的事情说三遍，其实，在回答问题时，就是其中的一遍呀。将别人从质疑带入到认同的过程，是一个呈现自己的良好的机会。</p>
<p>在应对别人的质疑的时候，需要遵循如下的原则：</p>
<ul>
<li>把回答质疑看作是一个分享成果的过程，避免启动自我心理保护</li>
<li>先想清楚别人质疑的点在哪里，不要答非所问，乱说一通</li>
<li>掌握整个答疑的主动权，别被别人牵着鼻子走</li>
</ul>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>汇报</tag>
        <tag>述职</tag>
      </tags>
  </entry>
  <entry>
    <title>HDR技术导论</title>
    <url>/2021/01/26/HDR-introduction/</url>
    <content><![CDATA[<p>真实世界的亮度范围是十分广阔的，而人眼能感知到的亮度范围在十万尼特左右。举个例子，用分光色度计测量向着阳光盛开的花朵，其黄色区域亮度最高可达14700尼特，边缘的红色是2300尼特，中央的花蕊和绿叶只有200尼特以下。但是，在窄色域、亮度普遍不超过100尼特、对比度也只有1000：1的SDR显示器下，这张照片的色彩会暗淡很多。但是随着技术的发展，HDR技术可以达到广色域、1000尼特亮度以及上万的对比度。虽然和现实标准相差还是比较大，但是相较于三十年前的SDR，HDR还是前进了一大步。</p>
<p><img src="/2021/01/26/HDR-introduction/nit.jpg" alt></p>
<a id="more"></a>
<h2 id="hdr介绍">HDR介绍</h2>
<p>HDR是<em>High Dynamic Range</em>的缩写。HDR是一种数字图像技术，可以利用这种技术来提升数字图像的色彩以及对比度的范围。</p>
<p>和SDR（<em>Standard Dynamic Range</em>：标准动态范围）相比，HDR具有如下特点：</p>
<ul>
<li>更宽的色彩范围</li>
<li>更亮的亮度上限</li>
<li>更黑的亮度下限</li>
<li>在对比度、灰度分辨率等维度上对影像质量上进行了整体提升</li>
</ul>
<p>从而，HDR可以给用户带来更具沉浸式的感受。</p>
<p>HDR技术可以应用于拍照（<em>photography</em>）和视频（<em>video</em>），但是需要注意的是：虽然<code>photo HDR</code>和<code>video HDR</code>的目标都是让我们所看到的数字内容更逼近人眼的真实体验，但是这两者确实是完全不同的两个概念。本质上讲，<code>photo HDR</code>是一个相机捕获照片（<em>capture</em>）的过程，而<code>video HDR</code>则是一个显示(<em>display</em>)的过程。[^1]</p>
<h2 id="光度学概念及单位">光度学概念及单位</h2>
<p>在进一步介绍HDR之前，我们需要先了解一些<a href="http://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=AB4FAB66987D97573EA90F4DD56ABA36" target="_blank" rel="noopener">光度学</a>的相关概念，以便能够能够对HDR有更好的理解和认识。</p>
<ul>
<li>
<p><strong>辐射通量</strong>：在光辐射测量学中，使用的基本物理量是<code>辐射通量</code>或<code>辐射功率</code>，符号表示为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Φ</mi><mi>e</mi></msub></mrow><annotation encoding="application/x-tex">\Phi_{e}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，单位是瓦特（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span>）。辐射通量由一个辐射源发出，并通过某种传播介质进行传输并在某种表面上接收该辐射通量。</p>
</li>
<li>
<p><strong>光通量</strong>：<code>光通量</code>是指按照国际规定的标准人眼视觉特性评价的辐射通量的导出量，也就是对<code>辐射通量</code>的光度量，其符号为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\Phi_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。可以从<code>辐射通量</code>来导出<code>光通量</code>。</p>
</li>
<li>
<p><strong>光量</strong>： <code>光量</code>也称为<code>光能</code>，指的是在给定的时间间隔（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\Delta t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord mathdefault">t</span></span></span></span>）内，<code>光通量</code>的时间积分，符号表示为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">Q_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>v</mi></msub><mo>=</mo><msub><mo>∫</mo><mrow><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow></msub><mrow><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow></mrow><annotation encoding="application/x-tex">Q_{v}=\int_{\Delta t}{\Phi_{v} \cdot dt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1608200000000002em;vertical-align:-0.35582em;"></span><span class="mop"><span class="mop op-symbol small-op" style="margin-right:0.19445em;position:relative;top:-0.0005599999999999772em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.12251099999999993em;"><span style="top:-2.34418em;margin-left:-0.19445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35582em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">t</span></span></span></span></span>。</p>
</li>
<li>
<p><strong>发光强度</strong>：<code>发光强度</code>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">I_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）为光源发出的并且在指定方向的立体角元<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">Ω</mi></mrow><annotation encoding="application/x-tex">d \Omega</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord">Ω</span></span></span></span>内传播的光通量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d \Phi_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault">d</span><span class="mord"><span class="mord">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>与该立体角元<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">Ω</mi></mrow><annotation encoding="application/x-tex">d \Omega</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord">Ω</span></span></span></span>的商，即：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>v</mi></msub><mo>=</mo><mfrac><mrow><mi>d</mi><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub></mrow><mrow><mi>d</mi><mi mathvariant="normal">Ω</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">I_{v}=\frac{d \Phi_{v}}{d \Omega}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2412079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8962079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mtight">Ω</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mtight"><span class="mord mtight">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。<code>发光强度</code>的单位为<code>坎德拉</code>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">cd</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">d</span></span></span></span>）。坎德拉是发射出频率为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>540</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>12</mn></msup><mi>H</mi><mi>z</mi></mrow><annotation encoding="application/x-tex">540 \times 10^{12} Hz</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mord">4</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span>的单色辐射的光源在指定方向上的发光强度，并且该光源在该方向上的辐射强度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>683</mn></mfrac><mi>W</mi><mo>⋅</mo><mi>s</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">\frac{1}{683} W \cdot sr</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">8</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span>。</p>
</li>
<li>
<p><strong>光亮度</strong>： <code>光亮度</code>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">I_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）指在某方向上单位投影面积的面光源沿该方向的<code>发光强度</code>。面光源上小面元的面积为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">dA</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span></span></span></span>，某一方向与面元法线的夹角为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span></span></span></span>，面元沿这个方向的投影面积为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>A</mi><mo>⋅</mo><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi></mrow><annotation encoding="application/x-tex">dA \cdot cos \theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span></span></span></span>，则面元沿这个方向的光亮度为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mi>I</mi><mi>v</mi></msub><mrow><mi>d</mi><mi>A</mi><mo>⋅</mo><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{I_{v}}{dA \cdot cos \theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.233431em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8884309999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">A</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.07847em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>v</mi></msub><mo>=</mo><mfrac><mrow><mi>d</mi><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub></mrow><mrow><mi>d</mi><mi>A</mi><mo>⋅</mo><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi><mo>⋅</mo><mi>d</mi><mi mathvariant="normal">Ω</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">I_{v}=\frac{d \Phi_{v}}{dA \cdot cos \theta \cdot d \Omega}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2412079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8962079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">A</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">d</span><span class="mord mtight">Ω</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mtight"><span class="mord mtight">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。由此可知，<code>光亮度</code>的单位为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>d</mi><mi mathvariant="normal">/</mi><msup><mi>m</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">cd/m^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">d</span><span class="mord">/</span><span class="mord"><span class="mord mathdefault">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>（坎德拉/平方米），又称为<code>尼特</code>。例如，iPhone12的屏幕的光亮度为：625 尼特最大亮度 (典型)，1200 尼特最大亮度 (HDR)。</p>
</li>
</ul>
<h2 id="photography-hdr">photography HDR</h2>
<p>可以通过同时捕获不同曝光度的多张图像的方法来生成HDR照片。相机会使用不同的曝光值快速拍摄三张或更多的照片，然后对其进行处理，以生成一张HDR照片。</p>
<p>在拍摄高对比度场景的照片时，HDR图像处理非常有用。</p>
<p>如下图的夜景所示，例如，曝光度太低时，会让后面的景色显得暗淡。如果调整曝光以显示后面的景色，则前面的景色又会太亮，甚至可能会完全变白。通过组合多次曝光，则可以平均这些不同的曝光，使的后面的景色可以出现在照片上，而又不会过度曝光前面的景色。[^2]</p>
<p><img src="/2021/01/26/HDR-introduction/EVDifferent.png" alt></p>
<p><img src="/2021/01/26/HDR-introduction/EVToneMapping.png" alt></p>
<p>目前，很多智能手机（例如iPhone）的相机都具有HDR选项。我们可以选择让相机：</p>
<ul>
<li>开启HDR（ON）</li>
<li>关闭HDR（OFF）</li>
<li>自动判断是否开启HDR（Auto）</li>
</ul>
<p>对于Auto模式，相机仅在高对比度的情况下才拍摄HDR照片。大多数相机还会在合成HDR照片时，同时捕获普通照片，从而允许我们可以在HDR照片和普通照片之间进行选择。</p>
<h3 id="dodging-and-burning和tone-mapping">dodging and burning和tone mapping</h3>
<p>实际上，在胶片时代，摄影师就会拍摄多张不同曝光程度的底片，并在<a href="https://baike.baidu.com/item/%E6%9A%97%E6%88%BF/62291" target="_blank" rel="noopener">暗房</a>中使用一种**<a href="https://en.wikipedia.org/wiki/Dodging_and_burning" target="_blank" rel="noopener">dodging and burning</a>**的手法，把数张底片合成为一张具有高动态范围的照片。随着数码相机的出现，HDR将暗房里的技术引入相机成像传感器，通过对同一个场景进行多种不同的曝光，然后对其进行合成，最终实现增强照片动态范围，达到增加照片层次感的目的。在照片HDR中，这种合成技术称之为<a href="https://en.wikipedia.org/wiki/Tone_mapping" target="_blank" rel="noopener">色调映射（<em>tone mapping</em>）</a>。当然，在接下来的<code>video HDR</code>中也会用到色调映射技术，不同的是，<code>video HDR</code>中的色调映射是用来将HDR内容映射到SDR显示设备，使得SDR设备也能显示HDR内容。</p>
<h2 id="video-hdr">video HDR</h2>
<p>HDR视频的捕获方式与HDR照片类似。同时以不同的曝光（或不同的ISO配置）来录制每个镜头。然后把这些镜头融合在一起以生成单个镜头。尽管会产生看起来不真实的灰色效果，但这种方法通常可以使视频更亮。因此，HDR视频通常会在发布之前进行后期处理。</p>
<p>为了正确的显示HDR视频，显示设备也必须支持HDR。例如，具备HDR功能的电视必须支持特定的视频输出标准。这些标准中会涉及：10-bit色彩和至少覆盖90％的DCI-P3色彩空间。HDR显示器还必须支持特定的HDR格式，例如HDR10，Dolby Vision或Hybrid Log Gamma（HLG）。</p>
<p><img src="/2021/01/26/HDR-introduction/color_space.jpg" alt></p>
<p>CIE 1931 xy 中各个色彩空间的对比</p>
<p>以HDR10为例，因为HDR10标准使用广色域<code>Rec.2020</code>，10-bit色深以及<code>SMTPE ST 2084</code>PQ转换函数，因此在一台非HDR显示设备上去显示HDR10的内容，则会出现两种情况[^3],[^4]：</p>
<ul>
<li>无法解码导致花屏</li>
<li>可以解码，但是因为影片中的高亮部分会按照显示设备的最高亮度来显示而导致影片整体变灰</li>
</ul>
<p>这也就是HDR照片和HDR视频的不同之处：HDR视频除了视频捕获之外，对显示设备的能力有较强的依赖。</p>
<h4 id="pq-hlg">PQ &amp; HLG</h4>
<p>为了正确显示HDR图像，仅仅提高亮度是不够的，以一种与人类视力相匹配的方式显示色彩和色调至关重要。色彩和色调受伽玛<code>输入-输出</code>特性的影响。在HDR中，伽玛曲线有两种，分别是PQ和HLG。</p>
<ul>
<li>PQ伽玛曲线基于人类视觉感知的特征，并且最适合于在互联网上制作电影或串流视频的内容，其中再现准确性是关键。</li>
<li>HLG伽玛曲线旨在允许在现有的SDR电视上显示而不会看不到位置，并且最适合于广播电视和直播视频馈送。</li>
</ul>
<p>PQ和HLG的具体区别如下表所示：</p>
<table>
<thead>
<tr>
<th></th>
<th>PQ (感知量化)</th>
<th>HLG (混合对数伽玛)</th>
</tr>
</thead>
<tbody>
<tr>
<td>目标</td>
<td>互联网视频流，电影</td>
<td>广播电视，直播视频</td>
</tr>
<tr>
<td>优点</td>
<td>处理亮度的绝对值高达 10,000 cd/m²，基于人类视觉感知的新伽玛曲线</td>
<td>将亮度处理为相对值（与现有标准相同）兼容SDR电视</td>
</tr>
<tr>
<td>最大亮度</td>
<td>1,000 cd/m² 绝对值 一致，不管显示装置</td>
<td>相对值，因显示设备而异</td>
</tr>
<tr>
<td>黑色等级</td>
<td>0.005 cd/m2或更低</td>
<td>0.005 cd/m2 或更低</td>
</tr>
<tr>
<td>提议者</td>
<td>Dolby</td>
<td>BBC 和 NHK</td>
</tr>
<tr>
<td>参考标准</td>
<td>SMPTE ST 2084、ITU-R BT.2100</td>
<td>ITU-R BT.2100</td>
</tr>
<tr>
<td>在SDR显示设备上的效果</td>
<td>Poor</td>
<td>良</td>
</tr>
<tr>
<td>直播效果</td>
<td>良</td>
<td>优</td>
</tr>
</tbody>
</table>
<h2 id="hdr标准">HDR标准</h2>
<h4 id="hdr10">HDR10</h4>
<h4 id="dolby-vision">DOLBY VISION</h4>
<h4 id="hdr10">HDR10+</h4>
<h4 id="uhd-premium">UHD Premium</h4>
<h4 id="displayhdr">DisPlayHDR</h4>
<h4 id="mobile-hdr">Mobile HDR</h4>
<h4 id="cuva-hdr">CUVA HDR</h4>
<h4 id="vesa-hdr">VESA HDR</h4>
<h2 id="ffmpeg分析hdr内容">FFMpeg分析HDR内容</h2>
<h4 id="ffprobe分析hdr内容的元数据">ffprobe分析HDR内容的元数据</h4>
<p>可以使用ffprobe命令来提取<code>Mastering Display</code>和<code>Content Light Level</code>的元数据。我们只需要提取第一帧的相关数据即可，因此，在分析时，可以使用<a href="http://ffmpeg.org/ffprobe.html#Main-options" target="_blank" rel="noopener"><code>-read_intervals &quot;%+#1&quot;</code></a>选项，让ffprobe只提取第一帧的元数据。具体分析名利如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffprobe \</span><br><span class="line">-hide_banner \</span><br><span class="line">-loglevel warning \</span><br><span class="line">-select_streams v \</span><br><span class="line">-print_format json \</span><br><span class="line">-show_frames \</span><br><span class="line">-read_intervals "%+#1" \</span><br><span class="line">-show_entries "frame=color_space,color_primaries,color_transfer,side_data_list,pix_fmt" \</span><br><span class="line">HDR.mp4</span><br></pre></td></tr></table></figure>
<p>各选项的含义如下：</p>
<ul>
<li>-hide_banner -loglevel warning：不显示我们不需要的信息</li>
<li>-select_streams v：只选择视频流来分析</li>
<li>-print_format json：以json格式输出分析结果</li>
<li>-read_intervals “%+#1”：只分析第一帧中的数据</li>
<li>-show_entries … ：只输出我们指定的数据</li>
</ul>
<p>命令执行后，会显示如下的分析结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"frames"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"pix_fmt"</span>: <span class="string">"yuv420p10le"</span>,</span><br><span class="line">            <span class="attr">"color_space"</span>: <span class="string">"bt2020nc"</span>,</span><br><span class="line">            <span class="attr">"color_primaries"</span>: <span class="string">"bt2020"</span>,</span><br><span class="line">            <span class="attr">"color_transfer"</span>: <span class="string">"smpte2084"</span>,</span><br><span class="line">            <span class="attr">"side_data_list"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"side_data_type"</span>: <span class="string">"Mastering display metadata"</span>,</span><br><span class="line">                    <span class="attr">"red_x"</span>: <span class="string">"34000/50000"</span>,</span><br><span class="line">                    <span class="attr">"red_y"</span>: <span class="string">"16000/50000"</span>,</span><br><span class="line">                    <span class="attr">"green_x"</span>: <span class="string">"13250/50000"</span>,</span><br><span class="line">                    <span class="attr">"green_y"</span>: <span class="string">"34500/50000"</span>,</span><br><span class="line">                    <span class="attr">"blue_x"</span>: <span class="string">"7500/50000"</span>,</span><br><span class="line">                    <span class="attr">"blue_y"</span>: <span class="string">"3000/50000"</span>,</span><br><span class="line">                    <span class="attr">"white_point_x"</span>: <span class="string">"15635/50000"</span>,</span><br><span class="line">                    <span class="attr">"white_point_y"</span>: <span class="string">"16450/50000"</span>,</span><br><span class="line">                    <span class="attr">"min_luminance"</span>: <span class="string">"40/10000"</span>,</span><br><span class="line">                    <span class="attr">"max_luminance"</span>: <span class="string">"11000000/10000"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上所示，ffprobe分析结果中的颜色值以及最大/小亮度值均为一个比值，颜色值的最终结果会确定母版内容所用的颜色空间，而最大/小亮度值则确定了母版内容的动态范围。</p>
<p>根据如上的结果，我们可以知道，在CIE坐标上，红色，绿色，蓝色以及白点的坐标分别是：</p>
<ul>
<li>red: (0.68, 0.32)</li>
<li>green: (0.265, 0.69)</li>
<li>blue: (0.15, 0.06)</li>
<li>white point: (0.3127, 0.329)</li>
</ul>
<p>从<a href="https://en.wikipedia.org/wiki/DCI-P3" target="_blank" rel="noopener">DCI-P3</a>的相关信息可知，该视频的母版内容在制作的时候采用的是<code>P3-D65 (Display)</code>颜色空间，其最小亮度为0.004尼特，最大亮度为1100尼特，对比度为275000。</p>
<h4 id="ffmpeg转码hdr内容">FFMpeg转码HDR内容</h4>
<p>对于HDR视频的转码时，需要将<code>Mastering Display</code>和<code>Content Light Level</code>元数据的内容传递给编码器（注意，不是传递给FFMpeg），否则，在转码的过程中会丢失这些信息，进而导致转码对画面内容的影响。具体的方式如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg  -i hdr.mp4 \</span><br><span class="line">-map 0 -c:v libx265 \</span><br><span class="line">-x265-params hdr-opt=1:repeat-headers=1:colorprim=bt2020:transfer=smpte2084:colormatrix=bt2020nc:master-display=G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(11000000,40) \</span><br><span class="line">-crf 20 \</span><br><span class="line">-preset veryfast \</span><br><span class="line">-pix_fmt yuv420p10le \</span><br><span class="line">test.mp4</span><br></pre></td></tr></table></figure>
<p>其中，</p>
<ul>
<li>hdr-opt=1: 表示我们要启用HDR</li>
<li>repeat-headers=1: 表示每一帧都需要这些数据</li>
<li>colorprim, transfer and colormatrix: 和ffprobe保持一致</li>
<li>master-display: 根据ffprobe的结果来构造的颜色字符串</li>
</ul>
<h2 id="相关术语">相关术语</h2>
<h4 id="color-calibration-of-screens-屏幕的色彩校正">Color Calibration of Screens（屏幕的色彩校正）</h4>
<p>用于确保屏幕上色彩被准确显示的一个过程。一般使用色度计来测量一块显示屏的原生色彩响应，之后计算一个用于修正的指标以确保颜色能正确地显示在该显示器上，最后对经过修正后的响应进行检测。</p>
<h4 id="color-spaces-色彩空间">Color Spaces（色彩空间）</h4>
<p>一个色彩空间可以指一种颜色的组织方式，也可以指某个特定范围的色彩。在影院和电视的领域，我们一般使用 RGB（用红、绿、蓝原色分量来表示一个颜色）或者 YUV（用一个颜色的明度（黑白值），以及它的基于色彩成分差值所计算的色度值）色彩空间（译者注：RGB 和 YUV 为色彩模型，非色彩空间，此处原文有错误）。这些色彩空间一般基于特定的显示设备特性，参见 D65-P3 词条。其它的色彩空间，比如 XYZ 或者 Lab 更适用于表示人眼色彩视觉模型。</p>
<h4 id="contrast-ratio-对比度">Contrast Ratio（对比度）</h4>
<p>对比度是一个系统所能产生的最亮（白）部分和最暗（黑）部分之间的明度比值，通常用一个 n:1 的比值描述。</p>
<h4 id="cri-color-remapping-information-色彩重映射信息">CRI Color Remapping Information（色彩重映射信息）</h4>
<p>一套通过分析相同内容的两份不同母版（如 HDR 和 SDR 母版）所产生的标准元数据。当一份母版（如 HDR）和 CRI 元数据被一同传输时，解码器在面对 HDR 屏幕时可以仅解码 HDR 内容，而在面对 SDR 屏幕时也可以通过利用 CRI 元数据的方式将 HDR 内容变换成 SDR 内容。采用这一方案的主要优势在于对于两个解码后的版本，作者的创作意图得以保留。CRI 是 MPEG（HEVC v2）的标准成分之一，并且对于 Ultra HD Blu-ray 制作是可选功能。</p>
<h4 id="dci-p3-d65-p3-st-428-1">DCI-P3，D65-P3，ST 428-1</h4>
<p>一个数字电影色彩空间。DCI-P3 色彩空间是一个 2005 年由数字影院联盟（Digital Cinema Initiatives）引入的 RGB 色彩空间，并由 SMPTE ST428-1 于 2006 年标准化。</p>
<p>这一色彩空间拥有远比 sRGB（参见 Rec.709）宽广得多的色域。</p>
<p>所有的数字电影放映机都能完整显示 DCI-P3 色彩空间，D65 P3 指的是其白点的色温由 DCI 白点改为 D65 白点。</p>
<p>图中的三个三角形展现了：最大的是 Rec.2020 标准，Ultra HD TV 的新标准（目前只有激光显示能完整实现），略小的、用于数字电影的 DCI-P3，以及传统视频监视器、高清广播电视、蓝光、OTT 所采用的最小的 Rec.709 色彩空间。</p>
<h4 id="edid-扩展显示标识数据">EDID 扩展显示标识数据</h4>
<p>EDID 是扩展显示标识数据（Extended Display Information Data）的缩写，这个标准由 Consumer Technology Association（CTA）制定。这是由每个 DVI 显示器、HDMI 显示器，或其它支持 DVI HDMI 输入的设备（aka DVI/HDMI Sinks）所提供的。可能每个 DVI/HDMI 输入都有自己的 EDID。EDID 会告诉设备它所连接的显示器的性能特征。</p>
<p>源设备确认显示器的 DVI 或者 HDMI 接口是否存在 EDID 存储器（EDID memory）并使用其中的信息优化输出的视频（分辨率、帧率、色彩……）和/或音频格式。所有支持 DVI/HDMI 标准输入的设备，即 TMDS 接收端（DVI/HDMI Sinks）必须实现 EDID。</p>
<h4 id="eotf-电光转换函数">EOTF 电光转换函数</h4>
<p>EOTF 是 Electro-Optical Transfer Function 的缩写。他是一个映射码值到显示亮度的数学函数。换言之，一个 ETOF 定义了图像中的码值如何被显示器或者投影仪显示为可见光。</p>
<p>参见 OETF 光电转换函数，ST2084。</p>
<h4 id="oetf-光电转换函数">OETF 光电转换函数</h4>
<p>OETF 是 Opto-Electronic Transfer Function 的缩写。它是一个映射场景明度（某个场景的光）与可传输压缩的数字编码值之间的数学函数映射关系。这个术语一般用于获取图像的设备，比如数字相机。</p>
<p>在后期制作中，内容一般在某个拥有特定 EOTF 的屏幕上进行调色，历史上，常用一个OETF 的逆函数作为屏幕的 EOTF。</p>
<h4 id="ootf-光光转换函数">OOTF 光光转换函数</h4>
<p>OOTF 是 Optical-to-Optical Transfer Function 的缩写。它是一个把相机所拍摄的场景亮度映射到显示器亮度的数学函数。</p>
<h4 id="flicker-闪烁">Flicker 闪烁</h4>
<p>部分特定种类的显示器的特征，比如老的阴极射线管显示器（CRT），或者调教得很糟糕的平板显示器，甚至电影（motion picture film）放映机这一不受欢迎的亮度改变主要在频率低于 50 帧每秒时可见。对于亮度更高的显示器来说，人眼能感受到更高频率的闪烁。</p>
<h4 id="f-stop-of-dynamic-range-动态范围的-f-制光圈档数">f-stop of Dynamic Range 动态范围的 f 制光圈档数</h4>
<p>在摄影中，一档 f 制光圈的改变对应双倍（或减半）捕获图像时所捕捉的光。</p>
<p>一张图片中所包含的 f 制光圈数量描述了这张图片的对比度（2^N 标记）比如一台相机可以输出 10 档的图像，这意味着对比度可以高达 2^10（1024：1），即白色部分会比黑色部分亮 1024 倍。相比之下，人眼可以达到 18-20 档（这是一个很高的动态范围 HDR，一般的 SDR 视频图像是 6-7 档）</p>
<h4 id="gamut-or-color-gamut-色域">Gamut or Color Gamut 色域</h4>
<p>在包括但不限于计算机图形和摄影领域的色彩还原过程中，色域是某个特定的色彩的子集。</p>
<p>色域一词最常见的用途是指某个范围内可以被准确反应的色彩子集，这个前提可能是某个特定的显示设备或某个给定的色彩空间。色域一般使用 CIE 1931 色度图上的面积来表示，CIE 1931 曲线的边缘代表可见光光谱颜色的范围。</p>
<h4 id="gamut-mapping-色域映射">Gamut Mapping 色域映射</h4>
<p>在几乎所有的转译过程（指的是对于某个特定颜色的表示，在不同色彩空间中的转换过程）中，我们必须面对不同设备的色域所覆盖的范围是有所不同的现实，这使得准确还原色彩是不可能的。</p>
<p>因此，对于靠近色域边缘的部分是有必要进行一些处理的。有些颜色必须被移入色域中，不然它们在输出设备上无法被显示，它们会被粗暴地舍弃（clipped）掉。这就是所谓的色域不匹配，比如说当我们将更广的 RGB 色彩空间转换到 CMYK 色彩空间的时候就会出现。</p>
<p>色彩管理系统可以使用多种方法来实现所需的结果并且给予有经验的用户控制色域映射的的方式。</p>
<h4 id="imf-可交互母版文件">IMF 可交互母版文件</h4>
<p>Interoperable Master Format（IMF）是一个由 SMPTE 提供的标准，用于实现一个单文件的、可交换使用的母版文件格式和结构，用于全球范围内的商业内容分发。它是由 Digital Cinema Package（DCP）架构进化而来的，DCP 为分发渠道提供了一个完整的文件可交换单元。IMF 可以说是一个革命性的进步，IMF 提供了一个真正的基于文件的最终母版。DCP 针对的是影院内容分发，而 IMF 为商用环境提供了一个可以基于同一内容为不同的观众创建多种剪辑版本的母版格式。</p>
<h4 id="inverse-tone-mapping-itm-逆影调映射-反向影调映射">Inverse Tone Mapping (ITM) 逆影调映射/反向影调映射</h4>
<p>对于 SDR 内容的母版重制从而实现 HDR 内容。</p>
<p>ITM 使用 SDR 内容并且扩展其明度和色彩空间，使其匹配 HDR 显示器的能力，并且保留原本内容创作者的意图。</p>
<h4 id="lut-查找表">LUT 查找表</h4>
<p>是 Look Up Table 的缩写。LUT 提供了一种对输入的数据施加复杂数学运算的高效方式———如果不使用 LUT 则会耗费许多的计算资源。因此，它们是一种将图像从一个色彩空间映射到零一个色彩空间的理想实现方法。</p>
<p>存在以下的 LUTs：</p>
<p>3D LUTs，每个像素的输出 R’、G’、B’ 值是由输入像素的 R、G、B 值共同计算的。</p>
<p>1D LUTs，输出的 R’ 只由输入的 R 值计算，G’、B’ 同理。它们一般被用于 gamma 函数和其它 EOTF 的施加矫正，一般在消费级电子设备的芯片组中出现。</p>
<p>3D LUT 相较于 1D LUT 而言，它支持更加强大的数学转换，但在芯片组里部署起来更复杂且更昂贵。一般 3D LUT 被用于在后期制作过程中施加创造性的“风格”以及色彩空间的转换。</p>
<h4 id="maxcll-metadata-maxcll-元数据">MaxCLL Metadata MaxCLL 元数据</h4>
<p>Maximum Content Light Level（MaxCLL）是一个整数类型的元数据值，用于定义某个编码的 HDR 视频流或者文件中，任意一个像素的最高亮度，单位是 nits。MaxCLL 可以在母版制作过程中或者制作过程后来测量，但是为了保证 HDR 显示器在 MaxCLL HDR 范围里的色彩过渡，并且在显示器的最大亮度外施加一个硬 clip，显示器的 MaxCLL 也可以被用作 MaxCLL 元数据。</p>
<h4 id="maxfall-metadata-maxfall-元数据">MaxFALL Metadata MaxFALL 元数据</h4>
<p>Maximum Frame Average Light Level（MaxFALL）是一个整数类型的元数据值，用于定义某个编码的 HDR 视频流或者文件中，任意一帧画面的最高的平均亮度，单位是 nits。MaxFALL 是通过计算每一帧画面解码后的所有像素的亮度的平均值来获取的。</p>
<h4 id="peak-code-value-峰值编码值">Peak Code Value 峰值编码值</h4>
<p>Peak Code Value 指的是通过某一个系统组件而不产生硬剪（clip）的最大数字编码值。</p>
<h4 id="peak-display-luminance-峰值显示亮度">Peak Display Luminance 峰值显示亮度</h4>
<p>一个显示器所能产生的最高亮度。</p>
<h4 id="perceptual-quantizer-感官量化曲线">Perceptual Quantizer 感官量化曲线</h4>
<p>Perceptual Quantizer 的缩写，它是一个 EOTF。</p>
<p>MovieLabs 提出了一条基于 Barton Curve，并可被用于高动态范围（HDR）的数学曲线，于 2014 年由 SMPTE 制定了 ST2084 标准。</p>
<p>Perceptual Quantization 是一个高效率的编码 HDR 明度信息的方式。在整个动态范围中，每一对相邻的编码值区别都比可感知的区别略小，使得码值利用率极高。</p>
<p>但是，这一 EOTF 并不兼容传统显示器（legacy display），PQ 编码的信号只能在新的、支持 HDR 的设备上被解码。</p>
<p>PQ 为 10bit 或者 12bit 内容所设计，且根据 SMPTE ST2084 标准，不推荐在实时广播时使用它。</p>
<h4 id="quantum-dot-qd-displays-量子点显示器">Quantum Dot（QD）Displays 量子点显示器</h4>
<p>量子点显示器使用了纳米尺度（2nm-10nm）的晶体“点”。每一个点会发出一个不同的纯色，而它们所发出的颜色取决于它的尺寸。</p>
<p>在 LCD 背光前加入一张带有量子点的薄膜（film），图像的色彩还原和总体的亮度可以被显著提高。</p>
<p>这些微小的纳米晶体可以在背光到达红、绿、蓝子像素前改变背光的光谱，实现高达 20-30% 的色域提升，使得显示设备的色彩可以更接近 Rec.2020 目标色域。</p>
<h4 id="st2084">ST2084</h4>
<p>SMPTE 标准中定义的用于制作 HDR 内容母版所用的 EOTF。该 EOTF 又被称为 PQ，主要用于制作非广播内容的母版。</p>
<h4 id="st2086">ST2086</h4>
<p>SMPTE 标准中定义的用于描述制作视频母版所使用的显示器的绝对色彩空间的元数据（基色坐标、白点、亮度范围）。</p>
<h4 id="tone-mapping-tone-mapping-operator-tmo-色调映射-色调映射运算符">Tone Mapping/Tone Mapping Operator（TMO） 色调映射/色调映射运算符</h4>
<p>色调映射是一种用于图像处理和计算机图形的技术，它被用于将一组颜色映射到另一组颜色，从而在具有更有限动态范围的介质中实现逼近高动态范围（HDR）图像的观感。 打印输出，CRT或标准动态范围（SDR）监视器和投影仪都具有较低的动态范围，不足以再现HDR图像中存在的全部光强。色调映射解决了从记录范围到可显示范围的对比度剧烈降低的问题，同时保留了图像细节和色彩表现，这对于欣赏原始场景内容和保留创作意图是重要的。一般使用色调映射运算符（Tone Mapping Operator）执行该色调映射过程，通常为“S”形曲线以实现高光和阴影细节的柔和过渡。参见 Inverse Tone Mapping（ITM）。</p>
<h4 id="wide-color-gamut-wcg-广色域">Wide Color Gamut（WCG） 广色域</h4>
<p>Wide Color Gamut 的缩写，意为广色域。广色域包括了比 Recommendation ITU-R BT.709 更饱和的色彩，比如说被 Rec.2020 所定义的色彩空间就属于广色域。</p>
<h4 id="white-point-白点">White Point 白点</h4>
<p>白点（通常在技术文档中被称为参考白 reference white 或目标白 target white）是一组用于定义图像采集，编码或再现中的“白色”颜色的色度坐标。根据应用，需要不同的“白色”定义以提供可接受的结果。例如，在室内拍摄的照片可能用白炽灯照明，白炽灯比日光相对偏橙。 因此，大多数专业相机拥有在白炽灯照明与日光下拍摄所用的不同设置。同样，为 D65 白点显示器所生产的图像在具有不同白点的显示器上将无法被正确显示。</p>
<p>CIE 定义 D65 常被用来定义视频显示器的白点。</p>
<p>D55 曾是胶片投影的标准白点，DCI 白点（译者注：接近 D63，但更绿）和 D60 白点这两个白点均被数字电影广泛使用。</p>
<blockquote>
<p>更多术语可以参考：<a href="/shares/hdr-field-guide-final-web.pdf"><strong>Quick Reference HDR Glossary</strong></a></p>
</blockquote>
<h2 id="参考资料">参考资料</h2>
<p>1: <a href="https://www.cnet.com/news/hdr-for-cameras-vs-hdr-for-tvs-whats-the-difference/" target="_blank" rel="noopener">https://www.cnet.com/news/hdr-for-cameras-vs-hdr-for-tvs-whats-the-difference/</a><br>
2: <a href="https://en.wikipedia.org/wiki/High-dynamic-range_imaging" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/High-dynamic-range_imaging</a><br>
3: <a href="https://en.wikipedia.org/wiki/High-dynamic-range_video" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/High-dynamic-range_video</a><br>
4: <a href="https://www.zhihu.com/question/19774840/answer/998271233" target="_blank" rel="noopener">https://www.zhihu.com/question/19774840/answer/998271233</a><br>
5: <a href="https://alliance.experienceuhd.com/uhd-premium-features" target="_blank" rel="noopener">https://alliance.experienceuhd.com/uhd-premium-features</a><br>
6: <a href="https://www.experienceuhd.com/uhd-mobile-hdr-premium-features" target="_blank" rel="noopener">https://www.experienceuhd.com/uhd-mobile-hdr-premium-features</a><br>
7: <a href="http://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=AB4FAB66987D97573EA90F4DD56ABA36" target="_blank" rel="noopener">http://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=AB4FAB66987D97573EA90F4DD56ABA36</a><br>
8: <a href="http://www.cuva.org.cn/ueditor/php/upload/file/20200904/1599186578364054.pdf" target="_blank" rel="noopener">http://www.cuva.org.cn/ueditor/php/upload/file/20200904/1599186578364054.pdf</a></p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>HDR</tag>
      </tags>
  </entry>
  <entry>
    <title>FFMpeg解码API以及在解码过程中存在的丢帧问题</title>
    <url>/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/</url>
    <content><![CDATA[<p><img src="/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/1.png" alt></p>
<h2 id="背景">背景</h2>
<p>在优化视频客观全参考算法（主要是<em>PSNR</em>, <em>SSIM</em>, <em>MS-SSIM</em>）时，我们首先利用FFMpeg提供的API（<em><code>avcodec_send_packet()</code></em>，<em><code>avcodec_receive_frame()</code></em>）对输入的两个MP4文件转成对应的YUV格式的数据文件，然后再基于这两份YUV数据文件进行计算，得到对应的结果。</p>
<p>但是，我们发现，MP4文件转成YUV数据后，总是会发生<strong>丢失视频最后几帧</strong>的现象。</p>
<p>为了弄清楚这个问题，查阅了FFMpeg的源码，并参考了网络上的资料，然后总结出了这篇文章。</p>
<a id="more"></a>
<h2 id="ffmpeg的编解码api">FFMpeg的编解码API</h2>
<p>从<a href="https://github.com/FFmpeg/FFmpeg/commit/7fc329e2dd6226dfecaa4a1d7adf353bf2773726" target="_blank" rel="noopener">3.1版本</a>开始，FFMpeg提供了<a href="https://github.com/FFmpeg/FFmpeg/blob/release/3.1/libavcodec/avcodec.h" target="_blank" rel="noopener">新的编解码API</a>来对音视频数据进行编解码操作，从而实现对输入和输出的解耦：</p>
<ul>
<li>解码API
<ul>
<li>avcodec_send_packet()</li>
<li>avcodec_receive_frame()</li>
</ul>
</li>
<li>编码API
<ul>
<li>avcodec_send_frame()</li>
<li>avcodec_receive_packet()</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @ingroup libavc</span></span><br><span class="line"><span class="comment"> * @defgroup lavc_encdec send/receive encoding and decoding API overview</span></span><br><span class="line"><span class="comment"> * @&#123;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The avcodec_send_packet()/avcodec_receive_frame()/avcodec_send_frame()/</span></span><br><span class="line"><span class="comment"> * avcodec_receive_packet() functions provide an encode/decode API, which</span></span><br><span class="line"><span class="comment"> * decouples input and output.</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>同时，也正是从3.1版本开始，之前的编解码API也被标注为<code>deprecated</code>：</p>
<ul>
<li>解码API
<ul>
<li>avcodec_decode_video2()</li>
<li>avcodec_decode_audio4():</li>
</ul>
</li>
<li>编码API
<ul>
<li>avcodec_encode_video2()</li>
<li>avcodec_encode_audio2()</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">attribute_deprecated</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avcodec_decode_audio4</span><span class="params">(AVCodecContext *avctx, AVFrame *frame,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> *got_frame_ptr, <span class="keyword">const</span> AVPacket *avpkt)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在我们的工具中，我们采用了新的解码API：<code>avcodec_send_packet()</code>和<code>avcodec_receive_frame()</code>，实现视频帧的解码，并将解码后的数据转成YUV数据。具体的代码片段如下，<a href="https://wangwei1237.gitee.io/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/test_video_parser_1.cpp" target="_blank" rel="noopener">点击可查看完整测试代码</a>。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">process_frame</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//decode operation.</span></span><br><span class="line"><span class="keyword">while</span> (!av_read_frame(fmt_ctx, pkt)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pkt-&gt;stream_index != video_stream_idx) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> packet_new = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (process_frame(fmt_ctx, dec_ctx, video_stream-&gt;codecpar, </span><br><span class="line">                         frame, pkt, &amp;packet_new) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;;</span><br><span class="line">    av_packet_unref(pkt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码可以看出，<code>i</code>是解码帧的总数，但是我们运行之后发现，一个252帧的视频，最终只得到了248帧。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> g++ --std=c++11 test_video_parser_1.cpp $(pkg-config --cflags --libs libavcodec libavdevice libavformat libavutil)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> frame count: 248</span></span><br></pre></td></tr></table></figure>
<h2 id="send-packet-receive-frame">send_packet &amp; receive_frame</h2>
<p>为了加深对解码API的了解，以便能查出问题原因，我们查阅了<a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/avcodec.h" target="_blank" rel="noopener">FFMpeg的代码</a>，从代码的注释中，我们发现了问题：<strong>我们没有遵循API的使用规范，同时FFMpeg在注释中也说明了为什么会出现我们遇到的问题</strong>。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * ... </span></span><br><span class="line"><span class="comment">  * At the beginning of decoding or encoding, the codec might accept multiple</span></span><br><span class="line"><span class="comment">  * input frames/packets without returning a frame, until its internal buffers</span></span><br><span class="line"><span class="comment">  * are filled. This situation is handled transparently if you follow the steps</span></span><br><span class="line"><span class="comment">  * outlined above.</span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * End of stream situations. These require "flushing" (aka draining) the codec,</span></span><br><span class="line"><span class="comment">  * as the codec might buffer multiple frames or packets internally for</span></span><br><span class="line"><span class="comment">  * performance or out of necessity (consider B-frames).</span></span><br><span class="line"><span class="comment">  * ...</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>
<p>也就是说，为了提升性能或出于其他的考虑，解码器会在内部缓存多个<code>frames</code>/<code>packets</code>。因此，当流结束的时候，需要对解码器执行<code>flushing</code>操作，以便获取解码器缓存的<code>frames</code>/<code>packets</code>。</p>
<p>我们的工具中，在流结束之后，并没有执行<code>flushing</code>操作，因此就出现了解码过程丢帧的现象。按照FFMpeg的指导，我们补充了如下的逻辑，以便获取解码器中缓存的帧，<a href="https://wangwei1237.gitee.io/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/test_video_parser_2.cpp" target="_blank" rel="noopener">点击可查看完整测试代码</a>。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Flush remaining frames that are cached in the decoder</span></span><br><span class="line"><span class="keyword">int</span> packet_new = <span class="number">1</span>;</span><br><span class="line">av_init_packet(pkt);</span><br><span class="line">pkt-&gt;data = <span class="literal">NULL</span>;</span><br><span class="line">pkt-&gt;<span class="built_in">size</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (process_frame(fmt_ctx, dec_ctx, video_stream-&gt;codecpar, </span><br><span class="line">                     frame, pkt, &amp;packet_new) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    i++;</span><br><span class="line">    packet_new = <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>再次运行，我们发现，丢帧问题消失了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> g++ --std=c++11 test_video_parser_1.cpp $(pkg-config --cflags --libs libavcodec libavdevice libavformat libavutil)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> frame count: 252</span></span><br></pre></td></tr></table></figure>
<h2 id="ffmpeg解码api状态机">FFMPeg解码API状态机</h2>
<h3 id="avcodec-send-packet返回值">avcodec_send_packet返回值</h3>
<p>从FFMpeg的源码中，我们会发现，正常情况下，<code>avcodec_send_packet()</code>函数的返回值主要有以下三种：</p>
<ul>
<li><code>0</code>: on success.</li>
<li><code>EAGAIN</code>: input is not accepted in the current state - user must read output with avcodec_receive_frame() (once all output is read, the packet should be resent, and the call will not fail with EAGAIN).</li>
<li><code>EOF</code>: the decoder has been flushed, and no new packets can be sent to it (also returned if more than 1 flush packet is sent).</li>
</ul>
<h3 id="avcodec-receive-frame返回值">avcodec_receive_frame返回值</h3>
<p>同样的，正常情况下，<code>avcodec_receive_frame()</code>函数的返回值主要有以下三种：</p>
<ul>
<li><code>0</code>: success, a frame was returned.</li>
<li><code>EAGAIN</code>: output is not available in this state - user must try to send new input.</li>
<li><code>EOF</code>: the decoder has been fully flushed, and there will be no more output frames.</li>
</ul>
<h3 id="解码api状态机">解码API状态机</h3>
<p><code>avcodec_send_packet()</code>和<code>avcodec_receive_frame()</code>不同的返回值代表了解码器的不同的状态。</p>
<p>对API的调用实际上是一种动作，而API的返回值则用来标志当前解码器的状态。因此，解码API的整个过程实际上就是一个状态机。</p>
<p>根据<a href="#avcodec_send_packet%E8%BF%94%E5%9B%9E%E5%80%BC">avcodec_send_packet返回值</a>和<a href="#avcodec_receive_frame%E8%BF%94%E5%9B%9E%E5%80%BC">avcodec_receive_frame返回值</a>中的介绍，可以得到正常情况下，解码过程的状态机，如下图所示。</p>
<p><img src="/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/2.png" alt></p>
<p>在图中，<code>节点</code>代表状态（API的返回值），<code>箭头</code>代表API的调用。蓝色表示和<code>avcodec_send_packet()</code>相关，红色表示和<code>avcodec_receive_frame()</code>相关。</p>
<p><a href="https://wangwei1237.gitee.io/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/test_video_parser_2.cpp" target="_blank" rel="noopener">我们修复版本的解码实现</a>实际上就是对如上图所示的状态机的实现。</p>
<p>而如果在实现的时候，没有处理如下图所示的状态，则会导致无法获取视频最后几帧的问题。</p>
<p><img src="/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/3.png" alt></p>
<h2 id="思考">思考</h2>
<ul>
<li>源码面前，了无秘密。侯捷老师说过“源码面前，了无秘密”。工作中发现，源码确实是我们获取知识和经验的一个非常有效的途径，尤其是那些好的开源项目的源码，更是如此。</li>
<li>源码还是我们解决问题的强有力的手段之一。对于这些优秀的开源项目的源码而言，代码只是一个部分，源码中的注释、文档等会为我们提供足够的资源。这次问题的解决就是依赖源码，之前在Android摄像头Mock技术的研究中，也是在查阅Android相关源码后才有了思路。因此，当我们在工作中遇到问题的时候，第一手的资料还是源码（当然，要有源码才行），其次才是官方文档，最后才是网络上的其他资源。</li>
<li>看了那么多的源码才发现：优秀的项目是那么的一致，而糟糕的项目，各有各的糟糕之处。</li>
</ul>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFMpeg</tag>
        <tag>视频解码</tag>
        <tag>解码丢帧</tag>
        <tag>avcodec_send_packet</tag>
        <tag>avcodec_receive_frame</tag>
      </tags>
  </entry>
  <entry>
    <title>信任，但也要核查</title>
    <url>/2021/01/11/Trust-but-Verify/</url>
    <content><![CDATA[<p><img src="/2021/01/11/Trust-but-Verify/1.jpg" alt></p>
<blockquote>
<p>1987年，在美苏中程核武器协议谈判时，美国总统里根旁敲侧击，对戈尔巴乔夫说：“我非常喜欢一句俄国谚语——<strong><code>Trust, but verify</code></strong>”。</p>
<p>意思就是，里根相信苏联领导人的承诺，但还必须有个有效的验证机制。</p>
<p><a href="https://en.wikipedia.org/wiki/Trust,_but_verify" target="_blank" rel="noopener"><div align="right">关于该谚语的详细信息，可以参考维基百科</div></a></p>
</blockquote>
<a id="more"></a>
<p>随着自己的成长，随着工作内容从完成上级安排的工作到自己开始规划并安排某些工作，随着工作范围从团队内部到跨团队的协作，自己对<code>Trust, but verify</code>这种思想的感触越来越深。</p>
<p>尤其是在做大团队横向工作的规划和推动，以及组建视频小组来探索视频相关的技术，更加深了对<code>Trust, but verify</code>的理解。</p>
<p><code>信任</code>给予我们工作的自由，而<code>核查</code>会给这份自由增加一定的限制。绝对的信任会导致信任的终结，不加限制的信任最终可能会影响团队的可持续发展。信马由缰者，终不能达到目标。</p>
<p><code>核查</code>机制下的<code>信任</code>，才能在给予工作自由的同时，获得个人和公司的利益最大化。</p>
<h2 id="网飞文化中的自由与责任">网飞文化中的自由与责任</h2>
<p>作为一家传奇的公司，成立于1997年的网飞，在成功应对了娱乐领域和商业领域的四次大规模转型之后，其股价已经从1$一路攀升至500$，如今，其市值已经超过了2000亿美元。</p>
<p><img src="/2021/01/11/Trust-but-Verify/3.jpg" alt></p>
<p>根据招聘网站<a href="https://hired.com/" target="_blank" rel="noopener">Hired</a>的<a href="https://hired.com/blog/highlights/2020-brand-health-report/" target="_blank" rel="noopener">第4次《全球品牌健康报告》</a>，Netflix已经取代Google，成为人们最想去工作的顶级科技公司。</p>
<p><img src="/2021/01/11/Trust-but-Verify/2.png" alt></p>
<p>网飞的成功，离不开其企业文化。在《自由与责任——网飞文化手册》的<em>网飞文化的七个方面</em>中，就提到了<strong>自由与责任</strong>这一文化。在手册中，也提到：自由不是绝对的，和言论自由一样，工作自由也是有限度的。</p>
<p>在网飞创始人里德·哈斯廷斯的《不拘一格——网飞的自由与责任工作法》一书的第三章中，也列举了2个例子来介绍其自由与责任的文化：</p>
<ul>
<li>取消限期休假制度</li>
<li>取消差旅和经费审批</li>
</ul>
<p>网飞没有对关于花销、娱乐、馈赠、出差、以及休假给出具体的规则和制度，而是给予员工极大的自由来自主安排，但是这种自由的前提是：公司利益至上。</p>
<p>而公司利益至上，则意味着：</p>
<ul>
<li>花该花的钱，否则就别花，而且这些钱应该是为了工作而花</li>
<li>透漏重要供应商馈赠的礼物</li>
<li>利用公司的资源，必须是为了提高工作效率，且必须合理</li>
<li>……</li>
</ul>
<p>同时，对于公司给予员工的这份自由，网飞还有一套时候核实的制度来确保，员工的自由满足了公司利益至上的原则。这种制度在网飞内部称为：<strong>事情情景设定，时候核实报销</strong>。</p>
<h2 id="自由与责任-信任与核查">自由与责任&amp;信任与核查</h2>
<p>当最开始没有流程和制度的时候，我们可以根据遇到的具体的问题制定相关的流程和制度，这个时候，流程和制度会是有效的。但问题是，随着时间的不断发展，随着问题的不断增加，起初的那个流程制度就被补充的会越来越多。这个时候，每个人都需要对流程和制度进行学习，然后按照这个复杂的制度来行事，在互联网公司中，这简直是一件不可想象的事情。如果员工在遇到问题的时候，还需要通过查阅流程制度文档来指引自己的行动，那文化的意义也就荡然无存了。</p>
<p>我总是遇到很多的流程制度，比如申请某个一般的权限需要总监来审批，在某个时间点上线需要总监审批确认，……这些制度真的能解决问题吗？无非是用这些门槛来限制某些事情的发生而已。但是，当紧急事情真的出现的时候，这些制度反而成为了阻碍效率最大的问题。这些往往被称作为“大公司”通病。根本原因就是随着公司的发展，工作的核心动力不再是初心，不再是思考“这是否对公司是有利的”，而是复杂的制度和流程。</p>
<p>在《不拘一格》中也提到：</p>
<blockquote>
<p>随着一个快速灵活的初创企业发展为成熟的企业，公司往往会建立一套完整的体系对员工的支出进行监管。</p>
<p>这让管理有了一种控制感，但往往也会拖慢公司业务的进程。</p>
<p>而网飞的<strong>事情情景设定，时候核实报销</strong>制度在保证员工不会虚假报销的情况下，给予员工极大的自由，来使的他们可以再关键时刻作出有利于公司的决断。</p>
</blockquote>
<p>实际上，<strong>事前情景设定，事后核实报销</strong>正是一种Trust, but verify制度。</p>
<p>我们要相信员工能秉承公司利益至上的原则，但是我们也需要对其行为进行核查。单纯的相信是不行的。</p>
<p>在《不拘一格》中提到：</p>
<blockquote>
<p>据一项研究显示：被调查者一旦确认自己的行为不会为人所知，远超半数的人会利用漏洞，为自己谋取更多利益。</p>
</blockquote>
<p>所以，作为项目的负责人或者管理者，需要做好核查的工作：</p>
<ul>
<li>确保员工形成公司利益至上的理念</li>
<li>确保员工是在按照预期完成工作</li>
<li>确保及时发现问题，并给予及时的鼓励、指导、资源支持</li>
<li>确保形成即重视结果，也重视过程的文化，只有过程，没有结果，是不行的，只有结果，没有过程，同样也是不行的</li>
</ul>
<p><img src="/2021/01/11/Trust-but-Verify/4.jpg" alt></p>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>不拘一格</tag>
        <tag>自由与责任</tag>
      </tags>
  </entry>
  <entry>
    <title>一场关于FLV是否要支持HEVC的争论</title>
    <url>/2020/10/29/a-debate-about-supporting-HEVC-over-FLV/</url>
    <content><![CDATA[<blockquote>
<p>前几天，在浏览FFMpeg的Trac时，发现了一个希望<a href="https://trac.ffmpeg.org/ticket/6389" target="_blank" rel="noopener"><strong>FFMpeg增加<em>让FLV支持HEVC编码</em></strong></a>的需求。</p>
<p>这个需求是2017年提交到FFMpeg社区的，从整个交流过程可以看出，需求提出者和FFMpeg的社区维护者对这个需求的分歧较大，从中也能看出一些工作思路和工作文化上的差异。看完整个讨论过程，感触还是比较深的，所以想写一篇文章来记录一下自己的感触。</p>
</blockquote>
<p><img src="/2020/10/29/a-debate-about-supporting-HEVC-over-FLV/1.png" alt></p>
<a id="more"></a>
<h2 id="整个需求讨论的大概过程">整个需求讨论的大概过程</h2>
<ul>
<li><strong>提议发起</strong>：目前HLS和TS都已经支持H265了，但是国内大部分CDN更多采用的是RTMP/HTTP-FLV格式。并且，因为HLS的延迟比较高，因此国内大部分直播业务采用的都是RTMP/HTTP-FLV格式。所以，该ISSUE的发起者就想问一下FFMpeg社区是否有计划让FLV支持HEVC。</li>
<li><strong>FFMpeg社区回复</strong>：不得不说，社区的回复还是很快的。在需求提出20分钟后，有人回复了。大概意思就是：并不是不能让FLV支持HEVC，只是因为Adobe没有对FLV支持HEVC做出具体说明。因此，如果Adobe不扩展标准，FFMpeg是不会让FLV支持HEVC的。同时，社区还提出了一些备选的解决方法。</li>
<li><strong>针对延迟的争论</strong>：接下来就是双方针对直播流延迟的争论了。一方认为可以对HLS或MPEG-DASH做一些优化来降低延迟，一方认为HLS不可能达到1-3秒的延迟，基本上接下来的讨论就是在讨论延迟了。因为RTMP/HTTP-FLV的低延迟已经国内CDN厂商的完美支持，因此，还是希望FFMpeg能让FLV支持HEVC。并且，有好多评论也在支持这个需求。确实，在2017年，尤其是在国内，对于直播业务而言，能让FLV支持H265真的是一件非常值得激动的事。</li>
<li><strong>社区强烈反对</strong>：在众多支持该需求的评论之后，FFMpeg直接关闭了这个提议，并且将该提议置为了<code>invalid</code>状态。
<ul>
<li>这些是马甲账号的灌水评论，这些评论对于FFMpeg是否实现该提议没有任何作用。</li>
<li>只要Adobe不升级FLV的标准，FFMpeg就不会让FLV支持HEVC。</li>
<li>不管怎么样，FFMpeg都不会支持这种定制的需求。</li>
</ul>
</li>
</ul>
<p>因此，一直到现在，3年过去了，FFMpeg也没有实现在FLV中支持HEVC的特性。因此，直到如今，在直播业务中，也都无法使用社区版本的FFMpeg实现：在FLV格式中传输H265的直播流。</p>
<p>所幸的<a href="https://github.com/ksvc/FFmpeg/tree/release/3.4" target="_blank" rel="noopener"><strong>金山云实现了FFMpeg的<em>hack</em>版本</strong></a>，从而让RTMP/HTTP-FLV协议支持了HEVC编码。因此，即使标准的解码器（播放器）无法播放金山云的<em>hack</em>版本生成的RTMP/HTTP-FLV的H265直播流，但是，金山云实现的这个私有的协议也基本上成为了国内直播相关业务的标准协议了。</p>
<h2 id="协议-标准先行-还是实现先行？">协议/标准先行，还是实现先行？</h2>
<blockquote>
<p>11:6 耶和华说，看哪，他们成为一样的人民，都是一样的言语，如今既作起这事来，以后他们所要作的事就没有不成就的了。</p>
<p>11:7 我们下去，在那里变乱他们的口音，使他们的言语彼此不通。</p>
<p>11:8 于是，耶和华使他们从那里分散在全地上。他们就停工，不造那城了。</p>
<p>11:9 因为耶和华在那里变乱天下人的言语，使众人分散在全地上，所以那城名叫巴别（就是变乱的意思）。</p>
<div align="right">——《圣经·创世纪》</div>
</blockquote>
<p>如今，生产社会化程度越来越高，技术要求越来越复杂，生产协作越来越广泛。许多技术和产品，往往涉及几十个、几百个甚至上万个企业，这客观上要求：必须在技术上使生产活动保持高度的统一和协调。此时，必须通过制定和执行技术标准使各生产部门和企业内部各生产环节有机地联系起来，保证生产有条不紊地进行。没有标准、协议，就无法有效的实现社会化大生产。</p>
<p>纵观整个计算机行业，无论哪个领域，无论是网络通信还是编解码协议，都是协议先行。私有协议的推广，也是先从标准化开始，然后才推动具体实现。否则，行业内就无法达成共识，否则，整个网络的互联、互通也就无从谈起。因此，必须是标准、协议先行。</p>
<p>另一个方面，标准、协议是具体实现的抽象，没有接口的定义，哪里来的接口的实现呢？当然，也可以从具体的实现中抽取接口，但是我们必须意识到，在接口抽取之前，这个实现相当于是私有的。</p>
<p>因此，FFMpeg社区拒绝让FLV自持HEVC是合理的。否则，我们的工作就会充斥着各种FFMpeg的<em>hack</em>版本，并且每个<em>hack</em>版本都是用来解决不同的问题。这真是一件非常恐怖的事情。</p>
<p>兵马未动，粮草先行。如果真的想让事情变的更便捷，最好的方式就是优先推动标准或协议的升级。</p>
<p>我见到过很多次较为严重的线上问题，其根本原因就是上下游之间没有一个定义良好的协议，导致升级过程出现了<a href="/monolith-to-microservices/docs/Breaking_Changes.html">破坏性修改</a>，进而导致问题的发生。</p>
<h2 id="组织文化优先还是用户需求优先？">组织文化优先还是用户需求优先？</h2>
<p>不同的社区有不同的文化。组织的文化会使得当出现问题的时候，组织内所有成员对该问题的应激反应都是一致的，这种应激反应是无需请求上级就可以作出的。从<a href="https://trac.ffmpeg.org/ticket/6389" target="_blank" rel="noopener">提议</a>中可以看出，FFMpeg社区的文化之一是：编解码器要针对标准和规范来实施。</p>
<p>如果阅读FFMpeg的源码，其实也能发现很多如下的代码：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    <span class="comment">// 7.4.3.1: vps_max_layers_minus1 is in [0, 62].</span></span><br><span class="line">    HEVC_MAX_LAYERS     = <span class="number">63</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.1: vps_max_sub_layers_minus1 is in [0, 6].</span></span><br><span class="line">    HEVC_MAX_SUB_LAYERS = <span class="number">7</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.1: vps_num_layer_sets_minus1 is in [0, 1023].</span></span><br><span class="line">    HEVC_MAX_LAYER_SETS = <span class="number">1024</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7.4.2.1: vps_video_parameter_set_id is u(4).</span></span><br><span class="line">    HEVC_MAX_VPS_COUNT = <span class="number">16</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.2.1: sps_seq_parameter_set_id is in [0, 15].</span></span><br><span class="line">    HEVC_MAX_SPS_COUNT = <span class="number">16</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.3.1: pps_pic_parameter_set_id is in [0, 63].</span></span><br><span class="line">    HEVC_MAX_PPS_COUNT = <span class="number">64</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A.4.2: MaxDpbSize is bounded above by 16.</span></span><br><span class="line">    HEVC_MAX_DPB_SIZE = <span class="number">16</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.1: vps_max_dec_pic_buffering_minus1[i] is in [0, MaxDpbSize - 1].</span></span><br><span class="line">    HEVC_MAX_REFS     = HEVC_MAX_DPB_SIZE,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因此，社区不同的人对该提议的意见都是一致的。即便这个用户需求再合理，即便这个需求有多少用户支持，只要是标准不更新，FFMpeg永远都不会支持。</p>
<p>另外，用户只是需要一种能够支持H265编码的、CDN又支持良好的、延迟又非常低的视频流媒体格式而已，不是吗？如果真的有这种格式，让FLV支持HEVC是否就不是一个问题了呢？既然，Adobe已经停止了对RTMP的维护了，那么为什么还要花时间在这个协议上呢？为什么不选择更新的技术呢？虽然选择新的技术意味着需要冒更大的风险和花费更多的成本。</p>
<p>尤其是当不同的用户需求之间存在冲突，如何处理？To be or not to be,that’s a question!</p>
<h2 id="对于技术-是向前看还是回头看？">对于技术，是向前看还是回头看？</h2>
<p>“始生之物，其形必丑”。但是，新技术必然会取代旧技术，从根本上说是因为：</p>
<ul>
<li>新技术具有新的结构和功能，能适应已经变化了的环境和条件</li>
<li>新技术是对旧技术的扬弃，并添加了旧技术所不能容纳的新内容</li>
</ul>
<p>因此，对于技术而言，我们需要向前看，需要去了解这些新技术。当然，采用新技术肯定是要付出一定代价的，没有不付出就会有的收获。需要深入研究新技术和我们业务之间的差距，然后在业务的实践中不断完善新的技术。</p>
<p>另外，在了解新技术时，还要了解新技术的历史，了解在新技术是基于什么历史背景而产出的，是用于解决什么问题的？这些东西，是新技术的应用根本，只有深入了解了这些，才能在后续的应用中，得心应手。错误的应用新技术产生的问题比正确的使用旧技术要大的多。</p>
<p>例如在HTTP2的协议中，有这样的描述：</p>
<blockquote>
<p>HTTP/2 addresses these issues by defining an optimized mapping of HTTP’s semantics to an underlying connection. Specifically, it allows interleaving of request and response messages on the same connection and uses an efficient coding for HTTP header fields. It also allows prioritization of requests, letting more important requests complete more quickly, further improving performance.</p>
</blockquote>
<p>在HTTP3中，有如下的描述：</p>
<blockquote>
<p>HTTP/2 introduced a binary framing and multiplexing layer to improve latency without modifying the transport layer. However, because the parallel nature of HTTP/2’s multiplexing is not visible to TCP’s loss recovery mechanisms, a lost or reordered packet causes all active transactions to experience a stall regardless of whether that transaction was impacted by the lost packet.</p>
<p>The QUIC transport protocol incorporates stream multiplexing and per-stream flow control, similar to that provided by the HTTP/2 framing layer. By providing reliability at the stream level and congestion control across the entire connection, it has the capability to improve the performance of HTTP compared to a TCP mapping.</p>
</blockquote>
<p><img src="/2020/10/29/a-debate-about-supporting-HEVC-over-FLV/2.jpg" alt></p>
<p>就像上图的“乌鸦喝水”一样，是采用吸管呢？还是对原有的石头进行各种改进呢？</p>
<p>后来，在网上找到了又拍云的一篇<a href="https://www.cnblogs.com/upyun/p/7053150.html" target="_blank" rel="noopener">《如何将HLS延时缩短至4秒，HLS+技术详解》</a>的一篇文章。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>直播</tag>
        <tag>hevc</tag>
        <tag>flv</tag>
      </tags>
  </entry>
  <entry>
    <title>高并发下的“读后写”模式存在的问题</title>
    <url>/2020/09/07/keep-the-architecture-from-write-after-read/</url>
    <content><![CDATA[<p>我们的服务有一个功能，该功能会限制同时使用的用户数，例如使用该功能的用户不能超过100个。就好像购买车票一样，可以购买到车票的人数不能超过该车次的对应区间的车票总数。然后，在并发测试中，我们发现，实际可以使用该功能的用户数达到了200。追查之后，我们发现，这是一个典型的“读后写“的模式带来并发问题。</p>
<p><img src="/2020/09/07/keep-the-architecture-from-write-after-read/1.png" alt></p>
<a id="more"></a>
<h2 id="什么是-读后写-模式">什么是“读后写”模式</h2>
<p><code>读后写</code>是在并发场景下，针对同一数据记录的<strong>先读后写</strong>操作，并且数据写入的值依赖于数据读取的值。具体如下图所示：</p>
<p><img src="/2020/09/07/keep-the-architecture-from-write-after-read/2.png" alt></p>
<p>从定义中可以看出，只有在3个条件都具备的前提下，才会考虑<code>读后写</code>模式带来的问题：</p>
<ul>
<li>并发场景</li>
<li>同一数据</li>
<li>对数据的修改依赖于对数据的读取</li>
</ul>
<h2 id="显示的-读后写-模式的问题">显示的“读后写”模式的问题</h2>
<p>对于<code>redis</code>而言，典型的<code>读后写</code>逻辑如<strong><a href="http://test.sh" target="_blank" rel="noopener">test.sh</a></strong>所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">x=$(redis-cli -h 127.0.0.1 -p 8079 GET x)</span><br><span class="line">x=$(expr $&#123;x&#125; + 1)</span><br><span class="line">redis-cli -h 127.0.0.1 -p 8079 SET x $&#123;x&#125;</span><br></pre></td></tr></table></figure>
<p>设置<code>x=0</code>在非并发场景下，多次运行<strong><a href="http://test.sh" target="_blank" rel="noopener">test.sh</a></strong>后不会存在问题：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"><span class="keyword">for</span> ((i=0; i&lt;100; i++)); <span class="keyword">do</span> sh test.sh; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -h 127.0.0.1 -p 8079 GET x</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="string">"100"</span></span></span><br></pre></td></tr></table></figure>
<p>但是，对于如下的代码，我们则会发现，对<code>KEY x</code>的更新并没有按照预期的逻辑来更新：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> ((i=0; i&lt;100; i++)); <span class="keyword">do</span> sh test.sh &gt;/dev/null 2&gt;&amp;1 &amp;; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -h 127.0.0.1 -p 8079 GET x</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="string">"3"</span></span></span><br></pre></td></tr></table></figure>
<p>我称这种场景下导致的问题为：显示的“读后写”模式带来的问题。因为此时，并发是显而易见的，并且操作的是单一的redis实例。</p>
<h2 id="隐式的-读后写-模式的问题">隐式的“读后写”模式的问题</h2>
<p>在实际的服务中，为了提升服务的性能，往往会采用<code>读写分离</code>的架构来设计数据存储，例如MySQL的主从架构，Redis的主从架构。在<code>读写分离</code>架构下，<code>写操作</code>一般均在<strong>主</strong>服务器上执行，而<code>读操作</code>则在<strong>从</strong>服务器上执行，而主从之间则通过某种方式来通信。具体如下所示：</p>
<p><img src="/2020/09/07/keep-the-architecture-from-write-after-read/3.png" alt></p>
<p>这种场景下，比较重要的问题就是“主从延迟”的问题。当“主从延迟”的时间，超过了请求间隔的时间时，虽然看起来并没有什么并发的场景，但是实际上也是一种“隐式的并发”。</p>
<p>举个极端的例子——现实场景中可能不会有这么大的主从延迟——主从延迟的时间为5s，而当前服务的负载为2s一个请求。此时，虽然看起来没有什么“并发”的场景，但是实际上，当第2个请求到来时，由于主从延迟的存在，到时此时该请求获取的数据仍然为旧的数据，进而导致更新逻辑的异常。</p>
<p>因为，这种场景下的并发实际上被“主从”架构隐藏了起来，因此，我称这种场景下导致的问题为：隐式的“读后写”模式的问题。</p>
<p>很多时候，这两种模式会同时发生。在文章开始介绍的问题，就是这两种场景共同作用而产生的“读后写”的问题。</p>
<h2 id="如何避免-读后写-带来的问题">如何避免“读后写”带来的问题</h2>
<p>解决该问题的具体方法需要视具体的应用场景。不要期待那种“放之四海而皆准”的解决方案，而要根据自己所面临的具体场景来选择最合适的解决方案。尽管如此，我们在解决该问题时，可以有一个总的指导原则：将“读后写”模式改为“事务写后写”模式。</p>
<p>“写操作”都在“主”服务器上执行，因此，改为“写后写”模式首先避免了“主从”架构的问题。然后，在“写后写”的基础上，再使用“事务性的写操作”，就可以基本解决“读后写”的问题。</p>
<p>例如，将<code>test.sh</code>稍作修改：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">redis-cli -h 127.0.0.1 -p 8079 incr x</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> ((i=0; i&lt;100; i++)); <span class="keyword">do</span> sh test.sh &gt;/dev/null 2&gt;&amp;1 &amp;; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -h 127.0.0.1 -p 8079 GET x</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="string">"100"</span></span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>架构</category>
      </categories>
      <tags>
        <tag>数据一致性</tag>
        <tag>redis原子操作</tag>
      </tags>
  </entry>
  <entry>
    <title>从单体架构迁移到微服务架构</title>
    <url>/2020/08/19/monolith-to-microservices/</url>
    <content><![CDATA[<p><img src="/2020/08/19/monolith-to-microservices/cover.png" alt></p>
<a id="more"></a>
<p>恰好今年在了解微服务相关的技术，又恰好在浏览nginx官网的时候发现了这本书，当时读完第一章的第一节就感觉这是一本我会认真阅读的技术书籍。</p>
<p>后来，随着阅读的深入，发现我自己工作中遇到的很多的问题恰巧就是书里写的那样，与其对每一个点单独写成一篇文章或博客，还不如就以批注的形式呈现出来，这样也能更系统。</p>
<p>基于如上的想法，在阅读本书的过程中，对整个书籍内容进行了中文版的翻译，并在正文中以批注的形式写入的自己的思考，经历。</p>
<p>这本书是我读过的相对上乘的一本书，在亚马逊上的评价非常好，不但讲了微服务的迁移技术，更多讲了很多作者的思考和很多为什么的问题。正如一位读者的评论：这本书没有宣传什么技术，没有兜售什么技术，而更多的是让我们学会如何思考？我们是否真的需要使用微服务？使用过程要注意什么？……</p>
<p>翻译的版本可以点击：<a href="/monolith-to-microservices"><strong>monolith to microservices中文版</strong></a>，此版本仅供学习交流使用。如有疑问，评论区留言交流。</p>
<p>因为官方版的翻译版本至今还没有，因此，推荐大家购买英文原版，<a href="https://www.amazon.com/Monolith-Microservices-Evolutionary-Patterns-Transform/dp/1492047848" target="_blank" rel="noopener"><strong>购买链接</strong></a>。</p>
]]></content>
      <categories>
        <category>架构</category>
      </categories>
      <tags>
        <tag>荐书</tag>
        <tag>微服务</tag>
        <tag>单体</tag>
      </tags>
  </entry>
  <entry>
    <title>kill -9导致subprocess.run启动的子进程无法退出</title>
    <url>/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/</url>
    <content><![CDATA[<h2 id="背景">背景</h2>
<p>我们有一个任务托管平台，该平台可以托管<code>python</code>语言编写任务，并且可以对任务状态进行管理。由于业务的需要，我们需要在<code>python</code>的任务中调起一个<code>shell</code>脚本来完成一些额外的事情。当我们把编写好的任务部署到任务托管平台之后，我们发现一个奇怪的现象：当在任务的超时时间内手动结束任务的时候，只有<code>python</code>的父进程退出了，而<code>python</code>启动的<code>shell</code>子进程却没有退出。</p>
<a id="more"></a>
<h2 id="subprocess模块">subprocess模块</h2>
<p>我们使用subprocess.run()来创建新的shell进程，具体如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">subprocess.run(</span><br><span class="line">    cmd,</span><br><span class="line">    cwd=cwd,</span><br><span class="line">    shell=<span class="literal">True</span>,</span><br><span class="line">    stdout=subprocess.PIPE,</span><br><span class="line">    stderr=subprocess.PIPE,</span><br><span class="line">    encoding=<span class="string">"utf-8"</span>,</span><br><span class="line">    timeout=<span class="number">600</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>为了方便测试，分别写了一段<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/timeout.py" target="_blank" rel="noopener"><code>python</code>代码</a>和<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/timeout.sh" target="_blank" rel="noopener"><code>shell</code>代码</a>，可以点击链接查看具体代码。其中，<code>shell</code>脚本为一个死循环，具体如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for((i=0;;i++))</span><br><span class="line">do</span><br><span class="line">    echo "$i" &gt;log 2&gt;&amp;1</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>然后，我们在本地使用<code>kill -2（ctrl+c）</code>结束父进程的时候，子进程也确实结束了。具体如下图所示：</p>
<p><img src="/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/sigint.png" alt></p>
<p>我们继续查出问题的原因，我们咨询了任务托管平台的负责人：任务托管平台页面上的<code>结束任务</code>是怎么实现的？</p>
<p>平台的负责人回应说：<code>kill -9</code>命令结束的。</p>
<p>在这时候，我知道，我可能大概知道问题的原因了。</p>
<h2 id="kill和signal">kill和signal</h2>
<p>关于<code>kill</code>命令，此处不做详细介绍，具体可以参考<a href="https://man7.org/linux/man-pages/man1/kill.1.html" target="_blank" rel="noopener">kill(1)手册</a>。<code>kill</code>的作用是向某个特殊的进程或进程组发送一个特殊的信号，从而达到结束进程的目的。关于<code>信号(signal)</code>，此处也不做详细介绍，具体可以参考<a href="https://man7.org/linux/man-pages/man7/signal.7.html" target="_blank" rel="noopener">signal(7)手册</a>。</p>
<p>而<code>kill -9</code>命令实际上是向进程发送了<code>SIGKILL</code>信号，而在<a href="https://man7.org/linux/man-pages/man7/signal.7.html" target="_blank" rel="noopener">signal(7)手册</a>中可以看到：<strong>The signals SIGKILL and SIGSTOP cannot be caught, blocked, or ignored.</strong> 因此，<code>kill -9</code>是一种不可捕获的、不可忽略的信号，用来在特殊情况下紧急结束进程（如果该信号可以捕获和忽略的话，就达不到这个目的了）。</p>
<p>而对于一个单进程的程序而言，直接<code>kill -9</code>结束并没有什么问题，但是对于一个多进程的程序，例如本文中的例子，在<code>python</code>进程中又创建了<code>shell</code>子进程，那么直接用<code>kill -9</code>粗暴的结束父进程是非常不安全的，具体如下图所示：</p>
<p><img src="/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/sig9.jpg" alt></p>
<p>可见，在<code>kill -9</code>结束父进程之后，<code>shell</code>编写的子进程成为了<a href="https://www.geeksforgeeks.org/zombie-and-orphan-processes-in-c/" target="_blank" rel="noopener">孤儿进程</a>，并继续执行。</p>
<p>这也就是，我们在任务托管平台上结束任务后，子进程并没有退出的根本原因。父进程结束的信号根本就没有机会通知到子进程，子进程也就不可能结束了。</p>
<p>那么，我们换另外一个可以被捕获和忽略的信号，例如<code>SIGTERM</code>是否能结束子进程呢？</p>
<p><img src="/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/sigterm.jpg" alt></p>
<p>从图中可以看出，<code>SIGTERM</code>信号也没有结束子进程。</p>
<h2 id="subprocess-run-所捕获的异常">subprocess.run()所捕获的异常</h2>
<p>我们从<a href="https://github.com/python/cpython/blob/3.8/Lib/subprocess.py" target="_blank" rel="noopener">subprocess模块的源码</a>中可以发现，<code>subprocess.run()</code>实际上只捕获自定义的<code>TimeoutExpired</code>异常和<code>KeyboardInterrupt</code>异常，而在<code>python</code>中，<code>KeyboardInterrupt</code>异常对应的就是<strong>用户中断执行</strong>，一般就是输入<code>ctl+c</code>或发送<code>SIGINT</code>信号。具体如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Popen(*popenargs, **kwargs) <span class="keyword">as</span> process:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        stdout, stderr = process.communicate(input, timeout=timeout)</span><br><span class="line">    <span class="keyword">except</span> TimeoutExpired <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">except</span>:  <span class="comment"># Including KeyboardInterrupt, communicate handled that.</span></span><br><span class="line">        process.kill()</span><br><span class="line">        <span class="comment"># We don't call process.wait() as .__exit__ does that for us.</span></span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>
<p>可见，对于<code>SIGINT</code>信号而言，<code>subprocess.run()</code>函数会调用<code>Popen.kill()</code>来结束子进程。</p>
<p>因此，对于多进程而言，当父进结束之前，需要通过某种机制来通知其子进程，进而让子进程知晓父进程的退出信息，并作出合理的后续行为。否则，就会出现本文中出现的孤儿进程的现象。</p>
<p>因此，对于其他的信号，<code>subprocess</code>模块本身就无法处理了。</p>
<h2 id="捕获sigterm信号">捕获SIGTERM信号</h2>
<p>如果要捕获<code>SIGTERM</code>信号，使得<code>kill -15</code>结束python任务的时候，同时也能结束子进程，那么就要耍点小聪明了，例如：在<code>python</code>中捕获其他信号，并将其转成<code>SIGINT</code>信号，具体可以参见<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/timeout_1.py" target="_blank" rel="noopener">timeout_1.py</a>。具体执行效果如下所示：</p>
<p><img src="/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/popen.jpg" alt></p>
<p>此处，我用了一个偷懒的方法，也就是把<code>SIGTERM</code>信号捕获之后转成<code>SIGINT</code>信号，具体的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def sigintHandler(signum, frame):</span><br><span class="line">    raise KeyboardInterrupt</span><br><span class="line"></span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">def run_cmd(cmd, cwd):</span><br><span class="line">    signal.signal(signal.SIGTERM, sigintHandler)</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>
<h2 id="结语">结语</h2>
<p>查完这个问题，也算是对进程相关的内容有了更深入的了解。孤儿进程，僵尸进程，不可屏蔽进程……，好像经过很多时间之后，忽然都不记得自己曾经也钻研过这些概念一样。感谢我的同事<em>一卓</em>(<a href="https://github.com/GerenLiu" target="_blank" rel="noopener">@GerenLiu</a>)，在工作之余抽时间来一起讨论这个问题。</p>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>subprocess</tag>
        <tag>kill命令</tag>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化测试首先是一种工作文化</title>
    <url>/2020/07/08/autotest-is-a-working-culture-first/</url>
    <content><![CDATA[<blockquote>
<p>自古以来，人类就有创造自动装置以减轻或代替人劳动的想法。自动化技术的产生和发展经历了漫长的历史过程。古代中国的铜壶滴漏（简称漏壶）、指南车以及17世纪欧洲出现的钟表和风磨控制装置，虽然都是毫无联系的发明，但对自动化技术的形成却起到了先导作用。</p>
</blockquote>
<h2 id="自动化测试之痛">自动化测试之痛</h2>
<p>最近在帮助一个团队梳理团队测试效率的问题，其目标是提升该团队的测试效率。在整个梳理的过程中，我发现一件非常有意思的事情：这个团队基本上没有自动化测试，大部分的测试手段还是手工测试加CR。更为有意思的事情是：团队成员大都对自动化测试比较抵触，认为自动化测试的成本较大，且看不到收益。</p>
<p>回想过去几年的测试工作，我发现，几乎所有的测试团队在面对自动化测试时都会存在类似的问题：<strong>希望自动化测试提升效率，但是执行时却发现自动化测试反而没有提升效率，因此慢慢废弃自动化测试，直至抵触自动化测试，到最后自动化测试变成一种“形而上”般的存在</strong>。我姑且称这种现象为——<strong>自动化测试之痛</strong>。</p>
<a id="more"></a>
<p>自动化测试之痛的问题根源究竟是什么呢？事情真的如有些团队所说：自动化case的成本太大，又没有收益吗？</p>
<h2 id="侠客岛的故事">侠客岛的故事</h2>
<blockquote>
<p>自从三十年前开始，每过十年，就会有大批的武林高手被请去侠客岛喝腊八粥，不但这些武林高手从此都一去不复返，而且侠客岛还演变成为了赏善罚恶的行动。</p>
<p>为此，江湖中人人自危，每到十年之期，各大门派的掌门就纷纷寻找替身，来躲避侠客岛的赏善罚恶。但是，当这些武林高手到了侠客岛之后才终于揭开了侠客岛的秘密。</p>
<p>原来岛上刻有武林秘籍，由于岛主人参不透秘籍，所以才会请武林高手到岛上共同参悟。并且由于岛上的‘断肠蚀骨腐心草’十年一开花，此草若再配以其他佐使之药，熬成热粥，服后于练武之士大有补益，因此才有了每十年邀请一次的惯例。被邀上岛的人也并不是遇害，而是痴迷于武学，都不想回去罢了。</p>
<p><strong><div align="right">——《侠客行》</div></strong></p>
</blockquote>
<p>有多少时候，我们对自动化测试的认识和江湖人士对侠客岛的认识是类似的呢？<br>
有多少时候，明明是侠客岛盛情所邀，江湖之上却人人躲而避之呢？<br>
有多少时候，明明是对自己大有补益的腊八粥，所有被邀的武林人士却不敢喝下呢？</p>
<p>或许你会反驳，但凡有上岛的武林人士扩散一下事实真相，那整个江湖也不至于如此？<br>
但是，正如本文开篇所述，整个人类社会都是证明自动化的历史，为什么还有那么多的团队在质疑自动化测试呢？<br>
为什么有那么多的测试实践已经证明了自动化测试的成效——例如谷歌的<a href="https://mike-bland.com/2012/07/10/test-mercenaries.html" target="_blank" rel="noopener"><strong>Test Mercenaries</strong></a>计划，还是有那么多的团队对自动化测试心存质疑呢？</p>
<p>正如Sam NewMan在<a href="https://samnewman.io/books/monolith-to-microservices/" target="_blank" rel="noopener"><strong>Monolith To Microservices</strong></a>一书中说的那样：<a href="https://wangwei1237.gitee.io/monolith-to-microservices/docs/The_Monolith.html#ref_denigrating_monolith" target="_blank" rel="noopener">一旦我们陷入系统性抹黑单体的陷阱，我们就会面临很大的麻烦</a>。</p>
<h2 id="自动化测试的定位">自动化测试的定位</h2>
<p>接下来，我从3个方面来阐述自动化测试的定位。</p>
<h3 id="测试的4大活动">测试的4大活动</h3>
<p>根据乔梁老师的<a href="https://item.jd.com/12512514.html" target="_blank" rel="noopener">《持续集成2.0》</a>一书中所述，测试领域有4大基本活动，如<a href="#f1">图1</a>所示。</p>
<p><span id="f1"><img src="/2020/07/08/autotest-is-a-working-culture-first/f1.png" alt></span></p>
<p>图1. 测试的4大基本活动</p>
<p>其中，各活动的基本含义如下：</p>
<ul>
<li><strong>问题认知</strong>：对业务问题本身的理解和认知，包括需求理解，技术设计理解……</li>
<li><strong>分析</strong>：测试分析和测试设计，根据对问题的认知，设计测试方案和用例，保证业务质量</li>
<li><strong>执行</strong>：执行分析阶段的测试用例，产出测试结论</li>
<li><strong>决策</strong>：根据测试结论进行相关决策，包括是否存在风险，是否达到上线标准……</li>
</ul>
<h3 id="敏捷测试4象限">敏捷测试4象限</h3>
<p>根据测试所支持的对象，测试可以分为：<a href="https://www.tutorialspoint.com/agile_testing/agile_testing_quadrants.htm" target="_blank" rel="noopener">面向业务业务的测试和面向研发的测试</a>。<a href="http://www.exampler.com/old-blog/2003/08/22/#agile-testing-project-2" target="_blank" rel="noopener">Brian Marick</a>根据这两种测试类型提出了<strong>敏捷测试4象限</strong>的概念，如<a href="#f2">图2</a>所示。</p>
<p><span id="f2"><img src="/2020/07/08/autotest-is-a-working-culture-first/f2.png" alt></span></p>
<p>图2. 敏捷测试4象限</p>
<p>在<a href="#f2">图2</a>中：</p>
<ul>
<li><strong>功能验收测试</strong>：从用户的角度来验收功能</li>
<li><strong>第三象限的自动化测试</strong>：研发团队对自我软件技术实现的验证</li>
</ul>
<h3 id="自动化测试的4要素">自动化测试的4要素</h3>
<p>在测试的4大活动中，“执行”环节会存在大量的重复工作，而其中的大部分工作都可以由机器来承担。此时就可以发挥自动化测试的优势，释放人的重复劳动。</p>
<p>而在Brian Marick的敏捷测试4象限中，第2、第3象限的测试类型也可以发挥自动化测试的优势，提升整个测试执行的效率。</p>
<p>对于自动化测试而言，我总结了自动化测试的4要素：自动部署、自动执行、自动校验、自动报告，如<a href="#f3">图3</a>所示。</p>
<p><span id="f3"><img src="/2020/07/08/autotest-is-a-working-culture-first/f3.gif" alt></span></p>
<p>图3. 自动化测试的4要素</p>
<h2 id="自动化测试的误区">自动化测试的误区</h2>
<p>接下来，着重来说一下我所见到、听到的一些关于自动化测试的误区。</p>
<h3 id="误区1：只看短期效率收益">误区1：只看短期效率收益</h3>
<p>有的团队希望自动化case来提升测试效率，当然，这是自动化case可以获取的收益之一。这些团队还会针对自动化对效率的提升制定定量的指标，然后每周，每月，每季度（当然，有些人还没有坚持到季度末就不做了）来跟进。</p>
<p>但是，正如Sam Newman在<a href="https://wangwei1237.gitee.io/monolith-to-microservices/docs/How_Will_You_Know_if_the_Transition_Is_Working.html#%E5%AE%9A%E9%87%8F%E6%8C%87%E6%A0%87" target="_blank" rel="noopener"><em>Monolith To Microservices</em></a>一书中所说：</p>
<blockquote>
<p>有的指标可能很难在短时间内有量的变化。</p>
<p>如果在微服务迁移的前几个月就看到cycle time的大幅改善，我会感到惊讶。</p>
<p>实际上，我更希望看到cycle time会在迁移的初期变得更糟。</p>
<p>因为团队需要不断适应新的工作方式，因此短期内对工作方式的变革通常会对生产效率产生负面影响。</p>
</blockquote>
<p>自动化测试也是一个很难在很短的时间内就能看到收益的工具，并且还需要付出一些成本：需要学习自动化测试的配套工具，编写自动化case的框架，调度自动化执行的相关工具……</p>
<p>因此，最开始的一段时间内，自动化测试有可能会降低测试效率。但是，一旦掌握这些技巧，我们就会发现汽车确实比马车跑的快，难道不是吗？</p>
<p>短期收益不明显还有另外一个因素：短期内适合自动化测试的项目分布并不均匀。如<a href="#f3">图3</a>所示，自动化测试在<a href="#%E6%B5%8B%E8%AF%95%E7%9A%844%E5%A4%A7%E6%B4%BB%E5%8A%A8">测试4大活动</a>中的执行阶段以及<a href="#%E6%95%8F%E6%8D%B7%E6%B5%8B%E8%AF%954%E8%B1%A1%E9%99%90">敏捷测试4象限</a>中的第2、第3象限才能发挥其作用。但是对于周、月维度的项目而言，能有多少项目会让自动化测试有用武之地呢？接下来发生的事情就是对自动化测试的定量指标而言，没有数据上的变化，然后坏的事情就会发生了，团队慢慢就失去了耐心……</p>
<h3 id="误区2：只看个人效率收益">误区2：只看个人效率收益</h3>
<p>在进行自动化测试之前，大多数团队都会选择一些业务来试点，然后根据试点业务的反馈来确定是否要大范围推广。</p>
<p>但是，在实际试点的时候，会出现很多影响因素：例如测试人员前期没有接入测试了解，测试人员没有提前和研发人员确定接口定义，测试人员前期在跟进其他项目……</p>
<p>如上的因素会导致当一个测试项目到来时，测试人员没有足够的时间来消化那些需要在前期所付出的学习成本。在面对一个个紧急的项目和需要付出一定的成本时，这些试点的测试人员会自然而然的继续使用旧有的手工测试的方式来保证项目的快速跟进。</p>
<p>试点项目的测试人员会从自身的利益出发来选择测试方案。然后这些试点的测试人员就会汇报说：自动化测试太浪费时间了，没法提高效率。如果管理者不仔细继续和这些一线的同学深入探讨，那么最终就会根据试点同学的结论得出一个偏离事实的结论：自动化测试确实无法提升效率。</p>
<p>然而，上述的一些试点人员遇到的问题从本质上讲，并不是自动化测试本身的问题，这里涉及到更多的流程、沟通、协作的问题。不是自动化测试不能提升效率，而是当前的环境不允许自动化测试发挥作用。</p>
<p>泥泞的道路上，是马车快呢还是跑车快呢？</p>
<p>在所有人只从自身利益来考虑问题，而忽略其所处的环境时，就会出现这种：马车比跑车快的滑稽结论。</p>
<h3 id="误区3：成本核算标准不一致">误区3：成本核算标准不一致</h3>
<p>如前所述，自动化测试是需要学习成本的，不经历风雨怎么见彩虹？自动化测试和手工测试的ROI权衡如<a href="#f4">图4</a>所示。</p>
<p><span id="f4"><img src="/2020/07/08/autotest-is-a-working-culture-first/f4.png" alt></span></p>
<p>但是在我的观察中，我发现大多数团队在核算手工测试和自动化测试的成本时采用的标准并不一致。他们会忽略：手工测试重复测试的成本，会忽略手工测试重复书写测试报告的成本……但是他们会给自动化测试追加上：上下游环境依赖成本，环境部署成本，接口定义不完备的成本，自动化用例的维护成本太大了……</p>
<p>点一下最简单，成本最低，点点吧。</p>
<p>当夜深人静的时候，你再细想这些话术、你细想……就会发现这些成本和自动化测试什么关系，手工测试不也需要这些成本吗？要是一个项目要测多轮，难不成每次都点点？OH，当然不是了，下一次只点那些上一次失败的用例就好了……OMG……</p>
<p>手工用例就不需要维护成本？不过从我的观察发现，确实不需要。因为有些团队压根就不写手工用例，当然就谈不上成本了。还有的团队即便有手工用例也从来不会维护，下一个同学测试类似的项目的时候，参考一下之前的用例，然后自己重新写用例。</p>
<h3 id="误区4：不关注团队收益">误区4：不关注团队收益</h3>
<p>在误区2中，试点项目的测试人员只根据自己的个人收益来做测试方案的选择。但是团队中的个人是相互联系的，团队内部的项目也会是连续的，而不是离散的。</p>
<p>某个人测试的某个项目，下一次可能就换其他人来测试了。某个短期来看不会变化的项目，可能数月之后就会修改了。项目每次都修改一点点，可能半年之后就会有上百个修改点了……</p>
<p>如果站在团队的角度考虑，我们团队内每个人编写的自动化用例有时候虽然对个人而言ROI很低，但是对团队的ROI却可能非常大。</p>
<p>如果每一个变更很小的项目都不编写自动化用例，那么当项目做大的时候怎么办？<br>
如果每个项目都是上线后就不修改了，那当这个项目的代码要下线的时候怎么办？</p>
<p>当然，这些对于个人而言是无需关注的事情，因为谁知道接下来的测试还是不是你负责？但是，最终却还是这个团队来负责的，不是吗？当所有这些都没有仔细执行的时候，在遇到大的项目，在遇到团队技术重构的项目时，对于团队而言，一个怪异的现象就发生了：大多数团队都在试图寻找另外的测试方法来弥补自动化用例缺失的遗憾，比如引流测试diff测试等等。</p>
<h3 id="误区5：自动化用例是万年不变的">误区5：自动化用例是万年不变的</h3>
<p>因为自动化用例需要随着业务代码的迭代而迭代，而很多团队又认为这样的成本太大了。因此自动化用例就成了一堆万年不变的功能的测试用例，最终自动化就成了“形而上”般的存在。</p>
<p>业务代码都在不断变化，不断升级，不断迭代，凭什么自动化的用例就得万年不变，自动化的用例就不用维护？实在是想不通这里面的道理。</p>
<p>自动化用例的落后，会导致自动化用例无法成为业务代码的试刀石，当他变成一件附属品时，他所带来的一切就只有成本了。</p>
<h3 id="误区6：项目迭代太快了-等稳定了再用自动化测试">误区6：项目迭代太快了，等稳定了再用自动化测试</h3>
<p>这一点是我听到过的所有的谬误中最没有道理的一个了。</p>
<p>从<a href="#f4">图4</a>中可以看出，越是大的项目，越是迭代次数多的项目，越是变化快的项目，自动化测试的收益越大。大多数团队，此时想到的更多的是快速的变化带来的是更多的自动化用例的维护成本。</p>
<p>但是，即便是创业公司，谁也不会在项目启动的时候就朝着把项目做烂的目标行进吧？</p>
<p>等项目稳定的时候，估计就是这个产品要下线的时候了。</p>
<h2 id="自动化测试是一种文化">自动化测试是一种文化</h2>
<p>在考虑自动化测试的时候，需要认真的思考自动化测试的定位和目标，需要认识到自动化测试需要付出一定的成本，自动化测试还需要修改既有的研发流程，需要认识到团队的累计收益……</p>
<p>在考虑自动化测试的时候，还需要意识到，自动化测试一种项目文档化的手段，正所谓“测试即文档”，自动化测试还是团队内部不同测试人员有效沟通的一种手段，自动化测试更是团队积累的一种有效载体……</p>
<p>自我看来，自动化测试首先应该是一种工作文化，而不单纯是一种测试手段。工作文化意味着当出现问题的时候，我们的反应是我们没会使用这个工具，或者我们的使用方法不对，而不是说这个工具是有问题的。</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>测试</tag>
        <tag>自动化测试</tag>
        <tag>auto test</tag>
        <tag>敏捷</tag>
        <tag>方法论</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Boost::Python用C++开发Python库</title>
    <url>/2020/06/13/write-python-library-using-c-with-boost-python/</url>
    <content><![CDATA[<h2 id="背景">背景</h2>
<p>很多系统都会用<code>json</code>格式进行数据交互。为了保证数据在系统上下游的自动校验，避免数据结构异常带来的系统稳定性问题，可以采用<a href="http://json-schema.org" target="_blank" rel="noopener"><code>json-schema</code></a>来定义<code>json接口</code>，并利用<a href="https://datatracker.ietf.org/doc/draft-handrews-json-schema-validation" target="_blank" rel="noopener"><code>json-schema-validator</code></a>来校验接口响应的结构的合法性。</p>
<p>然而系统中不同子系统的实现（编程语言）并非总是一致，虽然各种语言都提供了<a href="https://datatracker.ietf.org/doc/draft-handrews-json-schema-validation" target="_blank" rel="noopener"><code>json-schema-validator</code></a>的具体实现，但是不同语言支持的<code>json-schema-validator</code>标准的版本并非完全一致，这会对后续的使用带来一些混乱，例如：</p>
<ul>
<li>Java: <a href="https://github.com/java-json-tools/json-schema-validator" target="_blank" rel="noopener">json-schema-validator</a>支持<a href="https://tools.ietf.org/html/draft-fge-json-schema-validation-00" target="_blank" rel="noopener">Draft 4</a></li>
<li>C++: <a href="https://github.com/pboettch/json-schema-validator" target="_blank" rel="noopener">json-schema-validator</a>支持<a href="https://tools.ietf.org/html/draft-handrews-json-schema-validation-01" target="_blank" rel="noopener">Draft 7</a></li>
<li>Python <a href="https://github.com/Julian/jsonschema" target="_blank" rel="noopener">jsonschema</a>支持<a href="https://tools.ietf.org/html/draft-handrews-json-schema-validation-01" target="_blank" rel="noopener">Draft 7</a></li>
</ul>
<a id="more"></a>
<p>目前大多数语言，例如：Java, Golang, Php, Python, Lua等都支持C/C++的扩展。因此，可以用C/C++来为其他语言提供统一的扩展库支持，本文就是介绍怎么利用<code>Boost::Python</code>库提供<a href="https://github.com/pboettch/json-schema-validator" target="_blank" rel="noopener"><code>json-schema-validator</code></a>的Python支持，并介绍如何利用<code>distutils</code>来编译&amp;分发Python库。</p>
<p><img src="/2020/06/13/write-python-library-using-c-with-boost-python/1.png" alt></p>
<h2 id="python调用c-c-的方式">Python调用C/C++的方式</h2>
<p>有两种方式可以实现Python调用C/C++编写的库：</p>
<ul>
<li>使用Python扩展</li>
<li>使用<code>ctypes</code>模块直接加载C/C++编写的so</li>
</ul>
<h4 id="ctypes加载so文件">ctypes加载so文件</h4>
<p><code>ctype</code>是Python的外部函数库。它提供了C兼容的数据类型，并允许在DLL或共享库中调用函数。</p>
<p><code>ctype</code>是Python封装的API函数库。其中<code>cdll = &lt;ctypes.LibraryLoader object&gt;</code>是一个库加载器对象，调用<code>cdll.LoadLibrary</code>便可调用C/C++的so库。</p>
<p>此处不再对如何使用<code>ctype</code>模块加载so文件做过多的介绍，具体可以参考其<a href="https://docs.python.org/3/library/ctypes.html#module-ctypes" target="_blank" rel="noopener">官方文档</a>。</p>
<h4 id="使用python扩展">使用Python扩展</h4>
<p>该方式是Python为整合其它语言而提供的一种扩展机制，并且该机制不局限于C/C++，也可以用于其它语言。Python的可扩展性具有如下的优点：</p>
<ul>
<li>方便为语言增加新功能</li>
<li>具有可定制性</li>
<li>可以实现代码复用</li>
<li>……</li>
</ul>
<p>该方式的具体使用此处也不再做过多介绍，具体信息可以直接参考Python的官方文档<a href="https://docs.python.org/3/extending/building.html" target="_blank" rel="noopener"><strong>Building C and C++ Extensions</strong></a>来了解。接下来要讲的例子就是利用了<code>可以实现代码复用</code>的优点。</p>
<p>如<a href="https://docs.python.org/3/extending/building.html" target="_blank" rel="noopener"><strong>Building C and C++ Extensions</strong></a>所示，Python提供了<code>Python/C++ API</code>用来实现Python和C++的交互。然而，直接使用这些API来完成Python和C/C++的交互还是会存在很多重复工作的。<code>Boost::Python</code>则对<code>Python/C++ API</code>进行了抽象和包装，从而使得Python和C++的交互更加方便。</p>
<h2 id="boost-python封装c-c-扩展">Boost::Python封装C/C++扩展</h2>
<p>接下来我们介绍我们是如何利用Boost::Python来为<a href="https://github.com/pboettch/json-schema-validator" target="_blank" rel="noopener">nlohmann_json_schema_validator</a>增加Python扩展。</p>
<p><code>nlohmann_json_schema_validator</code> is a C++ library for validating JSON documents based on a <strong>JSON Schema</strong> which itself should validate with <strong>draft-7 of JSON Schema Validation</strong>.</p>
<h4 id="编译nlohmann-json-schema-validator库">编译nlohmann json schema validator库</h4>
<p><code>nlohmann json schema validator</code>支持产出可执行的bin文件以及可供其他项目使用的动态库。为了可以将该扩展包装成Python扩展，我们需要生成该库的动态库。</p>
<p>首先根据<code>nlohmann json schema validator</code>的<a href="https://github.com/pboettch/json-schema-validator/blob/master/README.md#building-as-shared-library" target="_blank" rel="noopener">编译文档</a>编译出<code>nlohmann json schema validator</code>的动态库。</p>
<p><img src="/2020/06/13/write-python-library-using-c-with-boost-python/2.jpg" alt></p>
<h4 id="boost-python封装c-c-代码">Boost::Python封装C/C++代码</h4>
<p>在安装Boost的时候，虽然Boost的头文件中存在Boost::Python相关的hpp文件，但是默认却没有该动态库。因此，在使用Boost::Python之前，首先需要安装该库。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ brew install boost-python3</span><br></pre></td></tr></table></figure>
<p>然后，我们用C++编写<code>class json_validator_python;</code>来封装<code>nlohmann json schema validator</code>库，并利用Boost::Python来导出，具体如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// jsv_python.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;nlohmann/json-schema.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/python.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost::python;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSON_SCHEMA_VALIDATOR_API</span> <span class="title">json_validator_python</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    nlohmann::json_schema::json_validator validator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    json_validator_python() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set_root_schema</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;json_string)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        validator.set_root_schema(nlohmann::json::parse(json_string.<span class="built_in">begin</span>(), json_string.<span class="built_in">end</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">validate</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;json_string)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        validator.validate(nlohmann::json::parse(json_string.<span class="built_in">begin</span>(), json_string.<span class="built_in">end</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// json_schema_validator为module名，必需和生成的so库名一样</span></span><br><span class="line">BOOST_PYTHON_MODULE(json_schema_validator)</span><br><span class="line">&#123;</span><br><span class="line">    class_&lt;json_validator_python, boost::noncopyable&gt; (<span class="string">"json_validator_python"</span>)</span><br><span class="line">            .def(<span class="string">"set_root_schema"</span>, &amp;json_validator_python::set_root_schema)</span><br><span class="line">            .def(<span class="string">"validate"</span>, &amp;json_validator_python::validate)</span><br><span class="line">            ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上所示的<code>BOOST_PYTHON_MODULE</code>代码，目的是导出类及成员方法，这些导出的类和方法可以在Python中调用。</p>
<p>关于Boost::Python更详细的使用，可以参考其<a href="https://www.boost.org/doc/libs/1_66_0/libs/python/doc/html/index.html" target="_blank" rel="noopener">官方文档</a>。</p>
<h4 id="编译并产出python扩展">编译并产出Python扩展</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">g++ --std&#x3D;c++11 -fPIC -c jsv_python.cpp \</span><br><span class="line">-I$&#123;json-schema-validator_PATH&#125;&#x2F;src \</span><br><span class="line">-I$&#123;nlohmann-json_PATH&#125; \</span><br><span class="line">-I$&#123;Boost_PATH&#125;&#x2F;include \</span><br><span class="line">-I$&#123;Python_INCLUDE_PATH&#125;</span><br><span class="line"></span><br><span class="line">g++ --std&#x3D;c++11 -shared \</span><br><span class="line">-L$&#123;json-schema-validator_LIB_PATH&#125; \</span><br><span class="line">-L$&#123;Python_LIB_PATH&#125; \</span><br><span class="line">-L$&#123;Boost_Python_LIB_PATH&#125; \</span><br><span class="line">-lnlohmann_json_schema_validator \</span><br><span class="line">-lboost_python38 -lpython3.8 \</span><br><span class="line">-o json_schema_validator.so jsv_python.o</span><br></pre></td></tr></table></figure>
<p>如上的指令，会生成封装之后的Python扩展：<code>json_schema_validator.so</code>。</p>
<h4 id="测试python扩展">测试python扩展</h4>
<p>在当前目录执行如下的Python代码，可以发现，我们封装的扩展已经可以当做Python扩展来导入并使用了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json_schema_validator <span class="keyword">as</span> jsv</span><br><span class="line"></span><br><span class="line">validator = jsv.json_validator_python()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">isValidator = <span class="literal">True</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    validator.set_root_schema(<span class="string">'&#123;"type":"object", "properties": &#123;"a":&#123;"type": "string"&#125;&#125;&#125;'</span>)</span><br><span class="line">    validator.validate(<span class="string">'&#123;"a":"1"&#125;'</span>);</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    isValidator = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">print(isValidator)</span><br></pre></td></tr></table></figure>
<h2 id="使用distutils编译并分发扩展">使用distutils编译并分发扩展</h2>
<p>为了使用方便，使用<a href="https://docs.python.org/3/extending/building.html" target="_blank" rel="noopener"><strong>Building C and C++ Extensions</strong></a>介绍的<code>distutils模块</code>编译Python扩展。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> distutils.core <span class="keyword">import</span> setup, Extension</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">"CC"</span>] = <span class="string">"g++"</span></span><br><span class="line">os.environ[<span class="string">"CXX"</span>] = <span class="string">"g++"</span></span><br><span class="line"></span><br><span class="line">module1 = Extension(<span class="string">'json_schema_validator'</span>,</span><br><span class="line">                    include_dirs = [<span class="string">'../../src'</span>,</span><br><span class="line">                        <span class="string">'../../'</span>,</span><br><span class="line">                        <span class="string">'/usr/local/Cellar/boost/1.72.0_3/include'</span>,</span><br><span class="line">                        <span class="string">'/usr/local/opt/python@3.8/Frameworks/Python.framework/Versions/3.8/include/python3.8'</span>],</span><br><span class="line">                    libraries = [<span class="string">'boost_python38'</span>, <span class="string">'python3.8'</span>,</span><br><span class="line">                        <span class="string">'nlohmann_json_schema_validator'</span>],</span><br><span class="line">                    library_dirs = [<span class="string">'/usr/local/opt/python@3.8/Frameworks/Python.framework/Versions/3.8/lib'</span>,</span><br><span class="line">                        <span class="string">'/usr/local/Cellar/boost-python3/1.72.0_1/lib'</span>,</span><br><span class="line">                        <span class="string">'.'</span>],</span><br><span class="line">                    sources = [<span class="string">'jsv_python.cpp'</span>],</span><br><span class="line">                    extra_compile_args=[<span class="string">'--std=c++11'</span>],</span><br><span class="line">                    extra_link_args=[<span class="string">'--std=c++11'</span>])</span><br><span class="line"></span><br><span class="line">setup (name = <span class="string">'json-schema-validator'</span>,</span><br><span class="line">       version = <span class="string">'1.0'</span>,</span><br><span class="line">       description = <span class="string">'json schema validator'</span>,</span><br><span class="line">       ext_modules = [module1])</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3 setup.py build</span><br><span class="line">$ python3 setup.py install</span><br><span class="line">$ export LD_LIBRARY_PATH&#x3D;$LD_LIBRARY_PATH:&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;json_schema_validator</span><br></pre></td></tr></table></figure>
<p>然后就可以在任意位置，执行<a href="#%E6%B5%8B%E8%AF%95python%E6%89%A9%E5%B1%95">测试python扩展</a>一节的测试代码啦。</p>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>Boost::Python</tag>
        <tag>setup.py</tag>
        <tag>distutils</tag>
      </tags>
  </entry>
  <entry>
    <title>集群时间戳不一致导致的问题及其分析和思考</title>
    <url>/2020/05/29/problem-caused-by-timestamp-s-difference-in-cluster-and-analysis/</url>
    <content><![CDATA[<blockquote>
<p>1883年11月18日，美国第一个全国统一铁路时刻表诞生，这一天的正午时分，美国东部的时钟全部回拨。从此，上帝的时间被改用人间的指针来度量。 ——<strong>公司的力量</strong></p>
</blockquote>
<h2 id="背景">背景</h2>
<p>最近遇到的业务上的问题涉及：<em>在一个集群中，存在部分机器的<code>时间戳</code>和其它机器不一致而导致的重大问题</em>。为了不泄露业务的相关信息，文中会用一个类似的场景来对这个问题进行分析。</p>
<a id="more"></a>
<h2 id="时间戳-unix-time-stamp">时间戳（unix time stamp）</h2>
<p>需要注意的是，这里涉及到的问题是集群<code>时间戳</code>不一致而不是<code>时间</code>不一致。</p>
<p><a href="https://www.unixtimestamp.com" target="_blank" rel="noopener">The unix time stamp</a> is a way to track time as a running total of seconds. This count starts at the Unix Epoch on January 1st, 1970 at UTC. Therefore, the unix time stamp is merely the number of seconds between a particular date and the Unix Epoch. It should also be pointed out (thanks to the comments from visitors to this site) that <strong><code>this point in time technically does not change no matter where you are located on the globe</code></strong>. This is very useful to computer systems for tracking and sorting dated information in dynamic and distributed applications both online and client side.</p>
<p>由此可知，<code>时间戳</code>和<code>时间</code>不同，是一个和时区无关的全球一致的时间计量方式。不同集群会因为其所在的时区不同而存在时间不同的问题，但是其时间戳是一致的。</p>
<p>Linux系统而言，时间戳可以利用<a href="https://www.gnu.org/software/shellutils/shellutils.html" target="_blank" rel="noopener"><code>GNU shell utilities</code></a>提供的<a href="https://github.com/coreutils/coreutils/blob/master/src/date.c" target="_blank" rel="noopener"><code>date</code>命令</a>来获取。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ date +%s</span><br><span class="line">$ 1590719825</span><br></pre></td></tr></table></figure>
<h2 id="时间戳不一致带来的问题">时间戳不一致带来的问题</h2>
<p>考虑如下的一个购物站点的活动场景，如下的场景可能不会在现实的电商活动中存在，该场景仅仅是为了说明本文的问题而抽象的一个场景。</p>
<blockquote>
<p>原价100￥的商品，现价10￥元销售，但前提是下单的用户需要在1分钟内完成支付。如果下单用户未能在1分钟内完成支付，则该订单无效，同时该用户无法继续以折扣价下单。</p>
</blockquote>
<p>为了方便问题说明，下单和支付等功能合并在<code>trade</code>，产生的相关数据则存储于<code>DB</code>。简化之后的架构如下所示：</p>
<p><img src="/2020/05/29/problem-caused-by-timestamp-s-difference-in-cluster-and-analysis/1.png" alt></p>
<p>当<code>trade</code>为单机部署时，不会存在问题。但是当<code>trade</code>作为集群部署时，则会存在集群时间戳不一致导致用户支付失败的问题。具体如下所示：</p>
<p><img src="/2020/05/29/problem-caused-by-timestamp-s-difference-in-cluster-and-analysis/2.png" alt></p>
<p>如图所示，<code>m1</code>和<code>m2</code>的时间戳是一致的，但是<code>m3</code>的时间戳比其它机器正好快了<strong>60s</strong>。因此，如果<code>支付</code>的流量由<code>m3</code>机器的<code>trade</code>处理，则即便是在1分钟内支付，因为<code>m3</code>机器的时间戳快60s而导致支付超时，进而导致用户支付失败，影响用户体验。</p>
<p>这就是我们要讲的：在一个集群中，部分机器的<code>时间戳</code>和其它机器不一致而导致的重大问题。</p>
<h2 id="问题如何解决">问题如何解决</h2>
<p>在不修改系统架构的前提下，则可以利用同一时钟同步集群中所有机器的时钟，从而让集群的时钟保持同步，进而解决该问题。具体的方案如下图所示。</p>
<p><img src="/2020/05/29/problem-caused-by-timestamp-s-difference-in-cluster-and-analysis/3.png" alt></p>
<h3 id="ntp">ntp</h3>
<p>对Linux而言，可以使用<a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" target="_blank" rel="noopener"><code>ntp</code></a>来实现集群的时间同步。</p>
<p>同步时间，可以使用<code>ntpdate</code>命令，也可以使用<code>ntpd</code>服务。</p>
<h3 id="ntpdate">ntpdate</h3>
<p>使用<code>ntpdate</code>比较简单。格式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ntpdate [-nv] [NTP IP&#x2F;hostname]</span><br><span class="line">$ ntpdate 192.168.0.1</span><br><span class="line">$ ntpdate time.ntp.org</span><br></pre></td></tr></table></figure>
<p><code>ntpdate</code>只是强制将系统时间设置为ntp服务器时间。如果机器cpu tick有问题，这种同步治标不治本。此时，一般配合<code>cron</code>任务来定期同步。例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0 12 * * * * &#x2F;usr&#x2F;sbin&#x2F;ntpdate 192.168.0.1</span><br></pre></td></tr></table></figure>
<h3 id="ntpd">ntpd</h3>
<p>使用<code>ntpd</code>服务，要好于使用<code>ntpdate+cron</code>。</p>
<p><code>ntpdate</code>同步时间，会造成时间的跳跃，对一些依赖时间的程序和服务会造成影响，比如sleep，timer等。</p>
<p><code>ntpd</code>服务可以在修正时间的同时，修正cpu tick。</p>
<p>理想的做法为，在开机的时候，使用<code>ntpdate</code>强制同步时间，在其他时候使用<code>ntpd</code>服务来同步时间。</p>
<p>需要注意的是，<code>ntpd</code>有一个自我保护设置: 如果本机时间与源时间相差太大, 则<code>ntpd</code>不运行。所以新设置的时间服务器一定要先利用<code>ntpdate</code>命令获取初始时间, 然后启动<code>ntpd</code>服务。</p>
<p>关于ntpd的使用，网上已经有很多资料了，这里就不做过多的介绍了。</p>
<h3 id="ntpstat">ntpstat</h3>
<p><code>ntpstat</code>用于显示网络时间的同步状态。<code>ntpstat</code>会给出本地计算机上运行的<code>ntpd</code>的同步状态。如果本地系统与参考时间源同步，则<code>ntpstat</code>会给出近似的时间精度。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ntpstat</span><br><span class="line">synchronised to NTP server (192.168.0.1) at stratum 3</span><br><span class="line">   time correct to within 43 ms</span><br><span class="line">   polling server every 1024 s</span><br></pre></td></tr></table></figure>
<h2 id="问题引申">问题引申</h2>
<p>虽然可以利用<code>ntp</code>来同步集群时间，但是有一个问题是值的思考的：<strong>如何在集群时钟不同的情况下，解决<a href="#%E6%97%B6%E9%97%B4%E6%88%B3%E4%B8%8D%E4%B8%80%E8%87%B4%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98">时间戳不一致带来的问题</a>一节中描述的问题</strong>。</p>
<p>系统在架构上要做何种优化，才能避免业务对集群时钟同步的依赖？而这种优化所带来的系统架构的复杂度和成本又将如何？</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>ntp</tag>
        <tag>时间戳不同步</tag>
      </tags>
  </entry>
  <entry>
    <title>软件的熵和破窗原理</title>
    <url>/2020/05/20/Software-Entropy-and-A-Broken-Window/</url>
    <content><![CDATA[<blockquote>
<p><strong>如下的内容，摘选自《程序员修炼之道——通向务实的最高境界（第二版）》。</strong></p>
</blockquote>
<p>虽然软件开发不受绝大多数物理法则的约束，但我们无法躲避来自“熵”的增加的重击。“熵”是一个物理学术语，它定义了一个系统的“无序”总量。不幸的是，热力学法则决定了宇宙中的熵会趋向最大化。当软件中的无序化增加时，程序员会说“软件在腐烂”。有些人可能会用更乐观的术语来称呼它，即“技术债”，潜台词是说他们总有一天会偿还的——恐怕不会还了。</p>
<p><img src="/2020/05/20/Software-Entropy-and-A-Broken-Window/1.png" alt></p>
<a id="more"></a>
<p>不过不管叫什么名字，债务和腐烂都可能失控地蔓延开。</p>
<p>有很多因素会导致软件腐烂。最重要的一个似乎是项目工作中的心理性状态，或者说文化。即使是一个单人团队，你的项目的心理性状态也是个非常脆弱的东西。即使有最合理的计划和最佳的人员，项目还是可能在生命周期中逐步荒废、腐烂。但也有一些项目在经历了巨大的困难、持续不断的挫折之后，成功地对抗了天然的无序化倾向，走出了困境。</p>
<p>是什么造成了差异？</p>
<p>在城市中心，有些建筑干净漂亮，而另一些则破落不堪。为什么会这样？一些犯罪和城市衰败领域的研究人员发现了一个有趣的触发机制，只需一样东西就能非常迅速地把一幢干净完好的宜居建筑变成一个破败的废弃物。</p>
<h2 id="破窗原理">破窗原理</h2>
<p>一扇破损的窗户，只要一段时间不去修理，建筑中的居民就会潜移默化地产生一种被遗弃的感觉——当权者不关心这幢建筑的感觉。然后，其他的窗户也开始损坏，居民开始乱丢废物，墙上开始出现涂鸦，建筑开始出现严重的结构性损坏。在看上去很短的时间内，建筑的损坏程度就足以打消业主们想修好它的期望，被遗弃的感觉终变成了现实。</p>
<p><img src="/2020/05/20/Software-Entropy-and-A-Broken-Window/2.jpeg" alt></p>
<p>为何造成这样的影响？</p>
<p><strong>心理学家的研究表明，绝望是会传染的，就像狭窄空间中的流感病毒。无视一个明显损坏的东西，会强化这样一种观念：看来没有什么是能修好的，也没人在乎，一切都命中注定了。所有的负面情绪会在团队成员间蔓延，变成恶性循环。</strong></p>
<h2 id="不要放任破窗">不要放任破窗</h2>
<p><strong>不要搁置“破窗”(糟糕的设计、错误的决定、低劣的代码）不去修理。</strong></p>
<p>每发现一个就赶紧修一个。如果没有足够的时间完全修好，那么就把它钉起来。也许你可以注释掉那些糟糕的代码，显示一行“尚未实现”的信息，或用假数据先替代一下。采取行动，预防进一步的损害发生，表明一切尽在你的掌握中。</p>
<p>现在我们了解了一旦窗户开始破裂，运转良好的干净系统会迅速恶化。还有一些其他因素会导致软件腐烂，我们将在别处探讨，但与其他任何因素相比，漠视会加速腐烂的过程。</p>
<p>你或许会觉得，没人有时间来来回回清理项目中所有的碎玻璃。如果你真这么想，劝你还是趁早多想想怎么料理这个项目的后事，或是直接离开是非之地。</p>
<p>不要让熵赢得胜利。</p>
<h2 id="先勿伤害">先勿伤害</h2>
<p>多年以前，Andy认识一个土豪。他的房子富丽堂皇，屋子里摆满了无价的古董，到处陈列着精美的艺术品。有一天，一张挂毯因为离客厅壁炉太近而着火了。消防员奋勇冲进去救民于水火，当然主要是火。但是在把巨大的水管拖进屋子前，他们停了下来——尽管里面火势紧急——消防员毅然选择先在前门和火源之间铺上垫子，因为他们觉得水管太脏。</p>
<p>他们不想弄坏地毯。</p>
<p>现在听起来这很偏激。消防部门的首要任务当然是灭火，何必管过程中的那些附带损害呢？但是，他们在清醒地评估了形势后，出于对自己控制这场火势能力的绝对自信，还是尽力兼顾了不对财物造成不必要的毁害。</p>
<p>这也是软件开发中应该遵循的方法：<strong>不要只是因为一些东西非常危急，就去造成附带损害。破窗一扇都嫌太多</strong>。</p>
<p><img src="/2020/05/20/Software-Entropy-and-A-Broken-Window/3.jpg" alt></p>
<p><strong>一扇破窗——一段设计情糕的代码，一个让团队在整个项目周期内都必须要遵守的糟糕的管理决策——是一切衰退的开始。</strong></p>
<p>如果你发现自己正处在有几扇破窗的项目中，就非常容易陷入这样的想法——“反正代码所有其他部分都是一坨屎，我只是随大流而已。”</p>
<p>项目在这个时间点之前是否一直良好运行并不重要。在最初启发“破窗理论”的实验中，一辆废弃的汽车完好无损地停放了一个星期。但是一旦有一块玻璃被打破，这辆车在几个小时内就会被扒光并翻了个底朝天。</p>
<p><strong>出于同样原因，如果身处一个健康团队，你们项目的代码如此完美——编写清晰、设计优良、简洁优雅——你就会倾向于格外地小心，不把它弄糟。</strong> 就像那些消防员一样，即使屋内火势熊熊（截止时限、发行日期、销售演示，等等），你也不想成为第一个弄乱它、造成附带损害的人。反之，这个项目就会从某一扇破窗（糟糕的设计，混乱的代码……）开始衰退，腐烂……</p>
<p>一定要告诉自己，“不要打破窗户”。</p>
]]></content>
      <categories>
        <category>软件理论</category>
      </categories>
      <tags>
        <tag>技术债</tag>
        <tag>荐书</tag>
      </tags>
  </entry>
  <entry>
    <title>matplotlib的backends以及非交互式绘图</title>
    <url>/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/</url>
    <content><![CDATA[<p>在分析视频的psnr时，需要用到<code>matplotlib</code>来绘制视频每一帧的psnr。在Mac调试的时候可以正常生成如下所示的psnr趋势图：</p>
<p><img src="/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/1.png" alt></p>
<p>但是将应用部署到linux机器的时候，却提示**ModuleNotFoundError: No module named ‘_tkinter’**的错误。</p>
<a id="more"></a>
<p>具体如下图所示：</p>
<p><img src="/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/2.jpg" alt></p>
<p>请教了同事后采用如下的方式解决了问题：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import matplotlib </span><br><span class="line">matplotlib.use(&#39;Agg&#39;)</span><br><span class="line">import matplotlib.pyplot as plt</span><br></pre></td></tr></table></figure>
<p><img src="/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/3.jpg" alt></p>
<p>虽然解决了问题，但是当时没有明白：</p>
<ul>
<li>问题究竟是如何解决的？</li>
<li>为什么这样就可以解决？</li>
<li>解决方案和之前的写法的差异在哪里？</li>
</ul>
<p>因此查阅了matplotlib的文档，然后就有了该文接下来的内容。为了保证材料的原汁原味，如下的内容均摘录自<a href="https://matplotlib.org/3.2.1/tutorials/introductory/usage.html#backends" target="_blank" rel="noopener">matplotlib的开发文档</a>。</p>
<h2 id="matplotlib中backend的概念">matplotlib中backend的概念</h2>
<p>A lot of documentation on the website and in the mailing lists refers to the <strong>“backend”</strong> and many new users are confused by this term. matplotlib targets many different use cases and output formats. Some people use matplotlib interactively from the python shell and have plotting windows pop up when they type commands. Some people run Jupyter notebooks and draw inline plots for quick data analysis. Others embed matplotlib into graphical user interfaces like wxpython or pygtk to build rich applications. Some people use matplotlib in batch scripts to generate postscript images from numerical simulations, and still others run web application servers to dynamically serve up graphs.</p>
<p><strong>To support all of these use cases, matplotlib can target different outputs, and each of these capabilities is called a backend; the “frontend” is the user facing code, i.e., the plotting code, whereas the “backend” does all the hard work behind-the-scenes to make the figure.</strong></p>
<p>There are two types of backends:</p>
<ul>
<li>user interface backends (for use in pygtk, wxpython, tkinter, qt4, or macosx; also referred to as <code>&quot;interactive backends&quot;</code>). The interactive backends: GTK3Agg, GTK3Cairo, MacOSX, nbAgg, Qt4Agg, Qt4Cairo, Qt5Agg, Qt5Cairo, TkAgg, TkCairo, WebAgg, WX, WXAgg, WXCairo.</li>
<li>hardcopy backends to make image files (PNG, SVG, PDF, PS; also referred to as <code>&quot;non-interactive backends&quot;</code>). The non-interactive backends: agg, cairo, pdf, pgf, ps, svg, template.</li>
</ul>
<h2 id="matplotlib中backend的默认配置">matplotlib中backend的默认配置</h2>
<p>By default, <strong>Matplotlib should automatically select a default backend which allows both interactive work and plotting from scripts</strong>, with output to the screen and/or to a file, so at least initially you will not need to worry about the backend. <strong>The most common exception is if your Python distribution comes without tkinter and you have no other GUI toolkit installed; this happens on certain Linux distributions</strong>, where you need to install a Linux package named python-tk (or similar).</p>
<p>If, however, you want to write graphical user interfaces, or a web application server, or need a better understanding of what is going on, read on. To make things a little more customizable for graphical user interfaces, matplotlib separates the concept of the renderer (the thing that actually does the drawing) from the canvas (the place where the drawing goes). The canonical renderer for user interfaces is Agg which uses the Anti-Grain Geometry C++ library to make a raster (pixel) image of the figure; it is used by the Qt5Agg, Qt4Agg, GTK3Agg, wxAgg, TkAgg, and macosx backends. An alternative renderer is based on the Cairo library, used by Qt5Cairo, Qt4Cairo, etc.</p>
<h2 id="interactive模式的概念">interactive模式的概念</h2>
<p>Use of an interactive backend (see What is a backend?) permits–but does not by itself require or ensure–plotting to the screen. Whether and when plotting to the screen occurs, and whether a script or shell session continues after a plot is drawn on the screen, depends on the functions and methods that are called, and on a state variable that determines whether matplotlib is in “interactive mode”. The default Boolean value is set by the matplotlibrc file, and may be customized like any other configuration parameter (see Customizing Matplotlib with style sheets and rcParams). It may also be set via matplotlib.interactive(), and its value may be queried via matplotlib.is_interactive(). Turning interactive mode on and off in the middle of a stream of plotting commands, whether in a script or in a shell, is rarely needed and potentially confusing, so in the following we will assume all plotting is done with interactive mode either on or off.</p>
<p>Interactive mode may also be turned on via matplotlib.pyplot.ion(), and turned off via matplotlib.pyplot.ioff().</p>
<p><strong>In interactive mode, pyplot functions automatically draw to the screen.</strong> When plotting interactively, if using object method calls in addition to pyplot functions, then call draw() whenever you want to refresh the plot.</p>
<p>Use non-interactive mode in scripts in which you want to generate one or more figures and display them before ending or generating a new set of figures. In that case, use show() to display the figure(s) and to block execution until you have manually destroyed them.</p>
<h2 id="如何选择backend">如何选择backend</h2>
<p>There are three ways to configure your backend:</p>
<ul>
<li>The <code>rcParams[&quot;backend&quot;]</code> (default: ‘agg’) parameter in your matplotlibrc file</li>
<li>The <code>MPLBACKEND</code> environment variable</li>
<li>The function <code>matplotlib.use()</code></li>
</ul>
<p>A more detailed description is given below.</p>
<p>If multiple of these are configurations are present, the last one from the list takes precedence; e.g. calling <code>matplotlib.use()</code> will override the setting in your matplotlibrc.</p>
<p>If no backend is explicitly set, Matplotlib automatically detects a usable backend based on what is available on your system and on whether a GUI event loop is already running. On Linux, if the environment variable <code>DISPLAY</code> is unset, the “event loop” is identified as “headless”, which causes a fallback to a noninteractive backend (agg).</p>
<p>Here is a detailed description of the configuration methods:</p>
<ol>
<li>Setting <code>rcParams[&quot;backend&quot;]</code> (default: ‘agg’) in your matplotlibrc file:</li>
</ol>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">backend : qt5agg   # use pyqt5 with antigrain (agg) rendering</span><br></pre></td></tr></table></figure>
<p>See also Customizing Matplotlib with style sheets and rcParams.</p>
<ol start="2">
<li>Setting the <code>MPLBACKEND</code> environment variable:</li>
</ol>
<p>You can set the environment variable either for your current shell or for a single script.</p>
<p>On Unix:</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; export MPLBACKEND&#x3D;qt5agg</span><br><span class="line">&gt; python simple_plot.py</span><br><span class="line"></span><br><span class="line">&gt; MPLBACKEND&#x3D;qt5agg python simple_plot.py</span><br></pre></td></tr></table></figure>
<p>On Windows, only the former is possible:</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; set MPLBACKEND&#x3D;qt5agg</span><br><span class="line">&gt; python simple_plot.py</span><br></pre></td></tr></table></figure>
<p>Setting this environment variable will override the backend parameter in any matplotlibrc, even if there is a matplotlibrc in your current working directory. Therefore, setting MPLBACKEND globally, e.g. in your .bashrc or .profile, is discouraged as it might lead to counter-intuitive behavior.</p>
<ol start="3">
<li>If your script depends on a specific backend you can use the function <code>matplotlib.use()</code>:</li>
</ol>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import matplotlib</span><br><span class="line">matplotlib.use(&#39;qt5agg&#39;)</span><br></pre></td></tr></table></figure>
<p>This should be done before any figure is created; otherwise Matplotlib may fail to switch the backend and raise an ImportError.</p>
<p>Using use will require changes in your code if users want to use a different backend. Therefore, you should avoid explicitly calling use unless absolutely necessary.</p>
<h2 id="matplotlib-use-agg-的作用">matplotlib.use(‘Agg’)的作用</h2>
<p>在介绍完整整体的matplotlib中的backends以及matplotlib中的绘图模式之后，就能明白为什么文章开始出现的迁移过程中会出现类似的错误。</p>
<p>首先根据<a href="#matplotlib%E4%B8%ADbackend%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE">matplotlib中backend的默认配置</a>中的介绍可以知道，matplotlib会有一个默认的backend配置，并且该默认的backend会同时支持交互式绘图模式以及利用脚本绘图的模式。并且，交互式绘图还需要利用GUI工具来生成一个屏幕绘图的窗口。而迁移的Linux机器上缺乏tkinter这样的GUI工具，因此在<code>import matplotlib.pyplot as plt</code>的时候会产生错误。</p>
<p>而利用<code>matplotlib.use('Agg')</code>可以切换matplotlib的backend，将其backend从默认的交互式模式切换为非交互式模式，此时，生成的图形会以图片的形式保存起来，而无需tkinter这样的GUI工具的支持，因此可以解决本文最开始出现的问题。</p>
]]></content>
      <categories>
        <category>matplotlib</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>matplotlib</tag>
        <tag>non-interactive rendering</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Wireshark分析SRT直播流</title>
    <url>/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/</url>
    <content><![CDATA[<p><a href="https://www.haivision.com/products/srt-secure-reliable-transport/" target="_blank" rel="noopener">SRT(Secure Reliable Transport)</a>是一种基于<a href="https://tools.ietf.org/html/draft-gg-udt-03" target="_blank" rel="noopener">UDT(UDP-based Data Transfer)</a>的、安全的、可靠的、开源的数据传输协议&amp;技术。SRT在UDP基础之上实现了：智能数据重传机制和AES256加密技术，这使得其成为一种安全、可靠、低延迟的传输技术。利用SRT，可以实现在不可预测的网络环境下（例如互联网）高效、安全的传输数据。<a href="https://github.com/Haivision/srt/" target="_blank" rel="noopener">SRT</a>还做了特殊优化以适合视频实时流数据的传输。根据<a href="https://www.srtalliance.org/srt-alliance-announces-the-addition-of-the-srt-low-latency-protocol-to-open-broadcaster-softwares-obs-studio/" target="_blank" rel="noopener">SRT Alliance</a>在2019-04-04的介绍，目前如下的应用已经集成并支持SRT：<a href="https://obsproject.com/" target="_blank" rel="noopener">OBS Studio</a>，<a href="https://www.videolan.org/vlc/" target="_blank" rel="noopener">VideoLAN’s VLC</a>，<a href="http://ffmpeg.org/" target="_blank" rel="noopener">FFMpeg</a>，<a href="https://www.wireshark.org/" target="_blank" rel="noopener">Wireshark</a>。</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/1.png" alt></p>
<a id="more"></a>
<p>本文只介绍：<strong>如何利用FFMpeg生成SRT数据流并利用Wireshark对该SRT数据进行抓包分析</strong>。关于SRT的详细内容，可以参考<a href="https://github.com/Haivision/srt/files/2489142/SRT_Protocol_TechnicalOverview_DRAFT_2018-10-17.pdf" target="_blank" rel="noopener">SRT Protocol Technical Overview Draft</a>。</p>
<h2 id="前期准备">前期准备</h2>
<ol>
<li>
<p>按照<a href="https://github.com/Haivision/srt/blob/master/README.md" target="_blank" rel="noopener">说明</a>安装SRT</p>
</li>
<li>
<p>利用<code>./configure --enable-libsrt</code>重新编译FFMpeg，让ffmpeg工具集支持SRT协议。重新configure的过程如果遇到<code>ERROR: srt &gt;= 1.3.0 not found using pkg-config</code>的错误，可以查看<code>ffbuild/config.log</code>的相关信息，一般需要把srt和srt所依赖的openssl的<strong>pkgconfig</strong>路径增加到<code>PKG_CONFIG_PATH</code>环境变量中即可。</p>
</li>
<li>
<p>升级Wireshark到3.0之后的版本，并且设置Wireshark取消Wireshark对UDT协议的支持，具体做法为：点击菜单栏中的<code>Analyze</code>-&gt;<code>Enabled Protocols</code>，然后从弹出的支持协议中找到UDT，并取消UDT前面的选择标记。</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/2.jpg" alt></p>
</li>
<li>
<p>安装VLC播放器，用于播放SRT协议的视频流。</p>
</li>
</ol>
<h2 id="生成srt直播流">生成SRT直播流</h2>
<p>可以利用<code>ffmpeg</code>和<code>srt-live-transmit</code>（该工具在安装srt的时候会默认安装）来生成SRT直播流。主要思路是首先利用<code>ffmpeg</code>生成UDP的直播流，然后利用<code>srt-live-transmit</code>把UDP的直播流转换成SRT的直播流，更详细的方式可以参考<a href="https://github.com/Haivision/srt/blob/master/docs/srt-live-transmit.md" target="_blank" rel="noopener">srt-live-transmit的使用说明</a>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 生成UDP视频流</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -f lavfi -re -i smptebars=duration=300:size=1280x720:rate=30 \</span></span><br><span class="line">-f lavfi -re -i sine=frequency=1000:duration=60:sample_rate=44100 \</span><br><span class="line">-pix_fmt yuv420p -c:v libx264 -b:v 1000k -g 30 -keyint_min 120 \</span><br><span class="line">-profile:v baseline -preset veryfast -f mpegts \</span><br><span class="line">"udp://127.0.0.1:5000?pkt_size=1316"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成SRT视频流</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> srt-live-transmit -s:10 udp://:5000 srt://:5001</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用ffplay播放SRT视频流</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ffplay <span class="string">"srt://127.0.0.1:5001"</span></span></span><br></pre></td></tr></table></figure>
<p>具体播放效果如下所示：</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/3.jpg" alt></p>
<h2 id="使用wireshark分析srt">使用Wireshark分析SRT</h2>
<p>为了可以用Wireshark抓到SRT数据包，需要使用VLC播放器来打开刚才创建的SRT视频流，具体如下所示：</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/4.jpg" alt></p>
<p>打开Wireshark，选择Lookback（因为要捕获的SRT地址为127.0.0.1），然后在捕获的数据窗口选择srt协议过滤，稍等片刻就可以看到捕获的SRT数据包，具体如下图所示：</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/5.jpg" alt></p>
<p>接下来就可以利用Wireshark来分析SRT协议的处理流程，例如上图中的Handshake数据包。尤其是在学习的过程中，配合<a href="https://github.com/Haivision/srt/files/2489142/SRT_Protocol_TechnicalOverview_DRAFT_2018-10-17.pdf" target="_blank" rel="noopener">SRT的协议文档</a>以及Wireshark的抓包分析，能够加深对SRT协议的理解，达到事半功倍的效果。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>Wireshark</tag>
        <tag>SRT</tag>
        <tag>网络协议分析</tag>
      </tags>
  </entry>
  <entry>
    <title>macOS Catalina的strip版本异常导致编译的FFMpeg运行被kill</title>
    <url>/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/</url>
    <content><![CDATA[<p>因为近期正在调研&amp;了解<a href="https://github.com/Haivision/srt" target="_blank" rel="noopener">SRT协议</a>的相关内容，为了方便，需要打开FFMpeg的<code>--enable-libsrt</code>功能并重新编译FFMpeg，从而保证FFMpeg支持SRT协议。但是重新编译之后却发现启动ffmpeg工具就会被内核杀死，具体如下所示。</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/1.jpg" alt></p>
<a id="more"></a>
<p>利用<em>lldb</em>调试该<em>ffmpeg</em>发现直接提示<code>error: Malformed Mach-o file</code>的错误，具体如下：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/2.jpg" alt></p>
<p>编译异常的Mac版本和Xcode版本信息分别如下：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/3.jpg" alt></p>
<p>查阅了<a href="https://trac.ffmpeg.org/ticket/8073" target="_blank" rel="noopener">网上的资料</a>，也查看了<a href="https://github.com/Homebrew/homebrew-core/blob/master/Formula/ffmpeg.rb" target="_blank" rel="noopener">brew编译FFMpeg的指令</a>，原因可能是：<strong>Xcode11下clang默认开启-fstack-check</strong>。</p>
<p>同时，在如下图所示的Xcode 10.3版本的Mac上则可编译成功：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/4.jpg" alt></p>
<p>因此根据如上信息：<code>./configure</code>时需要增加<code>--host-cflags=-fno-stack-check</code>配置。</p>
<p>但是增加该配置之后，编译出的ffmpeg依然无法正常运行。</p>
<h2 id="发现原因">发现原因</h2>
<p><strong>恰好最近升级了系统和Xcode版本，想着再编译一下看下是否可用，终于有了新的发现。</strong></p>
<p>编译的系统版本和Xcode版本如下所示：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/5.jpg" alt></p>
<p>编译命令如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> .&#x2F;configure --enable-shared --enable-pthreads --enable-version3 --enable-avresample \</span><br><span class="line">--cc&#x3D;clang --host-cflags&#x3D; --host-ldflags&#x3D; --enable-ffplay --enable-gnutls --enable-gpl \</span><br><span class="line">--enable-libaom --enable-libbluray --enable-libmp3lame --enable-libopus \</span><br><span class="line">--enable-librubberband --enable-libsnappy --enable-libtesseract --enable-libtheora \</span><br><span class="line">--enable-libvidstab --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 \</span><br><span class="line">--enable-libx265 --enable-libxvid --enable-lzma --enable-libfontconfig --enable-libfreetype \</span><br><span class="line">--enable-frei0r --enable-libass --enable-libopencore-amrnb --enable-libopencore-amrwb \</span><br><span class="line">--enable-libopenjpeg --enable-librtmp --enable-libspeex --enable-libsoxr \</span><br><span class="line">--enable-videotoolbox --disable-libjack --disable-indev&#x3D;jack</span><br></pre></td></tr></table></figure>
<p>编译之后，惊喜的发现，虽然<code>ffprobe</code>命令依旧异常，但是<code>ffprobe_g</code>命令已经可以使用了。具体如下图所示：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/6.jpg" alt></p>
<p><code>ffprobe</code>和<code>ffprobe_g</code>的不同就是<code>ffprobe_g</code>会包含调试信息。</p>
<p>回顾编译指令的最后几条指令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LD ffmpeg_g</span><br><span class="line">LD ffprobe_g</span><br><span class="line">LD ffplay_g</span><br><span class="line">STRIP ffmpeg</span><br><span class="line">STRIP ffprobe</span><br><span class="line">STRIP ffplay</span><br></pre></td></tr></table></figure>
<p>可以发现，在编译的最后，使用<code>strip</code>命令，去掉了<code>ffprobe</code>中的调试信息。那么是否是<code>strip</code>命令有问题呢？</p>
<p>带着这个疑问，写了一段测试代码<code>test.cpp</code>：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Hello World!"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>clang++</code>编译并对比利用<code>strip</code>命令去掉调试信息前后的运行结果，终于发现了问题所在：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/7.jpg" alt></p>
<p>至此，终于找到原因：<code>strip</code>命令生成的无调试信息的可执行程序，会发生<code>Malformed Mach-o file</code>的现象。</p>
<h2 id="修正strip版本">修正strip版本</h2>
<p>怀疑机器上的<code>strip</code>版本异常导致去掉调试信息后的可执行文件出现异常。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ which strip</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;opt&#x2F;binutils&#x2F;bin&#x2F;strip</span><br><span class="line">$ which clang++</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;clang++</span><br><span class="line">$ ls &#x2F;usr&#x2F;bin&#x2F;strip</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;strip</span><br><span class="line">$ &#x2F;usr&#x2F;bin&#x2F;strip -x a.out</span><br><span class="line">$ .&#x2F;a.out</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>
<p>经过如上的过程发现，确实是<code>strip</code>的版本有问题，利用<code>/usr/bin/strip</code>生成的无调试信息的可执行程序是正常的。</p>
<h2 id="问题解决">问题解决</h2>
<p>在编译ffmpeg时，利用<code>--strip</code>选项来指定<code>strip</code>的版本。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> .&#x2F;configure --enable-shared --enable-pthreads --enable-version3 --enable-avresample \</span><br><span class="line">--cc&#x3D;clang --host-cflags&#x3D; --host-ldflags&#x3D; --enable-ffplay --enable-gnutls --enable-gpl \</span><br><span class="line">--enable-libaom --enable-libbluray --enable-libmp3lame --enable-libopus \</span><br><span class="line">--enable-librubberband --enable-libsnappy --enable-libtesseract --enable-libtheora \</span><br><span class="line">--enable-libvidstab --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 \</span><br><span class="line">--enable-libx265 --enable-libxvid --enable-lzma --enable-libfontconfig --enable-libfreetype \</span><br><span class="line">--enable-frei0r --enable-libass --enable-libopencore-amrnb --enable-libopencore-amrwb \</span><br><span class="line">--enable-libopenjpeg --enable-librtmp --enable-libspeex --enable-libsoxr \</span><br><span class="line">--enable-videotoolbox --disable-libjack --disable-indev&#x3D;jack \</span><br><span class="line">--strip&#x3D;&#x2F;usr&#x2F;bin&#x2F;strip</span><br></pre></td></tr></table></figure>
<p>大功告成，问题解决，具体如下所示：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/8.jpg" alt></p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFMpeg</tag>
        <tag>编译</tag>
        <tag>macOS Catalina</tag>
        <tag>strip</tag>
      </tags>
  </entry>
  <entry>
    <title>Android环境下编译libyuv</title>
    <url>/2020/03/30/compile-libyuv-for-Android/</url>
    <content><![CDATA[<p>libyuv是Google开源的实现各种YUV格式与RGB格式之间相互转换、旋转、缩放的库。关于libyuv的具体介绍可以参考<a href="https://chromium.googlesource.com/libyuv/libyuv" target="_blank" rel="noopener">官网介绍</a>。</p>
<a id="more"></a>
<h2 id="android-studio编译libyuv">Android Studio编译libyuv</h2>
<p>在自己编译libyuv的过程中，遇到了很多坑。在解决这些坑的过程中发现，从网上查询的很多资料并没有对问题的解决提供帮助。因此，在自己趟过了所有的坑之后，就想把编译libyuv的过程整理了出来，一方面是做一个梳理和总结，另一方面也希望帮助更多有类似需求的人。</p>
<p>接下来，开始介绍在Android平台上，利用NKD编译包含libjpeg库的libyuv库。这个主要通过<a href="https://chromium.googlesource.com/libyuv/libyuv/+/refs/heads/master/Android.mk" target="_blank" rel="noopener">libyuv/Android.mk</a>中的如下代码实现：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">LOCAL_WHOLE_STATIC_LIBRARIES :&#x3D; libyuv_static</span><br><span class="line">LOCAL_MODULE :&#x3D; libyuv</span><br><span class="line">ifneq ($(LIBYUV_DISABLE_JPEG), &quot;yes&quot;)</span><br><span class="line">LOCAL_SHARED_LIBRARIES :&#x3D; jpeg</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">include $(BUILD_SHARED_LIBRARY)</span><br></pre></td></tr></table></figure>
<h2 id="需要下载的库">需要下载的库</h2>
<ul>
<li><a href="https://chromium.googlesource.com/libyuv/libyuv" target="_blank" rel="noopener">libyuv</a>或者<a href="https//github.com/lemenkov/libyuv.git">libyuv</a></li>
<li><a href="https://github.com/libjpeg-turbo/libjpeg-turbo.git" target="_blank" rel="noopener">libjpeg-turbo</a></li>
</ul>
<h2 id="编译依赖">编译依赖</h2>
<h3 id="ndk">NDK</h3>
<p>因为NDK-r17之后的版本，不支持gcc编译so，需要使用clang来编译so库。因此编译时，需要确定好自己的NDK版本。</p>
<h3 id="cmake-nasm-gcc等">CMAKE, NASM, GCC等</h3>
<p>该部分编译依赖为编译libjpeg-turbo库的编译依赖，具体可以参见libjpeg-turbo的<a href="https://github.com/libjpeg-turbo/libjpeg-turbo/blob/master/BUILDING.md" target="_blank" rel="noopener">BUILD.md</a></p>
<h2 id="编译libjpeg-turbo">编译libjpeg-turbo</h2>
<ol>
<li>
<p>下载编译脚本，编译脚本位于<a href="https://github.com/wangwei1237/libyuv-with-jpeg/tree/master/libjpeg-turbo" target="_blank" rel="noopener">libjpeg-turbo</a>目录下，共计有三个脚本：</p>
<ol>
<li><a href="http://config.sh" target="_blank" rel="noopener">config.sh</a>：配置编译参数，例如ANDROID_NDK_ROOT等，需要根据自己的环境变量进行替换。</li>
<li>build_jpeg.sh：编译某个CPU架构的so库，该脚本中的变量一般不需要修改。</li>
<li>build_jpeg_all.sh：编译所有CPU架构的so库</li>
</ol>
</li>
<li>
<p>下载<a href="https://github.com/libjpeg-turbo/libjpeg-turbo" target="_blank" rel="noopener">libjpeg-turbo</a>源码：<code>git clone https://github.com/libjpeg-turbo/libjpeg-turbo.git</code>。</p>
</li>
<li>
<p>将第<em>1</em>步中下载到的三个文件复制到libjepg-turob源码的根目录下：<code>cp -r libjpeg-turbo/* JPEG_SRC_ROOT_PATH/</code>。</p>
</li>
<li>
<p>修改<em><a href="http://config.sh" target="_blank" rel="noopener">config.sh</a></em>中的<code>ANDROID_NDK_ROOT</code>为自己的NDK路径，修改<code>ANDROID_NDK_VERSION</code>为对应的数字版本。例如<em>r16b</em>版本的为<code>ANDROID_NDK_VERSION=16</code>。</p>
</li>
<li>
<p>运行<code>sh build_jpeg_all.sh</code>编译libjpeg-turbo，运行之后会在当前目录的<em>libs</em>目录下生成各种CPU架构对应的so库。如下图所示：</p>
<p><img src="/2020/03/30/compile-libyuv-for-Android/1.jpg" alt="图1. libjpeg-turbo编译产物"></p>
</li>
</ol>
<h2 id="编译libyuv">编译libyuv</h2>
<ol>
<li>
<p>将之前下载的libyuv的源码导入到Android Studio中的指定目录：PROJECT/app/jni/libyuv,该目录自己定义就可以。</p>
</li>
<li>
<p>将上一步生成的so文件按照ABI的格式复制到libyuv/libs目录下，如下图所示：</p>
<p><img src="/2020/03/30/compile-libyuv-for-Android/2.png" alt="图2"></p>
</li>
<li>
<p>修改libyuv目录下的Android.mk文件，<a href="https://github.com/wangwei1237/libyuv-with-jpeg/blob/master/myapp/jni/libyuv/Android.mk" target="_blank" rel="noopener">libyuv/Android.mk</a>文件中的第4~12行的内容即可。</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">########################################################</span><br><span class="line">## &#123;&#123;BEGIN 增加如下的代码</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_MODULE :&#x3D; jpeg</span><br><span class="line">LOCAL_SRC_FILES :&#x3D; libs&#x2F;$(TARGET_ARCH_ABI)&#x2F;libjpeg.so</span><br><span class="line">LOCAL_EXPORT_C_INCLUDES :&#x3D; $(LOCAL_PATH)&#x2F;include</span><br><span class="line">include $(PREBUILT_SHARED_LIBRARY)</span><br><span class="line">## END&#125;&#125;</span><br><span class="line">########################################################</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>按照<a href="https://github.com/wangwei1237/libyuv-with-jpeg" target="_blank" rel="noopener">仓库</a>所示的<a href="https://github.com/wangwei1237/libyuv-with-jpeg/tree/master/myapp/jni" target="_blank" rel="noopener">myapp/jni</a>目录下的<em><a href="http://Android.mk" target="_blank" rel="noopener">Android.mk</a></em>和<em><a href="http://Application.mk" target="_blank" rel="noopener">Application.mk</a></em>文件修改自己代码中的对应文件即可，主要是用于编译libyuv使用。</p>
</li>
<li>
<p>修改自己app目录下的<a href="https://github.com/wangwei1237/libyuv-with-jpeg/blob/master/myapp/build.gradle" target="_blank" rel="noopener">build.gradle</a>，在android{}中增加如下编译任务</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">externalNativeBuild &#123;</span><br><span class="line">    ndkBuild &#123;</span><br><span class="line">        path file(&#39;jni&#x2F;Android.mk&#39;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>点击Android Studio的编译按钮编译即可，编译后生成的编译产物如下图所示：</p>
<p><img src="/2020/03/30/compile-libyuv-for-Android/3.jpg" alt="图3. libyuv的编译产物"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>libyuv</tag>
      </tags>
  </entry>
  <entry>
    <title>图像金字塔简介</title>
    <url>/2020/03/18/introduction-to-image-pyramid/</url>
    <content><![CDATA[<h1>图像金字塔</h1>
<h2 id="图像金字塔的概念">图像金字塔的概念</h2>
<p>一般而言，我们处理的图像通常是恒定大小（分辨率）的图像。但是在某些特殊的场景下，需要处理同一图像的不同分辨率的图像。例如，在图像中搜索某些内容时（例如面部），由于不确定待搜索的内容在图像中的区域大小，因此需要创建一个具有不同分辨率的图像集，并在该图像集的所有图像中执行搜索操作。</p>
<p>这些具有不同分辨率的图像集称为“图像金字塔”。之所以称其为“图像金字塔”，是因为当这些图像按照分辨率由低到高堆叠在一起时，底部的最大图像和顶部的最小图像看起来就像是一座金字塔。</p>
<a id="more"></a>
<p>因此，图像金字塔是图像的集合，这些图像集合由单个原始图像通过连续的降采样——直到达到某个期望的暂停点为止——产生。</p>
<p><img src="/2020/03/18/introduction-to-image-pyramid/1.jpg" alt></p>
<h2 id="图像金字塔的分类">图像金字塔的分类</h2>
<p>应用中经常用到的图像金字塔主要有两种：</p>
<ul>
<li>高斯金字塔</li>
<li>拉普拉斯金字塔</li>
</ul>
<p>高斯金字塔一般用于图像的降采样，而拉普拉斯金字塔则用于通过图像金字塔中的低分辨率图像重构高分率图像的图像上采样。</p>
<h3 id="高斯金字塔">高斯金字塔</h3>
<p>高斯金字塔中的低分辨率图像是通过删除高分辨率图像中的行和列而产生，具体如下所示：</p>
<ul>
<li>令高斯金字塔中第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>层的图像为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>使用一个高斯核对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>执行卷积操作得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>G</mi><mi>i</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">G_i^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.010556em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>然后删除<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>G</mi><mi>i</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">G_i^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.010556em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span>中的偶数行和偶数列，得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">G_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>根据如上的步骤，可以知道，第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>级图像的分辨率是第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>级图像的分辨率的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。</p>
<h4 id="pyrdown">pyrDown</h4>
<p>在OpenCV中，可以使用<code>cv2.pyrDown()</code>生成图像的上一层级图像。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">higher_resolution = cv2.imread(<span class="string">'img.jpg'</span>)</span><br><span class="line">lower_resolution  = cv2.pyrDown(higher_resolution)</span><br></pre></td></tr></table></figure>
<p>下图是一个4级的高斯金字塔的例子。<br>
<img src="/2020/03/18/introduction-to-image-pyramid/2.jpg" alt></p>
<h4 id="pyrup">pyrUp</h4>
<p>我们还可以使用<code>cv2.pyrUp()</code>将图像转换为每个方向两倍大小的图像，该函数</p>
<ul>
<li>首先将图像的大小在各个维度上扩展2倍</li>
<li>然后对新增的行用0进行填充</li>
<li>最后再使用高斯滤波器执行卷积计算来获取“丢失”的像素的值</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">higher_resolution_2 = cv2.pyrUp(lower_resolution)</span><br></pre></td></tr></table></figure>
<p>从如上的步骤不难发现，<code>cv2.pyrUp()</code>并不是<code>cv2.pyrDown()</code>的逆运算，因为<code>cv2.pyrDown()</code>是一个丢失信息的操作，一旦分辨率降低，就会存在信息丢失。</p>
<p>因此，在示例代码中，<code>higher_resolution_2</code>和<code>higher_resolution</code>是不同的。</p>
<p>对<a href="#pyrDown">pyrDown</a>中的图像执行<code>pyrUp()</code>效果如下所示：<br>
<img src="/2020/03/18/introduction-to-image-pyramid/3.jpg" alt></p>
<h3 id="拉普拉斯金字塔">拉普拉斯金字塔</h3>
<p>为了从图像金字塔中的低分辨率图像恢复高分辨率的图像，需要使用下采样过程中丢弃的信息。而这些数据则构成了拉普拉斯金字塔。</p>
<p>令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为高斯金字塔的第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>级图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>下采样得到第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>级图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">G_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span>时丢失的信息，则：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub><mo>=</mo><msub><mi>G</mi><mi>i</mi></msub><mo>−</mo><mi>c</mi><mi>v</mi><mn>2.</mn><mi>p</mi><mi>y</mi><mi>r</mi><mi>U</mi><mi>p</mi><mo stretchy="false">(</mo><msub><mi>G</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L_i=G_i - cv2.pyrUp(G_{i+1})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord">2</span><span class="mord">.</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace linebreak="newline"></mspace><mrow><msub><mi>L</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mi>i</mi><mo>∈</mo><mn>1...</mn><mi>n</mi><mspace linebreak="newline"></mspace></mrow></mrow><annotation encoding="application/x-tex">\\{L_i | i \in 1...n\\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathdefault">n</span><span class="mspace newline"></span></span></span></span></span>则构成拉普拉斯金字塔。</p>
<p>拉普拉斯金字塔由高斯金字塔而形成，并没有其它的额外功能，并且拉普拉斯金字塔图像和图像的边缘图像很像。在拉普拉斯金字塔中的图像的大多数元素为零。一个4级拉普拉斯金字塔的图像如下所示（已调整图像的曝光度以增强图像内容）：<br>
<img src="/2020/03/18/introduction-to-image-pyramid/4.jpg" alt></p>
<h2 id="尺度空间和图像金字塔卷积核的选择">尺度空间和图像金字塔卷积核的选择</h2>
<p>在现实世界中，客观物体在不同尺度时有着不同的结构。这意味着，如果从不同的尺度去观察同一个物体，会得出不一样的结果。例如，从不同的距离观察同一个图像时，随着距离的不断缩小，能够观察到的图像的结构也有所不同。</p>
<p>观察一棵树的尺度和观察一片树叶的尺度也是不同的：观察一棵树的适当尺度应该是<strong>米</strong>，而观察一片叶子可能需要更细粒度的尺度才能得出较好的结果。</p>
<p>当计算机系统要对一个未知的场景进行分析时，并不能提前预知用什么样的尺度来描述图像信息中的<strong>interesting structures</strong>是最合适的。因此，唯一可行的方案就是将多个不同尺度的描述都考虑进来，以便捕获未知的尺度变化。</p>
<p>尺度空间理论和生物视觉之间也有着十分密切的联系。哺乳动物的视网膜以及视觉皮层第一阶段所记录的接受场的分布，与许多尺度空间操作都高度近似。</p>
<p>如<a href="#%E9%AB%98%E6%96%AF%E9%87%91%E5%AD%97%E5%A1%94">高斯金字塔</a>的描述，在生成高斯金字塔时，会采用高斯核(<em>filter</em>)对图像进行处理，那么为什么非要采用高斯核呢？</p>
<p>实际上，并非任何低通滤波器（<em>low-pass filter</em>）都可用于生成尺度空间。可用于生成尺度空间的filter必须满足如下的条件：</p>
<blockquote>
<p>由该平滑filter生成的粗尺度图像（高层图像）不会引入不存在于细尺度图像（低层图像）中的杂散结构。</p>
</blockquote>
<p>如上的条件的言外之意就是：给定粗尺度图像中的任何一个区域，细尺度图像上总能找到相应的区域。对这两个区域而言，粗尺度图像区域不能有新的结构。</p>
<p>受制于<a href="https://en.wikipedia.org/wiki/Scale-space_axioms" target="_blank" rel="noopener">尺度空间公理</a>，高斯卷积核是实现尺度变换的唯一线性核。因此，在图像金字塔中，需要采用高斯卷积核对图像进行处理。</p>
<p><a href="https://en.wikipedia.org/wiki/Scale-space_axioms" target="_blank" rel="noopener">尺度空间公理</a>需要满足如下的条件：</p>
<ul>
<li>线性</li>
<li>平移不变性</li>
<li>半群特性</li>
<li>旋转不变性</li>
<li>尺度不变性</li>
<li>正定性</li>
<li>正规性(积分为1)</li>
<li>不会引入新的极点</li>
<li>不会增强极点</li>
<li>存在无穷小的算子（可微性）</li>
</ul>
<h2 id="图像金字塔的应用">图像金字塔的应用</h2>
<p>图像金字塔的一种应用是图像融合。例如，在图像拼接中会将两个图像堆叠，但是由于图像之间的不连续性，这种对原始图像的直接拼接的效果并不好。例如，我们对如下图所示的两幅图像：</p>
<p><img src="/2020/03/18/introduction-to-image-pyramid/5.jpg" alt></p>
<p>的直接拼接效果和采用图像金字塔拼接效果分别为（左图为直接拼接）：</p>
<p><img src="/2020/03/18/introduction-to-image-pyramid/8.jpg" alt></p>
<p>由此可以看出，使用“图像金字塔”融合图像则可以让拼接之后的图像看起来天衣无缝。</p>
<p>可以按照如下的步骤使用“图像金字塔”来拼接如上的图像（<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/03/18/introduction-to-image-pyramid/image_pyramid_blend.ipynb" target="_blank" rel="noopener">玩转多尺度图像融合</a>)：</p>
<ol>
<li>加载图像</li>
<li>计算图像的高斯金字塔（在此示例中，级数为6）</li>
<li>从高斯金字塔中计算拉普拉斯金字塔</li>
<li>在每个拉普拉斯金字塔中加入苹果的左半部分和橙子的右半部分</li>
<li>最后，从联合图像金字塔中重建原始图像</li>
</ol>
<p>除了如上的<strong>多分辨率图像融合算法会用到图像金字塔</strong>之外，图像金字塔还可用于如下的场景：</p>
<ul>
<li>sift算法</li>
<li>在from coarse to fine由粗到精的搜索策略中都可以用金字塔</li>
<li>optical flow光流法</li>
<li>slam当中的姿态估计</li>
<li>……</li>
</ul>
]]></content>
      <categories>
        <category>视觉技术</category>
      </categories>
      <tags>
        <tag>图像金字塔</tag>
        <tag>高斯金字塔</tag>
        <tag>拉普拉斯金字塔</tag>
        <tag>image pyramid</tag>
      </tags>
  </entry>
  <entry>
    <title>数字视频基本概念</title>
    <url>/2020/03/03/digital-video-concept/</url>
    <content><![CDATA[<p>在学习和研究视频技术的过程中，联合几个同事一起翻译了<a href="https://link.springer.com/book/10.1007/978-1-4302-6713-3" target="_blank" rel="noopener">Digital Video Concepts, Methods, and Metrics: Quality, Compression, Performance, and Power Trade-off Analysis</a>，形成了<a href="/digital-video-concept"><strong>数字视频概念，方法和测量指标：质量，压缩，性能和电量等的权衡分析（中文版）</strong></a>。该翻译版本仅供学习交流之用。希望对想学习和了解数字视频相关技术的同学，有所帮助。</p>
<p>在翻译的过程中，尽可能的保留了原书的内容，并且对原书中的个别内容进行了修正和补充。</p>
<a id="more"></a>
<p><img src="/digital-video-concept/images/cover_0.jpg" alt></p>
<p>该书在翻译的过程中采用gitbook方式编写，可以利用gitbook将该项目打包成静态网页格式或者PDF<br>
格式，具体可以参见：<a href="https://einverne.github.io/gitbook-tutorial/output/static.html" target="_blank" rel="noopener">gitbook教程</a>。</p>
<p>项目主页地址：<a href="https://github.com/wangwei1237/digital_video_concepts.git" target="_blank" rel="noopener">github仓库</a></p>
<p>在线预览地址：<a href="https://wangwei1237.gitee.io/digital-video-concept" target="_blank" rel="noopener">预览地址1</a>, <a href="https://wangwei1237.github.io/digital-video-concept">预览地址2</a>, <a href="https://wangwei1237.gitbook.io/digital_video_concepts" target="_blank" rel="noopener">预览地址3</a></p>
<p>在阅读过程中有任何意见或建议，欢迎在github上提交issue，我们也会快速跟进。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>荐书</tag>
        <tag>数字视频</tag>
        <tag>digital video</tag>
        <tag>视频基础知识</tag>
      </tags>
  </entry>
  <entry>
    <title>数字视频技术导论</title>
    <url>/2020/02/28/Introduction-to-digital-video-technology/</url>
    <content><![CDATA[<h1>背景</h1>
<p>因为工作关系需要了解数字视频相关技术，在学习的过程中找到了这份托管在github上的<strong>数字视频导论</strong>的材料。</p>
<p>这份材料介绍了基本的数字视频相关技术，言简意赅但又不枯燥无味，即有理论又有丰富的实践操作，在我学习的所有材料中算是比较上乘的材料。</p>
<p>基于如上的原因，将该材料的相关内容转载到此处。大家可以直接访问该材料的github仓库<a href="https://github.com/leandromoreira/digital_video_introduction" target="_blank" rel="noopener"><strong>digital_video_introduction</strong></a>获取相关内容。如下的所有内容皆来自<a href="https://github.com/leandromoreira/digital_video_introduction" target="_blank" rel="noopener"><strong>digital_video_introduction</strong></a>，特此标注。</p>
<p><a href="license-BSD--3--Clause-blue.svg"><img src="/2020/02/28/Introduction-to-digital-video-technology/license-BSD--3--Clause-blue.svg" alt="license"></a></p>
<a id="more"></a>
<h1>介绍</h1>
<p>这是一份循序渐进的视频技术的介绍。尽管它面向的是软件开发人员/工程师，但我们希望<strong>对任何人而言</strong>，这份文档都能简单易学。这个点子产生于一个<a href="https://docs.google.com/presentation/d/17Z31kEkl_NGJ0M66reqr9_uTG6tI5EDDVXpdPKVuIrs/edit#slide=id.p" target="_blank" rel="noopener">视频技术新手小型研讨会</a>期间。</p>
<p>本文档旨在尽可能使用<strong>浅显的词语，丰富的图像和实际例子</strong>介绍数字视频概念，使这些知识能适用于各种场合。你可以随时反馈意见或建议，以改进这篇文档。</p>
<h1>目录</h1>
<ul>
<li><a href="#%E4%BB%8B%E7%BB%8D">介绍</a></li>
<li><a href="#%E7%9B%AE%E5%BD%95">目录</a></li>
<li><a href="#%E5%9F%BA%E6%9C%AC%E6%9C%AF%E8%AF%AD">基本术语</a>
<ul>
<li><a href="#%E7%BC%96%E7%A0%81%E5%BD%A9%E8%89%B2%E5%9B%BE%E5%83%8F%E7%9A%84%E5%85%B6%E5%AE%83%E6%96%B9%E6%B3%95">编码彩色图像的其它方法</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E7%8E%A9%E8%BD%AC%E5%9B%BE%E5%83%8F%E5%92%8C%E9%A2%9C%E8%89%B2">自己动手：玩转图像和颜色</a></li>
<li><a href="#DVD-%E7%9A%84-DAR-%E6%98%AF-4-3">DVD 的 DAR 是 4:3</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%A3%80%E6%9F%A5%E8%A7%86%E9%A2%91%E5%B1%9E%E6%80%A7">自己动手：检查视频属性</a></li>
</ul>
</li>
<li><a href="#%E6%B6%88%E9%99%A4%E5%86%97%E4%BD%99">消除冗余</a>
<ul>
<li><a href="#%E9%A2%9C%E8%89%B2%EF%BC%8C%E4%BA%AE%E5%BA%A6%E5%92%8C%E6%88%91%E4%BB%AC%E7%9A%84%E7%9C%BC%E7%9D%9B">颜色，亮度和我们的眼睛</a>
<ul>
<li><a href="#%E9%A2%9C%E8%89%B2%E6%A8%A1%E5%9E%8B">颜色模型</a></li>
<li><a href="#YCbCr-%E5%92%8C-RGB-%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2">YCbCr 和 RGB 之间的转换</a></li>
<li><a href="#%E8%89%B2%E5%BA%A6%E5%AD%90%E9%87%87%E6%A0%B7">色度子采样</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%A3%80%E6%9F%A5-YCbCr-%E7%9B%B4%E6%96%B9%E5%9B%BE">自己动手：检查 YCbCr 直方图</a></li>
</ul>
</li>
<li><a href="#%E5%B8%A7%E7%B1%BB%E5%9E%8B">帧类型</a>
<ul>
<li><a href="#I-%E5%B8%A7%EF%BC%88%E5%B8%A7%E5%86%85%E7%BC%96%E7%A0%81%EF%BC%8C%E5%85%B3%E9%94%AE%E5%B8%A7%EF%BC%89">I 帧（内部，关键帧）</a></li>
<li><a href="#P-%E5%B8%A7%EF%BC%88%E9%A2%84%E6%B5%8B%EF%BC%89">P 帧（预测）</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E5%85%B7%E6%9C%89%E5%8D%95%E4%B8%AA-I-%E5%B8%A7%E7%9A%84%E8%A7%86%E9%A2%91">自己动手：具有单个 I 帧的视频</a></li>
</ul>
</li>
<li><a href="#B-%E5%B8%A7%EF%BC%88%E5%8F%8C%E5%90%91%E9%A2%84%E6%B5%8B%EF%BC%89">B 帧（双向预测）</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E4%BD%BF%E7%94%A8-B-%E5%B8%A7%E6%AF%94%E8%BE%83%E8%A7%86%E9%A2%91">自己动手：使用 B 帧比较视频</a></li>
</ul>
</li>
<li><a href="#%E5%B0%8F%E7%BB%93">小结</a></li>
</ul>
</li>
<li><a href="#%E6%97%B6%E9%97%B4%E5%86%97%E4%BD%99%EF%BC%88%E5%B8%A7%E9%97%B4%E9%A2%84%E6%B5%8B%EF%BC%89">时间冗余（帧间预测）</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%9F%A5%E7%9C%8B%E8%BF%90%E5%8A%A8%E5%90%91%E9%87%8F">自己动手：查看运动向量</a></li>
</ul>
</li>
<li><a href="#%E7%A9%BA%E9%97%B4%E5%86%97%E4%BD%99%EF%BC%88%E5%B8%A7%E5%86%85%E9%A2%84%E6%B5%8B%EF%BC%89">空间冗余（帧内预测）</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%9F%A5%E7%9C%8B%E5%B8%A7%E5%86%85%E9%A2%84%E6%B5%8B">自己动手：查看帧内预测</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E8%A7%86%E9%A2%91%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F">视频编解码器是如何工作的？</a>
<ul>
<li><a href="#%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%EF%BC%9F%E6%80%8E%E4%B9%88%E5%81%9A%EF%BC%9F">是什么？为什么？怎么做？</a></li>
<li><a href="#%E5%8E%86%E5%8F%B2">历史</a>
<ul>
<li><a href="#AV1-%E7%9A%84%E8%AF%9E%E7%94%9F">AV1 的诞生</a></li>
</ul>
</li>
<li><a href="#%E9%80%9A%E7%94%A8%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8">通用编解码器</a></li>
<li><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E5%9B%BE%E7%89%87%E5%88%86%E5%8C%BA">第一步 - 图片分区</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%9F%A5%E7%9C%8B%E5%88%86%E5%8C%BA">自己动手：查看分区</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E9%A2%84%E6%B5%8B">第二步 - 预测</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E8%BD%AC%E6%8D%A2">第三步 - 转换</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E4%B8%A2%E5%BC%83%E4%B8%8D%E5%90%8C%E7%9A%84%E7%B3%BB%E6%95%B0">自己动手：丢弃不同的系数</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5-%E9%87%8F%E5%8C%96">第四步 - 量化</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E9%87%8F%E5%8C%96">自己动手：量化</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%94%E6%AD%A5-%E7%86%B5%E7%BC%96%E7%A0%81">第五步 - 熵编码</a>
<ul>
<li><a href="#VLC-%E7%BC%96%E7%A0%81%EF%BC%9A">VLC 编码</a></li>
<li><a href="#%E7%AE%97%E6%9C%AF%E7%BC%96%E7%A0%81">算术编码</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9ACABAC-vs-CAVLC">自己动手：CABAC vs CAVLC</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E5%85%AD%E6%AD%A5-%E6%AF%94%E7%89%B9%E6%B5%81%E6%A0%BC%E5%BC%8F">第六步 - 比特流格式</a>
<ul>
<li><a href="#H-264-%E6%AF%94%E7%89%B9%E6%B5%81">H.264 比特流</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%A3%80%E6%9F%A5-H-264-%E6%AF%94%E7%89%B9%E6%B5%81">自己动手：检查 H.264 比特流</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9E%E9%A1%BE">回顾</a></li>
<li><a href="#H-265-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AF%94-H-264-%E6%9B%B4%E5%A5%BD%E7%9A%84%E5%8E%8B%E7%BC%A9%E7%8E%87">H.265 如何实现比 H.264 更好的压缩率?</a></li>
</ul>
</li>
<li><a href="#%E5%9C%A8%E7%BA%BF%E6%B5%81%E5%AA%92%E4%BD%93">在线流媒体</a>
<ul>
<li><a href="#%E9%80%9A%E7%94%A8%E6%9E%B6%E6%9E%84">通用架构</a></li>
<li><a href="#%E6%B8%90%E8%BF%9B%E5%BC%8F%E4%B8%8B%E8%BD%BD%E5%92%8C%E8%87%AA%E9%80%82%E5%BA%94%E6%B5%81">渐进式下载和自适应流</a></li>
<li><a href="#%E5%86%85%E5%AE%B9%E4%BF%9D%E6%8A%A4">内容保护</a></li>
</ul>
</li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-jupyter">如何使用 jupyter</a></li>
<li><a href="#%E4%BC%9A%E8%AE%AE">会议</a></li>
<li><a href="#%E5%8F%82%E8%80%83">参考</a></li>
</ul>
<h1>基本术语</h1>
<p>一个<strong>图像</strong>可以视作一个<strong>二维矩阵</strong>。如果将<strong>色彩</strong>考虑进来，我们可以做出推广：将这个图像视作一个<strong>三维矩阵</strong>——多出来的维度用于储存色彩信息。</p>
<p>如果我们选择三原色（红、绿、蓝）代表这些色彩，这就定义了三个平面：第一个是红色平面，第二个是绿色平面，最后一个是蓝色平面。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/image_3d_matrix_rgb.png" alt="an image is a 3d matrix RGB" title="An image is a 3D matrix"></p>
<p>我们把这个矩阵里的每一个点称为<strong>像素</strong>（图像元素）。像素的色彩由三原色的<strong>强度</strong>（通常用数值表示）表示。例如，一个<strong>红色像素</strong>是指强度为 0 的绿色，强度为 0 的蓝色和强度最大的红色。<strong>粉色像素</strong>可以通过三种颜色的组合表示。如果规定强度的取值范围是 0 到 255，<strong>红色 255、绿色 192、蓝色 203</strong> 则表示粉色。</p>
<blockquote>
<h3 id="编码彩色图像的其它方法">编码彩色图像的其它方法</h3>
<p>还有许多其它模型也可以用来表示色彩，进而组成图像。例如，给每种颜色都标上序号（如下图），这样每个像素仅需一个字节就可以表示出来，而不是 RGB 模型通常所需的 3 个。在这样一个模型里我们可以用一个二维矩阵来代替三维矩阵去表示我们的色彩，这将节省存储空间，但色彩的数量将会受限。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/nes-color-palette.png" alt="NES palette" title="NES palette"></p>
</blockquote>
<p>例如以下几张图片。第一张包含所有颜色平面。剩下的分别是红、绿、蓝色平面（显示为灰调）（译注：颜色强度高的地方显示为亮色，强度低为暗色）。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/rgb_channels_intensity.png" alt="RGB channels intensity" title="RGB channels intensity"></p>
<p>我们可以看到，对于最终的成像，红色平面对强度的贡献更多（三个平面最亮的是红色平面），蓝色平面（最后一张图片）的贡献大多只在马里奥的眼睛和他衣服的一部分。所有颜色平面对马里奥的胡子（最暗的部分）均贡献较少。</p>
<p>存储颜色的强度，需要占用一定大小的数据空间，这个大小被称为颜色深度。假如每个颜色（平面）的强度占用 8 bit（取值范围为 0 到 255），那么颜色深度就是 24（8*3）bit，我们还可以推导出我们可以使用 2 的 24 次方种不同的颜色。</p>
<blockquote>
<p>很棒的学习材料：<a href="http://www.cambridgeincolour.com/tutorials/camera-sensors.htm" target="_blank" rel="noopener">现实世界的照片是如何拍摄成 0 和 1 的</a>。</p>
</blockquote>
<p>图片的另一个属性是<strong>分辨率</strong>，即一个平面内像素的数量。通常表示成宽*高，例如下面这张 <strong>4x4</strong> 的图片。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/resolution.png" alt="image resolution" title="image resolution"></p>
<blockquote>
<h3 id="自己动手：玩转图像和颜色">自己动手：玩转图像和颜色</h3>
<p>你可以使用 <a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-jupyter">jupyter</a>（python, numpy, matplotlib 等等）<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/image_as_3d_array.ipynb" target="_blank" rel="noopener">玩转图像</a>。</p>
<p>你也可以学习<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/filters_are_easy.ipynb" target="_blank" rel="noopener">图像滤镜（边缘检测，磨皮，模糊。。。）的原理</a>。</p>
</blockquote>
<p>图像或视频还有一个属性是宽高比，它简单地描述了图像或像素的宽度和高度之间的比例关系。</p>
<p>当人们说这个电影或照片是 16:9 时，通常是指显示宽高比（DAR），然而我们也可以有不同形状的单个像素，我们称为像素宽高比（PAR）。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/DAR.png" alt="display aspect ratio" title="display aspect ratio"></p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/PAR.png" alt="pixel aspect ratio" title="pixel aspect ratio"></p>
<blockquote>
<h2 id="dvd-的-dar-是-4-3">DVD 的 DAR 是 4:3</h2>
<p>虽然 DVD 的实际分辨率是 704x480，但它依然保持 4:3 的宽高比，因为它有一个 10:11（704x10／480x11）的 PAR。</p>
</blockquote>
<p>现在我们可以将<strong>视频</strong>定义为在<strong>单位时间</strong>内<strong>连续的 n 帧</strong>，这可以视作一个新的维度，n 即为帧率，若单位时间为秒，则等同于 FPS (每秒帧数 Frames Per Second)。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/video.png" alt="video" title="video"></p>
<p>播放一段视频每秒所需的数据量就是它的<strong>比特率</strong>（即常说的码率）。</p>
<blockquote>
<p>比特率 = 宽 * 高 * 颜色深度 * 帧每秒</p>
</blockquote>
<p>例如，一段每秒 30 帧，每像素 24 bits，分辨率是 480x240 的视频，如果我们不做任何压缩，它将需要 <strong>82,944,000 比特每秒</strong>或 82.944 Mbps (30x480x240x24)。</p>
<p>当<strong>比特率</strong>几乎恒定时称为恒定比特率（<strong>CBR</strong>）；但它也可以变化，称为可变比特率（<strong>VBR</strong>）。</p>
<blockquote>
<p>这个图形显示了一个受限的 VBR，当帧为黑色时不会花费太多的数据量。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/vbr.png" alt="constrained vbr" title="constrained vbr"></p>
</blockquote>
<p>在早期，工程师们想出了一项技术能将视频的感官帧率加倍而<strong>没有消耗额外带宽</strong>。这项技术被称为<strong>隔行扫描</strong>；总的来说，它在一个时间点发送一个画面——画面用于填充屏幕的一半，而下一个时间点发送的画面用于填充屏幕的另一半。</p>
<p>如今的屏幕渲染大多使用<strong>逐行扫描技术</strong>。这是一种显示、存储、传输运动图像的方法，每帧中的所有行都会被依次绘制。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/interlaced_vs_progressive.png" alt="interlaced vs progressive" title="interlaced vs progressive"></p>
<p>现在我们知道了数字化<strong>图像</strong>的原理；它的<strong>颜色</strong>的编排方式；给定<strong>帧率</strong>和<strong>分辨率</strong>时，展示一个视频需要花费多少<strong>比特率</strong>；它是恒定的（CBR）还是可变的（VBR）；还有很多其它内容，如隔行扫描和 PAR。</p>
<blockquote>
<h2 id="自己动手：检查视频属性">自己动手：检查视频属性</h2>
<p>你可以<a href="https://github.com/leandromoreira/introduction_video_technology/blob/master/encoding_pratical_examples.md#inspect-stream" target="_blank" rel="noopener">使用 ffmpeg 或 mediainfo 检查大多数属性的解释</a>。</p>
</blockquote>
<h1>消除冗余</h1>
<p>我们认识到，不对视频进行压缩是不行的；<strong>一个单独的一小时长的视频</strong>，分辨率为 720p 和 30fps 时将<strong>需要 278GB<sup>*</sup></strong>。仅仅使用无损数据压缩算法——如 DEFLATE（被PKZIP, Gzip, 和 PNG 使用）——也无法充分减少视频所需的带宽，我们需要找到其它压缩视频的方法。</p>
<blockquote>
<p><sup>*</sup>我们使用乘积得出这个数字 1280 x 720 x 24 x 30 x 3600 （宽，高，每像素比特数，fps 和秒数）</p>
</blockquote>
<p>为此，我们可以<strong>利用视觉特性</strong>：和区分颜色相比，我们区分亮度要更加敏锐。<strong>时间上的重复</strong>：一段视频包含很多只有一点小小改变的图像。<strong>图像内的重复</strong>：每一帧也包含很多颜色相同或相似的区域。</p>
<h2 id="颜色-亮度和我们的眼睛">颜色，亮度和我们的眼睛</h2>
<p>我们的眼睛<a href="http://vanseodesign.com/web-design/color-luminance/" target="_blank" rel="noopener">对亮度比对颜色更敏感</a>，你可以看看下面的图片自己测试。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/luminance_vs_color.png" alt="luminance vs color" title="luminance vs color"></p>
<p>如果你看不出左图的<strong>方块 A 和方块 B</strong> 的颜色是<strong>相同的</strong>，那么好，是我们的大脑玩了一个小把戏，这让我们更多的去注意光与暗，而不是颜色。右边这里有一个使用同样颜色的连接器，那么我们（的大脑）就能轻易分辨出事实，它们是同样的颜色。</p>
<blockquote>
<p><strong>简单解释我们的眼睛工作的原理</strong></p>
<p><a href="http://www.biologymad.com/nervoussystem/eyenotes.htm" target="_blank" rel="noopener">眼睛是一个复杂的器官</a>，有许多部分组成，但我们最感兴趣的是视锥细胞和视杆细胞。眼睛有<a href="https://en.wikipedia.org/wiki/Photoreceptor_cell" target="_blank" rel="noopener">大约1.2亿个视杆细胞和6百万个视锥细胞</a>。</p>
<p><strong>简单来说</strong>，让我们把颜色和亮度放在眼睛的功能部位上。<a href="https://en.wikipedia.org/wiki/Rod_cell" target="_blank" rel="noopener">视杆细胞</a><strong>主要负责亮度</strong>，而<a href="https://en.wikipedia.org/wiki/Cone_cell" target="_blank" rel="noopener">视锥细胞</a><strong>负责颜色</strong>，有三种类型的视锥，每个都有不同的颜料，叫做：<a href="https://upload.wikimedia.org/wikipedia/commons/1/1e/Cones_SMJ2_E.svg" target="_blank" rel="noopener">S-视锥（蓝色），M-视锥（绿色）和L-视锥（红色）</a>。</p>
<p>既然我们的视杆细胞（亮度）比视锥细胞多很多，一个合理的推断是相比颜色，我们有更好的能力去区分黑暗和光亮。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/eyes.jpg" alt="eyes composition" title="eyes composition"></p>
</blockquote>
<p>一旦我们知道我们对<strong>亮度</strong>（图像中的亮度）更敏感，我们就可以利用它。</p>
<h3 id="颜色模型">颜色模型</h3>
<p>我们最开始学习的<a href="#%E5%9F%BA%E6%9C%AC%E6%9C%AF%E8%AF%AD">彩色图像的原理</a>使用的是 <strong>RGB 模型</strong>，但也有其他模型。有一种模型将亮度（光亮）和色度（颜色）分离开，它被称为 <strong>YCbCr</strong><sup>*</sup>。</p>
<blockquote>
<p><sup>*</sup> 有很多种模型做同样的分离。</p>
</blockquote>
<p>这个颜色模型使用 <strong>Y</strong> 来表示亮度，还有两种颜色通道：Cb（蓝色色度） 和 Cr（红色色度）。YCbCr 可以由 RGB 转换得来，也可以转换回 RGB。使用这个模型我们可以创建拥有完整色彩的图像，如下图。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/ycbcr.png" alt="ycbcr 例子" title="ycbcr 例子"></p>
<h3 id="ycbcr-和-rgb-之间的转换">YCbCr 和 RGB 之间的转换</h3>
<p>有人可能会问，在**不使用绿色（色度）**的情况下，我们如何表现出所有的色彩？</p>
<p>为了回答这个问题，我们将介绍从 RGB 到 YCbCr 的转换。我们将使用 <a href="https://en.wikipedia.org/wiki/ITU-R" target="_blank" rel="noopener">ITU-R 小组</a>*建议的<a href="https://en.wikipedia.org/wiki/Rec._601" target="_blank" rel="noopener">标准 BT.601</a> 中的系数。</p>
<p>第一步是计算亮度，我们将使用 ITU 建议的常量，并替换 RGB 值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Y &#x3D; 0.299R + 0.587G + 0.114B</span><br></pre></td></tr></table></figure>
<p>一旦我们有了亮度后，我们就可以拆分颜色（蓝色色度和红色色度）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Cb &#x3D; 0.564(B - Y)</span><br><span class="line">Cr &#x3D; 0.713(R - Y)</span><br></pre></td></tr></table></figure>
<p>并且我们也可以使用 YCbCr 转换回来，甚至得到绿色。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R &#x3D; Y + 1.402Cr</span><br><span class="line">B &#x3D; Y + 1.772Cb</span><br><span class="line">G &#x3D; Y - 0.344Cb - 0.714Cr</span><br></pre></td></tr></table></figure>
<blockquote>
<p><sup>*</sup>组织和标准在数字视频领域中很常见，它们通常定义什么是标准，例如，<a href="https://en.wikipedia.org/wiki/Rec._2020" target="_blank" rel="noopener">什么是 4K？我们应该使用什么帧率？分辨率？颜色模型？</a></p>
</blockquote>
<p>通常，<strong>显示屏</strong>（监视器，电视机，屏幕等等）<strong>仅使用 RGB 模型</strong>，并以不同的方式来组织，看看下面这些放大效果：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/new_pixel_geometry.jpg" alt="pixel geometry" title="pixel geometry"></p>
<h3 id="色度子采样">色度子采样</h3>
<p>一旦我们能从图像中分离出亮度和色度，我们就可以利用人类视觉系统对亮度比色度更敏感的特点，选择性地剔除信息。<strong>色度子采样</strong>是一种编码图像时，使<strong>色度分辨率低于亮度</strong>的技术。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/ycbcr_subsampling_resolution.png" alt="ycbcr 子采样分辨率" title="ycbcr 子采样分辨率"></p>
<p>我们应该减少多少色度分辨率呢？已经有一些模式定义了如何处理分辨率和合并（<code>最终的颜色 = Y + Cb + Cr</code>）。</p>
<p>这些模式称为子采样系统，并被表示为 3 部分的比率 - <code>a:x:y</code>，其定义了色度平面的分辨率，与亮度平面上的、分辨率为 <code>a x 2</code> 的小块之间的关系。</p>
<ul>
<li><code>a</code> 是水平采样参考 (通常是 4)，</li>
<li><code>x</code> 是第一行的色度样本数（相对于 a 的水平分辨率），</li>
<li><code>y</code> 是第二行的色度样本数。</li>
</ul>
<blockquote>
<p>存在的一个例外是 4:1:0，其在每个亮度平面分辨率为 4 x 4 的块内提供一个色度样本。</p>
</blockquote>
<p>现代编解码器中使用的常用方案是： 4:4:4 (没有子采样)**, 4:2:2, 4:1:1, 4:2:0, 4:1:0 and 3:1:1。</p>
<blockquote>
<p>YCbCr 4:2:0 合并</p>
<p>这是使用 YCbCr 4:2:0 合并的一个图像的一块，注意我们每像素只花费 12bit。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/ycbcr_420_merge.png" alt="YCbCr 4:2:0 合并" title="YCbCr 4:2:0 合并"></p>
</blockquote>
<p>下图是同一张图片使用几种主要的色度子采样技术进行编码，第一行图像是最终的 YCbCr，而最后一行图像展示了色度的分辨率。这么小的损失确实是一个伟大的胜利。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/chroma_subsampling_examples.jpg" alt="色度子采样例子" title="色度子采样例子"></p>
<p>前面我们计算过我们需要 <a href="#%E6%B6%88%E9%99%A4%E5%86%97%E4%BD%99">278GB 去存储一个一小时长，分辨率在720p和30fps的视频文件</a>。如果我们使用 <code>YCbCr 4:2:0</code> 我们能剪掉<code>一半的大小（139GB）</code><sup>*</sup>，但仍然不够理想。</p>
<blockquote>
<p><sup>*</sup> 我们通过将宽、高、颜色深度和 fps 相乘得出这个值。前面我们需要 24 bit，现在我们只需要 12 bit。</p>
</blockquote>
<blockquote>
<h3 id="自己动手：检查-ycbcr-直方图">自己动手：检查 YCbCr 直方图</h3>
<p>你可以<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#generates-yuv-histogram" target="_blank" rel="noopener">使用 ffmpeg 检查 YCbCr 直方图</a>。这个场景有更多的蓝色贡献，由<a href="https://en.wikipedia.org/wiki/Histogram" target="_blank" rel="noopener">直方图</a>显示。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/yuv_histogram.png" alt="ycbcr 颜色直方图" title="ycbcr 颜色直方图"></p>
</blockquote>
<h2 id="帧类型">帧类型</h2>
<p>现在我们进一步消除<code>时间冗余</code>，但在这之前让我们来确定一些基本术语。假设我们一段 30fps 的影片，这是最开始的 4 帧。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_1.png" alt="球 1" title="球 1"> <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_2.png" alt="球 2" title="球 2"> <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_3.png" alt="球 3" title="球 3"><br>
<img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_4.png" alt="球 4" title="球 4"></p>
<p>我们可以在帧内看到<strong>很多重复内容</strong>，如<strong>蓝色背景</strong>，从 0 帧到第 3 帧它都没有变化。为了解决这个问题，我们可以将它们<strong>抽象地分类</strong>为三种类型的帧。</p>
<h3 id="i-帧-帧内编码-关键帧">I 帧（帧内编码，关键帧）</h3>
<p>I 帧（可参考，关键帧，帧内编码）是一个<strong>自足的帧</strong>。它不依靠任何东西来渲染，I 帧与静态图片相似。第一帧通常是 I 帧，但我们将看到 I 帧被定期插入其它类型的帧之间。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_1.png" alt="球 1" title="球 1"></p>
<h3 id="p-帧-预测">P 帧（预测）</h3>
<p>P 帧利用了一个事实：当前的画面几乎总能<strong>使用之前的一帧进行渲染</strong>。例如，在第二帧，唯一的改变是球向前移动了。仅仅使用（第二帧）对前一帧的引用和差值，我们就能重建前一帧。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_1.png" alt="球 1" title="球 1"> &lt;-  <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_2_diff.png" alt="球 2" title="球 2"></p>
<blockquote>
<h4 id="自己动手：具有单个-i-帧的视频">自己动手：具有单个 I 帧的视频</h4>
<p>既然 P 帧使用较少的数据，为什么我们不能用<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#1-i-frame-and-the-rest-p-frames" target="_blank" rel="noopener">单个 I 帧和其余的 P 帧</a>来编码整个视频？</p>
<p>编码完这个视频之后，开始观看它，并<strong>快进到视频的末尾部分</strong>，你会注意到<strong>它需要花一些时间</strong>才真正跳转到这部分。这是因为 <strong>P 帧需要一个引用帧</strong>（比如 I 帧）才能渲染。</p>
<p>你可以做的另一个快速试验，是使用单个 I 帧编码视频，然后<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#1-i-frames-per-second-vs-05-i-frames-per-second" target="_blank" rel="noopener">再次编码且每 2 秒插入一个 I 帧</a>，并<strong>比较成品的大小</strong>。</p>
</blockquote>
<h3 id="b-帧-双向预测">B 帧（双向预测）</h3>
<p>如何引用前面和后面的帧去做更好的压缩？！简单地说 B 帧就是这么做的。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_1.png" alt="球 1" title="球 1"> &lt;-  <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_2_diff.png" alt="球 2" title="球 2"> -&gt; <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_3.png" alt="球 3" title="球 3"></p>
<blockquote>
<h4 id="自己动手：使用-b-帧比较视频">自己动手：使用 B 帧比较视频</h4>
<p>你可以生成两个版本，一个使用 B 帧，另一个<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#no-b-frames-at-all" target="_blank" rel="noopener">全部不使用 B 帧</a>，然后查看文件的大小以及画质。</p>
</blockquote>
<h3 id="小结">小结</h3>
<p>这些帧类型用于提供更好的压缩率，我们将在下一章看到这是如何发生的。现在，我们可以想到 I 帧是昂贵的，P 帧是便宜的，最便宜的是 B 帧。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/frame_types.png" alt="帧类型例子" title="帧类型例子"></p>
<h2 id="时间冗余-帧间预测">时间冗余（帧间预测）</h2>
<p>让我们探究去除<strong>时间上的重复</strong>，去除这一类冗余的技术就是<strong>帧间预测</strong>。</p>
<p>我们将尝试<strong>花费较少的数据量</strong>去编码在时间上连续的 0 号帧和 1 号帧。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/original_frames.png" alt="原始帧" title="原始帧"></p>
<p>我们可以做个减法，我们简单地<strong>用 0 号帧减去 1 号帧</strong>，得到残差，这样我们就只需要<strong>对残差进行编码</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/difference_frames.png" alt="残差帧" title="残差帧"></p>
<p>但我们有一个<strong>更好的方法</strong>来节省数据量。首先，我们将<code>0 号帧</code> 视为一个个分块的集合，然后我们将尝试将 <code>帧 1</code> 和 <code>帧 0</code> 上的块相匹配。我们可以将这看作是<strong>运动预测</strong>。</p>
<blockquote>
<h3 id="维基百科-块运动补偿">维基百科—块运动补偿</h3>
<p>“运动补偿是一种描述相邻帧（相邻在这里表示在编码关系上相邻，在播放顺序上两帧未必相邻）差别的方法，具体来说是描述前面一帧（相邻在这里表示在编码关系上的前面，在播放顺序上未必在当前帧前面）的每个小块怎样移动到当前帧中的某个位置去。”</p>
</blockquote>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/original_frames_motion_estimation.png" alt="原始帧运动预测" title="原始帧运动预测"></p>
<p>我们预计那个球会从 <code>x=0, y=25</code> 移动到 <code>x=6, y=26</code>，<strong>x</strong> 和 <strong>y</strong> 的值就是<strong>运动向量</strong>。<strong>进一步</strong>节省数据量的方法是，只编码这两者运动向量的差。所以，最终运动向量就是 <code>x=6 (6-0), y=1 (26-25)</code>。</p>
<blockquote>
<p>实际情况下，这个球会被切成 n 个分区，但处理过程是相同的。</p>
</blockquote>
<p>帧上的物体<strong>以三维方式移动</strong>，当球移动到背景时会变小。当我们尝试寻找匹配的块，<strong>找不到完美匹配的块</strong>是正常的。这是一张运动预测与实际值相叠加的图片。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/motion_estimation.png" alt="运动预测" title="运动预测"></p>
<p>但我们能看到当我们使用<strong>运动预测</strong>时，<strong>编码的数据量少于</strong>使用简单的残差帧技术。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/comparison_delta_vs_motion_estimation.png" alt="运动预测 vs 残差 " title="运动预测 vs 残差"></p>
<p>你可以<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/frame_difference_vs_motion_estimation_plus_residual.ipynb" target="_blank" rel="noopener">使用 jupyter 玩转这些概念</a>。</p>
<blockquote>
<h3 id="自己动手：查看运动向量">自己动手：查看运动向量</h3>
<p>我们可以<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#generate-debug-video" target="_blank" rel="noopener">使用 ffmpeg 生成包含帧间预测（运动向量）的视频</a>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/motion_vectors_ffmpeg.png" alt="ffmpeg 帧间预测（运动向量）" title="ffmpeg 帧间预测（运动向量）"></p>
<p>或者我们也可使用 <a href="https://software.intel.com/en-us/intel-video-pro-analyzer" target="_blank" rel="noopener">Intel® Video Pro Analyzer</a>（需要付费，但也有只能查看前 10 帧的免费试用版）。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/inter_prediction_intel_video_pro_analyzer.png" alt="Intel® Video Pro Analyzer 使用帧间预测" title="inter prediction intel video pro analyzer"></p>
</blockquote>
<h2 id="空间冗余-帧内预测">空间冗余（帧内预测）</h2>
<p>如果我们分析一个视频里的<strong>每一帧</strong>，我们会看到有<strong>许多区域是相互关联的</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/repetitions_in_space.png" alt="空间内重复" title="空间内重复"></p>
<p>让我们举一个例子。这个场景大部分由蓝色和白色组成。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_bg.png" alt="smw 背景" title="smw 背景"></p>
<p>这是一个 <code>I 帧</code>，我们<strong>不能使用前面的帧来预测</strong>，但我们仍然可以压缩它。我们将编码我们选择的那块红色区域。如果我们<strong>看看它的周围</strong>，我们可以<strong>估计它周围颜色的变化</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_bg_block.png" alt="smw 背景块" title="smw 背景块"></p>
<p>我们预测:帧中的颜色在垂直方向上保持一致，这意味着<strong>未知像素的颜色与临近的像素相同</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_bg_prediction.png" alt="smw 背景预测" title="smw 背景预测"></p>
<p>我们的<strong>预测会出错</strong>，所以我们需要先利用这项技术（<strong>帧内预测</strong>），然后<strong>减去实际值</strong>，算出残差，得出的矩阵比原始数据更容易压缩。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_residual.png" alt="smw 残差" title="smw 残差"></p>
<blockquote>
<h3 id="自己动手：查看帧内预测">自己动手：查看帧内预测</h3>
<p>你可以<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#generate-debug-video" target="_blank" rel="noopener">使用 ffmpeg 生成包含宏块及预测的视频</a>。请查看 ffmpeg 文档以了解<a href="https://trac.ffmpeg.org/wiki/Debug/MacroblocksAndMotionVectors" target="_blank" rel="noopener">每个块颜色的含义</a>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/macro_blocks_ffmpeg.png" alt="ffmpeg 帧内预测（宏块）" title="ffmpeg 帧内预测（宏块）"></p>
<p>或者我们也可使用 <a href="https://software.intel.com/en-us/intel-video-pro-analyzer" target="_blank" rel="noopener">Intel® Video Pro Analyzer</a>（需要付费，但也有只能查看前 10 帧的免费试用版）。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/intra_prediction_intel_video_pro_analyzer.png" alt="Intel® Video Pro Analyzer 帧内预测" title="Intel® Video Pro Analyzer 帧内预测"></p>
</blockquote>
<h1>视频编解码器是如何工作的？</h1>
<h2 id="是什么？为什么？怎么做？">是什么？为什么？怎么做？</h2>
<p><strong>是什么？</strong> 就是用于压缩或解压数字视频的软件或硬件。<strong>为什么？</strong> 人们需要在有限带宽或存储空间下提高视频的质量。还记得当我们计算每秒 30 帧，每像素 24 bit，分辨率是 480x240 的视频<a href="#%E5%9F%BA%E6%9C%AC%E6%9C%AF%E8%AF%AD">需要多少带宽</a>吗？没有压缩时是 <strong>82.944 Mbps</strong>。电视或互联网提供 HD/FullHD/4K 只能靠视频编解码器。<strong>怎么做？</strong> 我们将简单介绍一下主要的技术。</p>
<blockquote>
<p>视频编解码 vs 容器</p>
<p>初学者一个常见的错误是混淆数字视频编解码器和<a href="https://en.wikipedia.org/wiki/Digital_container_format" target="_blank" rel="noopener">数字视频容器</a>。我们可以将<strong>容器</strong>视为包含视频（也很可能包含音频）元数据的包装格式，<strong>压缩过的视频</strong>可以看成是它承载的内容。</p>
<p>通常，视频文件的格式定义其视频容器。例如，文件 <code>video.mp4</code> 可能是 <a href="https://en.wikipedia.org/wiki/MPEG-4_Part_14" target="_blank" rel="noopener">MPEG-4 Part 14</a> 容器，一个叫 <code>video.mkv</code> 的文件可能是 <a href="https://en.wikipedia.org/wiki/Matroska" target="_blank" rel="noopener">matroska</a>。我们可以使用 <a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#inspect-stream" target="_blank" rel="noopener">ffmpeg 或 mediainfo</a> 来完全确定编解码器和容器格式。</p>
</blockquote>
<h2 id="历史">历史</h2>
<p>在我们跳进通用编解码器内部工作之前，让我们回头了解一些旧的视频编解码器。</p>
<p>视频编解码器 <a href="https://en.wikipedia.org/wiki/H.261" target="_blank" rel="noopener">H.261</a> 诞生在 1990（技术上是 1988），被设计为以 <strong>64 kbit/s 的数据速率</strong>工作。它已经使用如色度子采样、宏块，等等理念。在 1995 年，<strong>H.263</strong> 视频编解码器标准被发布，并继续延续到 2001 年。</p>
<p>在 2003 年 <strong>H.264/AVC</strong> 的第一版被完成。在同一年，一家叫做 <strong>TrueMotion</strong> 的公司发布了他们的<strong>免版税</strong>有损视频压缩的视频编解码器，称为 <strong>VP3</strong>。在 2008 年，<strong>Google 收购了</strong>这家公司，在同一年发布 <strong>VP8</strong>。在 2012 年 12 月，Google 发布了 <strong>VP9</strong>，<strong>市面上大约有 3/4 的浏览器</strong>（包括手机）支持。</p>
<p><a href="https://en.wikipedia.org/wiki/AOMedia_Video_1" target="_blank" rel="noopener">AV1</a> 是由 <strong>Google, Mozilla, Microsoft, Amazon, Netflix, AMD, ARM, NVidia, Intel, Cisco</strong> 等公司组成的<a href="http://aomedia.org/" target="_blank" rel="noopener">开放媒体联盟（AOMedia）</a>设计的一种新的视频编解码器，免版税，开源。<strong>第一版</strong> 0.1.0 参考编解码器<strong>发布于 2016 年 4 月 7 号</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/codec_history_timeline.png" alt="编解码器历史线路图" title="编解码器历史线路图"></p>
<blockquote>
<h3 id="av1-的诞生">AV1 的诞生</h3>
<p>2015 年早期，Google 正在 VP10 上工作，Xiph (Mozilla) 正在 Daala 上工作，Cisco 开源了它的称为 Thor 的免版税视频编解码器。</p>
<p>接着 MPEG LA 宣布了 HEVC (H.265) 每年版税的的上限，比 H.264 高 8 倍，但很快他们又再次改变了条款：</p>
<ul>
<li><strong>不设年度收费上限</strong></li>
<li><strong>收取内容费</strong>（收入的 0.5%）</li>
<li><strong>每单位费用高于 h264 的 10 倍</strong></li>
</ul>
<p><a href="http://aomedia.org/about-us/" target="_blank" rel="noopener">开放媒体联盟</a>由硬件厂商（Intel, AMD, ARM , Nvidia, Cisco），内容分发商（Google, Netflix, Amazon），浏览器维护者（Google, Mozilla），等公司创建。</p>
<p>这些公司有一个共同目标，一个免版税的视频编解码器，所以 AV1 诞生时使用了一个更<a href="http://aomedia.org/license/patent/" target="_blank" rel="noopener">简单的专利许可证</a>。<strong>Timothy B. Terriberry</strong> 做了一个精彩的介绍，<a href="https://www.youtube.com/watch?v=lzPaldsmJbk" target="_blank" rel="noopener">关于 AV1 的概念，许可证模式和它当前的状态</a>，就是本节的来源。</p>
<p>前往 <a href="http://aomanalyzer.org/" target="_blank" rel="noopener">http://aomanalyzer.org/</a>， 你会惊讶于<strong>使用你的浏览器就可以分析 AV1 编解码器</strong>。<br>
<img src="/2020/02/28/Introduction-to-digital-video-technology/av1_browser_analyzer.png" alt="av1 浏览器分析器" title="浏览器分析器"></p>
<p>附：如果你想了解更多编解码器的历史，你需要了解<a href="https://www.vcodex.com/video-compression-patents/" target="_blank" rel="noopener">视频压缩专利</a>背后的基本知识。</p>
</blockquote>
<h2 id="通用编解码器">通用编解码器</h2>
<p>我们接下来要介绍<strong>通用视频编解码器背后的主要机制</strong>，大多数概念都很实用，并被现代编解码器如 VP9, AV1 和 HEVC 使用。需要注意：我们将简化许多内容。有时我们会使用真实的例子（主要是 H.264）来演示技术。</p>
<h2 id="第一步-图片分区">第一步 - 图片分区</h2>
<p>第一步是<strong>将帧</strong>分成几个<strong>分区</strong>，<strong>子分区</strong>甚至更多。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/picture_partitioning.png" alt="图片分区" title="图片分区"></p>
<p>**但是为什么呢？**有许多原因，比如，当我们分割图片时，我们可以更精确的处理预测，在微小移动的部分使用较小的分区，而在静态背景上使用较大的分区。</p>
<p>通常，编解码器<strong>将这些分区组织</strong>成切片（或瓦片），宏（或编码树单元）和许多子分区。这些分区的最大大小有所不同，HEVC 设置成 64x64，而 AVC 使用 16x16，但子分区可以达到 4x4 的大小。</p>
<p>还记得我们学过的<strong>帧的分类</strong>吗？你也可以<strong>把这些概念应用到块</strong>，因此我们可以有 I 切片，B 切片，I 宏块等等。</p>
<blockquote>
<h3 id="自己动手：查看分区">自己动手：查看分区</h3>
<p>我们也可以使用 <a href="https://software.intel.com/en-us/intel-video-pro-analyzer" target="_blank" rel="noopener">Intel® Video Pro Analyzer</a>（需要付费，但也有只能查看前 10 帧的免费试用版）。这是 <a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#transcoding" target="_blank" rel="noopener">VP9 分区</a>的分析。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/paritions_view_intel_video_pro_analyzer.png" alt="Intel® Video Pro Analyzer VP9 分区视图 " title="Intel® Video Pro Analyzer VP9 分区视图"></p>
</blockquote>
<h2 id="第二步-预测">第二步 - 预测</h2>
<p>一旦我们有了分区，我们就可以在它们之上做出预测。对于<a href="#%E6%97%B6%E9%97%B4%E5%86%97%E4%BD%99%EF%BC%88%E5%B8%A7%E9%97%B4%E9%A2%84%E6%B5%8B%EF%BC%89">帧间预测</a>，我们需要<strong>发送运动向量和残差</strong>；至于<a href="#%E7%A9%BA%E9%97%B4%E5%86%97%E4%BD%99%EF%BC%88%E5%B8%A7%E5%86%85%E9%A2%84%E6%B5%8B%EF%BC%89">帧内预测</a>，我们需要<strong>发送预测方向和残差</strong>。</p>
<h2 id="第三步-转换">第三步 - 转换</h2>
<p>在我们得到残差块（<code>预测分区-真实分区</code>）之后，我们可以用一种方式<strong>变换</strong>它，这样我们就知道<strong>哪些像素我们应该丢弃</strong>，还依然能保持<strong>整体质量</strong>。这个确切的行为有几种变换方式。</p>
<p>尽管有<a href="https://en.wikipedia.org/wiki/List_of_Fourier-related_transforms#Discrete_transforms" target="_blank" rel="noopener">其它的变换方式</a>，但我们重点关注离散余弦变换（DCT）。<a href="https://en.wikipedia.org/wiki/Discrete_cosine_transform" target="_blank" rel="noopener">DCT</a> 的主要功能有：</p>
<ul>
<li>将<strong>像素</strong>块<strong>转换</strong>为相同大小的<strong>频率系数块</strong>。</li>
<li><strong>压缩</strong>能量，更容易消除空间冗余。</li>
<li><strong>可逆的</strong>，也意味着你可以还原回像素。</li>
</ul>
<blockquote>
<p>2017 年 2 月 2 号，F. M. Bayer 和 R. J. Cintra 发表了他们的论文：<a href="https://arxiv.org/abs/1702.00817" target="_blank" rel="noopener">图像压缩的 DCT 类变换只需要 14 个加法</a>。</p>
</blockquote>
<p>如果你不理解每个要点的好处，不用担心，我们会尝试进行一些实验，以便从中看到真正的价值。</p>
<p>我们来看下面的<strong>像素块</strong>（8x8）：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/pixel_matrice.png" alt="像素值矩形" title="像素值矩形"></p>
<p>下面是其渲染的块图像（8x8）：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/gray_image.png" alt="像素值矩形" title="像素值矩形"></p>
<p>当我们对这个像素块<strong>应用 DCT</strong> 时， 得到如下<strong>系数块</strong>（8x8）：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dct_coefficient_values.png" alt="系数值 values" title="系数值"></p>
<p>接着如果我们渲染这个系数块，就会得到这张图片：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dct_coefficient_image.png" alt="dct 系数图片" title="dct 系数图片"></p>
<p>如你所见它看起来完全不像原图像，我们可能会注意到<strong>第一个系数</strong>与其它系数非常不同。第一个系数被称为直流分量，代表了输入数组中的<strong>所有样本</strong>，有点<strong>类似于平均值</strong>。</p>
<p>这个系数块有一个有趣的属性：高频部分和低频部分是分离的。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dctfrequ.jpg" alt="dct 频率系数属性" title="dct 频率系数属性"></p>
<p>在一张图像中，<strong>大多数能量</strong>会集中在<a href="https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm" target="_blank" rel="noopener">低频部分</a>，所以如果我们将图像转换成频率系数，并<strong>丢掉高频系数</strong>，我们就能<strong>减少描述图像所需的数据量</strong>，而不会牺牲太多的图像质量。</p>
<blockquote>
<p>频率是指信号变化的速度。</p>
</blockquote>
<p>让我们通过实验学习这点，我们将使用 DCT 把原始图像转换为频率（系数块），然后丢掉最不重要的系数。</p>
<p>首先，我们将它转换为其<strong>频域</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dct_coefficient_values.png" alt="系数值" title="系数值"></p>
<p>然后我们丢弃部分（67%）系数，主要是它的右下角部分。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dct_coefficient_zeroed.png" alt="系数清零" title="系数清零"></p>
<p>然后我们从丢弃的系数块重构图像（记住，这需要可逆），并与原始图像相比较。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/original_vs_quantized.png" alt="原始 vs 量化" title="原始 vs 量化"></p>
<p>如我们所见它酷似原始图像，但它引入了许多与原来的不同，我们<strong>丢弃了67.1875%</strong>，但我们仍然得到至少类似于原来的东西。我们可以更加智能的丢弃系数去得到更好的图像质量，但这是下一个主题。</p>
<blockquote>
<h3 id="使用全部像素形成每个系数">使用全部像素形成每个系数</h3>
<p>重要的是要注意，每个系数并不直接映射到单个像素，但它是所有像素的加权和。这个神奇的图形展示了如何计算出第一和第二个系数，使用每个唯一的索引做权重。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/applicat.jpg" alt="dct 计算" title="dct 计算"></p>
<p>来源：<a href="https://web.archive.org/web/20150129171151/https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm" target="_blank" rel="noopener">https://web.archive.org/web/20150129171151/https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm</a></p>
<p>你也可以尝试<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/dct_better_explained.ipynb" target="_blank" rel="noopener">通过查看在 DCT 基础上形成的简单图片来可视化 DCT</a>。例如，这是使用每个系数权重<a href="https://en.wikipedia.org/wiki/Discrete_cosine_transform#Example_of_IDCT" target="_blank" rel="noopener">形成的字符 A</a>。</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Idct-animation.gif" alt></p>
</blockquote>
<br>
<blockquote>
<h3 id="自己动手：丢弃不同的系数">自己动手：丢弃不同的系数</h3>
<p>你可以玩转 <a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/uniform_quantization_experience.ipynb" target="_blank" rel="noopener">DCT 变换</a></p>
</blockquote>
<h2 id="第四步-量化">第四步 - 量化</h2>
<p>当我们丢弃一些系数时，在最后一步（变换），我们做了一些形式的量化。这一步，我们选择性地剔除信息（<strong>有损部分</strong>）或者简单来说，我们将<strong>量化系数以实现压缩</strong>。</p>
<p>我们如何量化一个系数块？一个简单的方法是均匀量化，我们取一个块并<strong>将其除以单个的值</strong>（10），并舍入值。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/quantize.png" alt="量化" title="量化"></p>
<p>我们如何<strong>逆转</strong>（重新量化）这个系数块？我们可以通过<strong>乘以我们先前除以的相同的值</strong>（10）来做到。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/re-quantize.png" alt="逆转量化" title="逆转量化"></p>
<p>这<strong>不是最好的方法</strong>，因为它没有考虑到每个系数的重要性，我们可以使用一个<strong>量化矩阵</strong>来代替单个值，这个矩阵可以利用 DCT 的属性，多量化右下部，而少（量化）左上部，<a href="https://www.hdm-stuttgart.de/~maucher/Python/MMCodecs/html/jpegUpToQuant.html" target="_blank" rel="noopener">JPEG 使用了类似的方法</a>，你可以通过<a href="https://github.com/google/guetzli/blob/master/guetzli/jpeg_data.h#L40" target="_blank" rel="noopener">查看源码看看这个矩阵</a>。</p>
<blockquote>
<h3 id="自己动手：量化">自己动手：量化</h3>
<p>你可以玩转<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/dct_experiences.ipynb" target="_blank" rel="noopener">量化</a></p>
</blockquote>
<h2 id="第五步-熵编码">第五步 - 熵编码</h2>
<p>在我们量化数据（图像块／切片／帧）之后，我们仍然可以以无损的方式来压缩它。有许多方法（算法）可用来压缩数据。我们将简单体验其中几个，你可以阅读这本很棒的书去深入理解：<a href="https://www.amazon.com/Understanding-Compression-Data-Modern-Developers/dp/1491961538/" target="_blank" rel="noopener">Understanding Compression: Data Compression for Modern Developers</a>。</p>
<h3 id="vlc-编码：">VLC 编码：</h3>
<p>让我们假设我们有一个符号流：<strong>a</strong>, <strong>e</strong>, <strong>r</strong> 和 <strong>t</strong>，它们的概率（从0到1）由下表所示。</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>e</th>
<th>r</th>
<th>t</th>
</tr>
</thead>
<tbody>
<tr>
<td>概率</td>
<td>0.3</td>
<td>0.3</td>
<td>0.2</td>
<td>0.2</td>
</tr>
</tbody>
</table>
<p>我们可以分配不同的二进制码，（最好是）小的码给最可能（出现的字符），大些的码给最少可能（出现的字符）。</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>e</th>
<th>r</th>
<th>t</th>
</tr>
</thead>
<tbody>
<tr>
<td>概率</td>
<td>0.3</td>
<td>0.3</td>
<td>0.2</td>
<td>0.2</td>
</tr>
<tr>
<td>二进制码</td>
<td>0</td>
<td>10</td>
<td>110</td>
<td>1110</td>
</tr>
</tbody>
</table>
<p>让我们压缩 <strong>eat</strong> 流，假设我们为每个字符花费 8 bit，在没有做任何压缩时我们将花费 <strong>24 bit</strong>。但是在这种情况下，我们使用各自的代码来替换每个字符，我们就能节省空间。</p>
<p>第一步是编码字符 <strong>e</strong> 为 <code>10</code>，第二个字符是 <strong>a</strong>，追加（不是数学加法）后是 <code>[10][0]</code>，最后是第三个字符 <strong>t</strong>，最终组成已压缩的比特流 <code>[10][0][1110]</code> 或 <code>1001110</code>，这只需 <strong>7 bit</strong>（比原来的空间少 3.4 倍）。</p>
<p>请注意每个代码必须是唯一的前缀码，<a href="https://en.wikipedia.org/wiki/Huffman_coding" target="_blank" rel="noopener">Huffman 能帮你找到这些数字</a>。虽然它有一些问题，但是<a href="https://en.wikipedia.org/wiki/Context-adaptive_variable-length_coding" target="_blank" rel="noopener">视频编解码器仍然提供该方法</a>，它也是很多应用程序的压缩算法。</p>
<p>编码器和解码器都<strong>必须知道</strong>这个（包含编码的）字符表，因此，你也需要传送这个表。</p>
<h3 id="算术编码">算术编码</h3>
<p>让我们假设我们有一个符号流：<strong>a</strong>, <strong>e</strong>, <strong>r</strong>, <strong>s</strong> 和 <strong>t</strong>，它们的概率由下表所示。</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>e</th>
<th>r</th>
<th>s</th>
<th>t</th>
</tr>
</thead>
<tbody>
<tr>
<td>概率</td>
<td>0.3</td>
<td>0.3</td>
<td>0.15</td>
<td>0.05</td>
<td>0.2</td>
</tr>
</tbody>
</table>
<p>考虑到这个表，我们可以构建一个区间，区间包含了所有可能的字符，字符按出现概率排序。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/range.png" alt="初始算法区间" title="初始算法区间"></p>
<p>让我们编码 <strong>eat</strong> 流，我们选择第一个字符 <strong>e</strong> 位于 <strong>0.3 到 0.6</strong> （但不包括 0.6）的子区间，我们选择这个子区间，按照之前同等的比例再次分割。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/second_subrange.png" alt="第二个子区间" title="第二个子区间"></p>
<p>让我们继续编码我们的流 <strong>eat</strong>，现在使第二个 <strong>a</strong> 字符位于 <strong>0.3 到 0.39</strong> 的区间里，接着再次用同样的方法编码最后的字符 <strong>t</strong>，得到最后的子区间 <strong>0.354 到 0.372</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/arithimetic_range.png" alt="最终算法区间" title="最终算法区间"></p>
<p>我们只需从最后的子区间 0.354 到 0.372 里选择一个数，让我们选择 0.36，不过我们可以选择这个子区间里的任何数。仅靠这个数，我们将可以恢复原始流 <strong>eat</strong>。就像我们在区间的区间里画了一根线来编码我们的流。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/range_show.png" alt="最终区间横断面" title="最终区间横断面"></p>
<p><strong>反向过程</strong>（又名解码）一样简单，用数字 <strong>0.36</strong> 和我们原始区间，我们可以进行同样的操作，不过现在是使用这个数字来还原被编码的流。</p>
<p>在第一个区间，我们发现数字落入了一个子区间，因此，这个子区间是我们的第一个字符，现在我们再次切分这个子区间，像之前一样做同样的过程。我们会注意到 <strong>0.36</strong> 落入了 <strong>a</strong> 的区间，然后我们重复这一过程直到得到最后一个字符 <strong>t</strong>（形成我们原始编码过的流 eat）。</p>
<p>编码器和解码器都<strong>必须知道</strong>字符概率表，因此，你也需要传送这个表。</p>
<p>非常巧妙，不是吗？人们能想出这样的解决方案实在是太聪明了，一些<a href="https://en.wikipedia.org/wiki/Context-adaptive_binary_arithmetic_coding" target="_blank" rel="noopener">视频编解码器使用</a>这项技术（或至少提供这一选择）。</p>
<p>关于无损压缩量化比特流的办法，这篇文章无疑缺少了很多细节、原因、权衡等等。作为一个开发者你<a href="https://www.amazon.com/Understanding-Compression-Data-Modern-Developers/dp/1491961538/" target="_blank" rel="noopener">应该学习更多</a>。刚入门视频编码的人可以尝试使用不同的<a href="https://en.wikipedia.org/wiki/Asymmetric_Numeral_Systems" target="_blank" rel="noopener">熵编码算法，如ANS</a>。</p>
<blockquote>
<h3 id="自己动手：cabac-vs-cavlc">自己动手：CABAC vs CAVLC</h3>
<p>你可以<a href="https://github.com/leandromoreira/introduction_video_technology/blob/master/encoding_pratical_examples.md#cabac-vs-cavlc" target="_blank" rel="noopener">生成两个流，一个使用 CABAC，另一个使用 CAVLC</a>，并比较生成每一个的时间以及最终的大小。</p>
</blockquote>
<h2 id="第六步-比特流格式">第六步 - 比特流格式</h2>
<p>完成所有这些步之后，我们需要将<strong>压缩过的帧和内容打包进去</strong>。需要明确告知解码器<strong>编码定义</strong>，如颜色深度，颜色空间，分辨率，预测信息（运动向量，帧内预测方向），配置<sup>*</sup>，层级<sup>*</sup>，帧率，帧类型，帧号等等更多信息。</p>
<blockquote>
<p><sup>*</sup> 译注：原文为 profile 和 level，没有通用的译名</p>
</blockquote>
<p>我们将简单地学习 H.264 比特流。第一步是<a href="https://github.com/leandromoreira/introduction_video_technology/blob/master/encoding_pratical_examples.md#generate-a-single-frame-h264-bitstream" target="_blank" rel="noopener">生成一个小的 H.264<sup>*</sup> 比特流</a>，可以使用本 repo 和 <a href="http://ffmpeg.org/" target="_blank" rel="noopener">ffmpeg</a> 来做。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;s&#x2F;ffmpeg -i &#x2F;files&#x2F;i&#x2F;minimal.png -pix_fmt yuv420p &#x2F;files&#x2F;v&#x2F;minimal_yuv420.h264</span><br></pre></td></tr></table></figure>
<blockquote>
<p><sup>*</sup> ffmpeg 默认将所有参数添加为 <strong>SEI NAL</strong>，很快我们会定义什么是 NAL。</p>
</blockquote>
<p>这个命令会使用下面的图片作为帧，生成一个具有<strong>单个帧</strong>，64x64 和颜色空间为 yuv420 的原始 h264 比特流。</p>
<blockquote>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/minimal.png" alt="使用帧来生成极简 h264 比特流" title="使用帧来生成极简 h264 比特流"></p>
</blockquote>
<h3 id="h-264-比特流">H.264 比特流</h3>
<p>AVC (H.264) 标准规定信息将在宏帧（网络概念上的）内传输，称为 <a href="https://en.wikipedia.org/wiki/Network_Abstraction_Layer" target="_blank" rel="noopener">NAL</a>（网络抽象层）。NAL 的主要目标是提供“网络友好”的视频呈现方式，该标准必须适用于电视（基于流），互联网（基于数据包）等。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/nal_units.png" alt="H.264 NAL 单元" title="H.264 NAL 单元"></p>
<p><a href="https://en.wikipedia.org/wiki/Frame_synchronization" target="_blank" rel="noopener">同步标记</a>用来定义 NAL 单元的边界。每个同步标记的值固定为  <code>0x00 0x00 0x01</code> ，最开头的标记例外，它的值是  <code>0x00 0x00 0x00 0x01</code> 。如果我们在生成的 h264 比特流上运行 <strong>hexdump</strong>，我们可以在文件的开头识别至少三个 NAL。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/minimal_yuv420_hex.png" alt="NAL 单元上的同步标记" title="NAL 单元上的同步标记"></p>
<p>我们之前说过，解码器需要知道不仅仅是图片数据，还有视频的详细信息，如：帧、颜色、使用的参数等。每个 NAL 的<strong>第一位</strong>定义了其分类和<strong>类型</strong>。</p>
<table>
<thead>
<tr>
<th>NAL type id</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Undefined</td>
</tr>
<tr>
<td>1</td>
<td>Coded slice of a non-IDR picture</td>
</tr>
<tr>
<td>2</td>
<td>Coded slice data partition A</td>
</tr>
<tr>
<td>3</td>
<td>Coded slice data partition B</td>
</tr>
<tr>
<td>4</td>
<td>Coded slice data partition C</td>
</tr>
<tr>
<td>5</td>
<td><strong>IDR</strong> Coded slice of an IDR picture</td>
</tr>
<tr>
<td>6</td>
<td><strong>SEI</strong> Supplemental enhancement information</td>
</tr>
<tr>
<td>7</td>
<td><strong>SPS</strong> Sequence parameter set</td>
</tr>
<tr>
<td>8</td>
<td><strong>PPS</strong> Picture parameter set</td>
</tr>
<tr>
<td>9</td>
<td>Access unit delimiter</td>
</tr>
<tr>
<td>10</td>
<td>End of sequence</td>
</tr>
<tr>
<td>11</td>
<td>End of stream</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>通常，比特流的第一个 NAL 是 <strong>SPS</strong>，这个类型的 NAL 负责传达通用编码参数，如<strong>配置，层级，分辨率</strong>等。</p>
<p>如果我们跳过第一个同步标记，就可以通过解码<strong>第一个字节</strong>来了解第一个 <strong>NAL 的类型</strong>。</p>
<p>例如同步标记之后的第一个字节是 <code>01100111</code>，第一位（<code>0</code>）是 <strong>forbidden_zero_bit</strong> 字段，接下来的两位（<code>11</code>）告诉我们是 <strong>nal_ref_idc</strong> 字段，其表示该 NAL 是否是参考字段，其余 5 位（<code>00111</code>）告诉我们是 <strong>nal_unit_type</strong> 字段，在这个例子里是 NAL 单元 <strong>SPS</strong> (7)。</p>
<p>SPS NAL 的第 2 位 (<code>binary=01100100, hex=0x64, dec=100</code>) 是 <strong>profile_idc</strong> 字段，显示编码器使用的配置，在这个例子里，我们使用<a href="https://en.wikipedia.org/wiki/H.264/MPEG-4_AVC#Profiles" target="_blank" rel="noopener">受限高配置</a>，一种没有 B（双向预测） 切片支持的高配置。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/minimal_yuv420_bin.png" alt="SPS 二进制视图" title="SPS 二进制视图"></p>
<p>当我们阅读 SPS NAL 的 H.264 比特流规范时，会为<strong>参数名称</strong>，<strong>分类</strong>和<strong>描述</strong>找到许多值，例如，看看字段 <code>pic_width_in_mbs_minus_1</code> 和 <code>pic_height_in_map_units_minus_1</code>。</p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>分类</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>pic_width_in_mbs_minus_1</td>
<td>0</td>
<td>ue(v)</td>
</tr>
<tr>
<td>pic_height_in_map_units_minus_1</td>
<td>0</td>
<td>ue(v)</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>ue(v)</strong>: 无符号整形 <a href="https://pythonhosted.org/bitstring/exp-golomb.html" target="_blank" rel="noopener">Exp-Golomb-coded</a></p>
</blockquote>
<p>如果我们对这些字段的值进行一些计算，将最终得出<strong>分辨率</strong>。我们可以使用值为 <code>119（ (119 + 1) * macroblock_size = 120 * 16 = 1920）</code>的 <code>pic_width_in_mbs_minus_1</code> 表示 <code>1920 x 1080</code>，再次为了减少空间，我们使用 <code>119</code> 来代替编码 <code>1920</code>。</p>
<p>如果我们再次使用二进制视图检查我们创建的视频 (ex: <code>xxd -b -c 11 v/minimal_yuv420.h264</code>)，可以跳到帧自身上一个 NAL。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/slice_nal_idr_bin.png" alt="h264 idr 切片头" title="h264 idr 切片头"></p>
<p>我们可以看到最开始的 6 个字节：<code>01100101 10001000 10000100 00000000 00100001 11111111</code>。我们已经知道第一个字节告诉我们 NAL 的类型，在这个例子里， (<code>00101</code>) 是 <strong>IDR 切片 (5)</strong>，可以进一步检查它：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/slice_header.png" alt="h264 切片头规格" title="h264 切片头规格"></p>
<p>对照规范，我们能解码切片的类型（<strong>slice_type</strong>），帧号（<strong>frame_num</strong>）等重要字段。</p>
<p>为了获得一些字段（<code>ue(v), me(v), se(v) 或 te(v)</code>）的值，我们需要称为 <a href="https://pythonhosted.org/bitstring/exp-golomb.html" target="_blank" rel="noopener">Exponential-Golomb</a> 的特定解码器来解码它。当存在很多默认值时，这个方法编码变量值特别高效。</p>
<blockquote>
<p>这个视频里 <strong>slice_type</strong> 和 <strong>frame_num</strong> 的值是 7（I 切片）和 0（第一帧）。</p>
</blockquote>
<p>我们可以将<strong>比特流视为一个协议</strong>，如果你想学习更多关于比特流的内容，请参考 <a href="http://www.itu.int/rec/T-REC-H.264-201610-I" target="_blank" rel="noopener">ITU H.264 规范</a>。这个宏观图展示了图片数据（压缩过的 YUV）所在的位置。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/h264_bitstream_macro_diagram.png" alt="h264 比特流宏观图" title="h264 比特流宏观图"></p>
<p>我们可以探究其它比特流，如 <a href="https://storage.googleapis.com/downloads.webmproject.org/docs/vp9/vp9-bitstream-specification-v0.6-20160331-draft.pdf" target="_blank" rel="noopener">VP9 比特流</a>，<a href="http://handle.itu.int/11.1002/1000/11885-en?locatt=format:pdf" target="_blank" rel="noopener">H.265（HEVC）</a>或是我们的新朋友 <a href="https://medium.com/@mbebenita/av1-bitstream-analyzer-d25f1c27072b#.d5a89oxz8" target="_blank" rel="noopener">AV1 比特流</a>，<a href="http://www.gpac-licensing.com/2016/07/12/vp9-av1-bitstream-format/" target="_blank" rel="noopener">他们很相似吗？不</a>，但只要学习了其中之一，学习其他的就简单多了。</p>
<blockquote>
<h3 id="自己动手：检查-h-264-比特流">自己动手：检查 H.264 比特流</h3>
<p>我们可以<a href="https://github.com/leandromoreira/introduction_video_technology/blob/master/encoding_pratical_examples.md#generate-a-single-frame-video" target="_blank" rel="noopener">生成一个单帧视频</a>，使用 <a href="https://en.wikipedia.org/wiki/MediaInfo" target="_blank" rel="noopener">mediainfo</a> 检查它的 H.264 比特流。事实上，你甚至可以查看<a href="https://github.com/MediaArea/MediaInfoLib/blob/master/Source/MediaInfo/Video/File_Avc.cpp" target="_blank" rel="noopener">解析 h264(AVC) 视频流的源代码</a>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/mediainfo_details_1.png" alt="mediainfo h264 比特流的详情 " title="mediainfo h264 比特流的详情"></p>
<p>我们也可使用 <a href="https://software.intel.com/en-us/intel-video-pro-analyzer" target="_blank" rel="noopener">Intel® Video Pro Analyzer</a>，需要付费，但也有只能查看前 10 帧的免费试用版，这已经够达成学习目的了。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/intel-video-pro-analyzer.png" alt="Intel® Video Pro Analyzer h264 比特流的详情" title="Intel® Video Pro Analyzer h264 比特流的详情"></p>
</blockquote>
<h2 id="回顾">回顾</h2>
<p>我们可以看到我们学了许多<strong>使用相同模型的现代编解码器</strong>。事实上，让我们看看 Thor 视频编解码器框图，它包含所有我们学过的步骤。你现在应该能更好地理解数字视频领域内的创新和论文。<br>
<img src="/2020/02/28/Introduction-to-digital-video-technology/thor_codec_block_diagram.png" alt="thor 编解码器块图" title="thor 编解码器块图"></p>
<p>之前我们计算过我们<a href="#%E8%89%B2%E5%BA%A6%E5%AD%90%E9%87%87%E6%A0%B7">需要 139GB 来保存一个一小时，720p 分辨率和30fps的视频文件</a>，如果我们使用在这里学过的技术，如<strong>帧间和帧内预测，转换，量化，熵编码和其它</strong>我们能实现——假设我们<strong>每像素花费 0.031 bit</strong>——同样观感质量的视频，<strong>对比 139GB 的存储，只需 367.82MB</strong>。</p>
<blockquote>
<p>我们根据这里提供的示例视频选择<strong>每像素使用 0.031 bit</strong>。</p>
</blockquote>
<h2 id="h-265-如何实现比-h-264-更好的压缩率">H.265 如何实现比 H.264 更好的压缩率</h2>
<p>我们已经更多地了解了编解码器的工作原理，那么就容易理解新的编解码器如何使用更少的数据量传输更高分辨率的视频。</p>
<p>我们将比较 AVC 和 HEVC，要记住的是：我们几乎总是要在压缩率和更多的 CPU 周期（复杂度）之间作权衡。</p>
<p>HEVC 比 AVC 有更大和更多的<strong>分区</strong>（和<strong>子分区</strong>）选项，更多<strong>帧内预测方向</strong>，<strong>改进的熵编码</strong>等，所有这些改进使得 H.265 比 H.264 的压缩率提升 50%。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/avc_vs_hevc.png" alt="h264 vs h265" title="H.264 vs H.265"></p>
<h1>在线流媒体</h1>
<h2 id="通用架构">通用架构</h2>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/general_architecture.png" alt="general_architecture"></p>
<p>[TODO]</p>
<h2 id="渐进式下载和自适应流">渐进式下载和自适应流</h2>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/progressive_download.png" alt="progressive_download"></p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/adaptive_streaming.png" alt="adaptive_streaming"></p>
<p>[TODO]</p>
<h2 id="内容保护">内容保护</h2>
<p>我们可以用一个简单的令牌认证系统来保护视频。用户需要拥有一个有效的令牌才可以播放视频，CDN 会拒绝没有令牌的用户的请求。它与大多数网站的身份认证系统非常相似。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/token_protection.png" alt="token_protection"></p>
<p>仅仅使用令牌认证系统，用户仍然可以下载并重新分发视频。DRM 系统可以用来避免这种情况。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/drm.png" alt="drm"></p>
<p>实际情况下，人们通常同时使用这两种技术提供授权和认证。</p>
<h3 id="drm">DRM</h3>
<h4 id="主要系统">主要系统</h4>
<ul>
<li>FPS - <a href="https://developer.apple.com/streaming/fps/" target="_blank" rel="noopener"><strong>FairPlay Streaming</strong></a></li>
<li>PR - <a href="https://www.microsoft.com/playready/" target="_blank" rel="noopener"><strong>PlayReady</strong></a></li>
<li>WV - <a href="http://www.widevine.com/" target="_blank" rel="noopener"><strong>Widevine</strong></a></li>
</ul>
<h4 id="是什么">是什么</h4>
<p>DRM 指的是数字版权管理，是一种<strong>为数字媒体提供版权保护</strong>的方法，例如数字视频和音频。尽管用在了很多场合，但它并<a href="https://en.wikipedia.org/wiki/Digital_rights_management#DRM-free_works" target="_blank" rel="noopener">没有被普遍接受</a>.</p>
<h4 id="为什么">为什么</h4>
<p>内容的创作者（大多是工作室/制片厂）希望保护他们的知识产权，使他们的数字媒体免遭未经授权的分发。</p>
<h4 id="怎么做">怎么做</h4>
<p>我们将用一种简单的、抽象的方式描述 DRM</p>
<p>现有一份<strong>内容 C1</strong>（如 HLS 或 DASH 视频流），一个<strong>播放器 P1</strong>（如 shaka-clappr, exo-player 或 iOS），装在<strong>设备 D1</strong>（如智能手机、电视或台式机/笔记本）上，使用 <strong>DRM 系统 DRM1</strong>（如 FairPlay Streaming, PlayReady, Widevine）</p>
<p>内容 C1 由 DRM1 用一个<strong>对称密钥 K1</strong> 加密，生成<strong>加密内容 C’1</strong></p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/drm_general_flow.jpeg" alt="DRM 一般流程" title="DRM 一般流程"></p>
<p>设备 D1 上的播放器 P1 有一个非对称密钥对，密钥对包含一个<strong>私钥 PRK1</strong>（这个密钥是受保护的<sup>1</sup>，只有 <strong>D1</strong> 知道密钥内容），和一个<strong>公钥 PUK1</strong></p>
<blockquote>
<p><strong><sup>1</sup>受保护的</strong>: 这种保护可以<strong>通过硬件</strong>进行保护，例如, 将这个密钥存储在一个特殊的芯片（只读）中，芯片的工作方式就像一个用来解密的[黑箱]。 或<strong>通过软件</strong>进行保护（较低的安全系数）。DRM 系统提供了识别设备所使用的保护类型的方法。</p>
</blockquote>
<p>当 <strong>播放器 P1 希望播放****加密内容 C’1</strong> 时，它需要与 <strong>DRM1</strong> 协商，将公钥 <strong>PUK1</strong> 发送给 DRM1, DRM1 会返回一个被公钥 <strong>PUK1</strong> <strong>加密过的 K1</strong>。按照推论，结果就是<strong>只有 D1 能够解密</strong>。</p>
<p><code>K1P1D1 = enc(K1, PUK1)</code></p>
<p><strong>P1</strong> 使用它的本地 DRM 系统（这可以使用 <a href="https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%8A%AF%E7%89%87" target="_blank" rel="noopener">SoC</a> ，一个专门的硬件和软件，这个系统可以使用它的私钥 PRK1 用来<strong>解密</strong>内容，它可以解密被加密过的<strong>K1P1D1 的对称密钥 K1</strong>。理想情况下，密钥不会被导出到内存以外的地方。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">K1 &#x3D; dec(K1P1D1, PRK1)</span><br><span class="line"></span><br><span class="line">P1.play(dec(C&#39;1, K1))</span><br></pre></td></tr></table></figure>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/drm_decoder_flow.jpeg" alt="DRM 解码流程" title="DRM 解码流程"></p>
<h1>如何使用 jupyter</h1>
<p>确保你已安装 docker，只需运行 <code>./s/start_jupyter.sh</code>，然后按照控制台的说明进行操作。</p>
<h1>会议</h1>
<ul>
<li><a href="https://demuxed.com/" target="_blank" rel="noopener">DEMUXED</a> - 您可以<a href="https://www.youtube.com/channel/UCIc_DkRxo9UgUSTvWVNCmpA" target="_blank" rel="noopener">查看最近的2个活动演示</a>。</li>
</ul>
<h1>参考</h1>
<p>这里有最丰富的资源，这篇文档包含的信息，均摘录、依据或受它们启发。你可以用这些精彩的链接，书籍，视频等深化你的知识。</p>
<p>在线课程和教程：</p>
<ul>
<li><a href="https://www.coursera.org/learn/digital/" target="_blank" rel="noopener">https://www.coursera.org/learn/digital/</a></li>
<li><a href="https://people.xiph.org/~tterribe/pubs/lca2012/auckland/intro_to_video1.pdf" target="_blank" rel="noopener">https://people.xiph.org/~tterribe/pubs/lca2012/auckland/intro_to_video1.pdf</a></li>
<li><a href="https://xiph.org/video/vid1.shtml" target="_blank" rel="noopener">https://xiph.org/video/vid1.shtml</a></li>
<li><a href="https://xiph.org/video/vid2.shtml" target="_blank" rel="noopener">https://xiph.org/video/vid2.shtml</a></li>
<li><a href="http://slhck.info/ffmpeg-encoding-course" target="_blank" rel="noopener">http://slhck.info/ffmpeg-encoding-course</a></li>
<li><a href="http://www.cambridgeincolour.com/tutorials/camera-sensors.htm" target="_blank" rel="noopener">http://www.cambridgeincolour.com/tutorials/camera-sensors.htm</a></li>
<li><a href="http://www.slideshare.net/vcodex/a-short-history-of-video-coding" target="_blank" rel="noopener">http://www.slideshare.net/vcodex/a-short-history-of-video-coding</a></li>
<li><a href="http://www.slideshare.net/vcodex/introduction-to-video-compression-13394338" target="_blank" rel="noopener">http://www.slideshare.net/vcodex/introduction-to-video-compression-1339433</a></li>
<li><a href="https://developer.android.com/guide/topics/media/media-formats.html" target="_blank" rel="noopener">https://developer.android.com/guide/topics/media/media-formats.html</a></li>
<li><a href="http://www.slideshare.net/MadhawaKasun/audio-compression-23398426" target="_blank" rel="noopener">http://www.slideshare.net/MadhawaKasun/audio-compression-23398426</a></li>
<li><a href="http://inst.eecs.berkeley.edu/~ee290t/sp04/lectures/02-Motion_Compensation_girod.pdf" target="_blank" rel="noopener">http://inst.eecs.berkeley.edu/~ee290t/sp04/lectures/02-Motion_Compensation_girod.pdf</a></li>
</ul>
<p>书籍:</p>
<ul>
<li><a href="https://www.amazon.com/Understanding-Compression-Data-Modern-Developers/dp/1491961538/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1486395327&amp;sr=1-1" target="_blank" rel="noopener">https://www.amazon.com/Understanding-Compression-Data-Modern-Developers/dp/1491961538/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1486395327&amp;sr=1-1</a></li>
<li><a href="https://www.amazon.com/H-264-Advanced-Video-Compression-Standard/dp/0470516925" target="_blank" rel="noopener">https://www.amazon.com/H-264-Advanced-Video-Compression-Standard/dp/0470516925</a></li>
<li><a href="https://www.amazon.com/Practical-Guide-Video-Audio-Compression/dp/0240806301/ref=sr_1_3?s=books&amp;ie=UTF8&amp;qid=1486396914&amp;sr=1-3&amp;keywords=A+PRACTICAL+GUIDE+TO+VIDEO+AUDIO" target="_blank" rel="noopener">https://www.amazon.com/Practical-Guide-Video-Audio-Compression/dp/0240806301/ref=sr_1_3?s=books&amp;ie=UTF8&amp;qid=1486396914&amp;sr=1-3&amp;keywords=A+PRACTICAL+GUIDE+TO+VIDEO+AUDIO</a></li>
<li><a href="https://www.amazon.com/Video-Encoding-Numbers-Eliminate-Guesswork/dp/0998453005/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1486396940&amp;sr=1-1&amp;keywords=jan+ozer" target="_blank" rel="noopener">https://www.amazon.com/Video-Encoding-Numbers-Eliminate-Guesswork/dp/0998453005/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1486396940&amp;sr=1-1&amp;keywords=jan+ozer</a></li>
</ul>
<p>比特流规范:</p>
<ul>
<li><a href="http://www.itu.int/rec/T-REC-H.264-201610-I" target="_blank" rel="noopener">http://www.itu.int/rec/T-REC-H.264-201610-I</a></li>
<li><a href="http://www.itu.int/ITU-T/recommendations/rec.aspx?rec=12904&amp;lang=en" target="_blank" rel="noopener">http://www.itu.int/ITU-T/recommendations/rec.aspx?rec=12904&amp;lang=en</a></li>
<li><a href="https://storage.googleapis.com/downloads.webmproject.org/docs/vp9/vp9-bitstream-specification-v0.6-20160331-draft.pdf" target="_blank" rel="noopener">https://storage.googleapis.com/downloads.webmproject.org/docs/vp9/vp9-bitstream-specification-v0.6-20160331-draft.pdf</a></li>
<li><a href="http://iphome.hhi.de/wiegand/assets/pdfs/2012_12_IEEE-HEVC-Overview.pdf" target="_blank" rel="noopener">http://iphome.hhi.de/wiegand/assets/pdfs/2012_12_IEEE-HEVC-Overview.pdf</a></li>
<li><a href="http://phenix.int-evry.fr/jct/doc_end_user/current_document.php?id=7243" target="_blank" rel="noopener">http://phenix.int-evry.fr/jct/doc_end_user/current_document.php?id=7243</a></li>
<li><a href="http://gentlelogic.blogspot.com.br/2011/11/exploring-h264-part-2-h264-bitstream.html" target="_blank" rel="noopener">http://gentlelogic.blogspot.com.br/2011/11/exploring-h264-part-2-h264-bitstream.html</a></li>
</ul>
<p>软件:</p>
<ul>
<li><a href="https://ffmpeg.org/" target="_blank" rel="noopener">https://ffmpeg.org/</a></li>
<li><a href="https://ffmpeg.org/ffmpeg-all.html" target="_blank" rel="noopener">https://ffmpeg.org/ffmpeg-all.html</a></li>
<li><a href="https://ffmpeg.org/ffprobe.html" target="_blank" rel="noopener">https://ffmpeg.org/ffprobe.html</a></li>
<li><a href="https://trac.ffmpeg.org/wiki/" target="_blank" rel="noopener">https://trac.ffmpeg.org/wiki/</a></li>
<li><a href="https://software.intel.com/en-us/intel-video-pro-analyzer" target="_blank" rel="noopener">https://software.intel.com/en-us/intel-video-pro-analyzer</a></li>
<li><a href="https://medium.com/@mbebenita/av1-bitstream-analyzer-d25f1c27072b#.d5a89oxz8" target="_blank" rel="noopener">https://medium.com/@mbebenita/av1-bitstream-analyzer-d25f1c27072b#.d5a89oxz8</a></li>
</ul>
<p>非-ITU 编解码器:</p>
<ul>
<li><a href="https://aomedia.googlesource.com/" target="_blank" rel="noopener">https://aomedia.googlesource.com/</a></li>
<li><a href="https://github.com/webmproject/libvpx/tree/master/vp9" target="_blank" rel="noopener">https://github.com/webmproject/libvpx/tree/master/vp9</a></li>
<li><a href="https://people.xiph.org/~xiphmont/demo/daala/demo1.shtml" target="_blank" rel="noopener">https://people.xiph.org/~xiphmont/demo/daala/demo1.shtml</a></li>
<li><a href="https://people.xiph.org/~jm/daala/revisiting/" target="_blank" rel="noopener">https://people.xiph.org/~jm/daala/revisiting/</a></li>
<li><a href="https://www.youtube.com/watch?v=lzPaldsmJbk" target="_blank" rel="noopener">https://www.youtube.com/watch?v=lzPaldsmJbk</a></li>
<li><a href="https://fosdem.org/2017/schedule/event/om_av1/" target="_blank" rel="noopener">https://fosdem.org/2017/schedule/event/om_av1/</a></li>
</ul>
<p>编码概念:</p>
<ul>
<li><a href="http://x265.org/hevc-h265/" target="_blank" rel="noopener">http://x265.org/hevc-h265/</a></li>
<li><a href="http://slhck.info/video/2017/03/01/rate-control.html" target="_blank" rel="noopener">http://slhck.info/video/2017/03/01/rate-control.html</a></li>
<li><a href="http://slhck.info/video/2017/02/24/vbr-settings.html" target="_blank" rel="noopener">http://slhck.info/video/2017/02/24/vbr-settings.html</a></li>
<li><a href="http://slhck.info/video/2017/02/24/crf-guide.html" target="_blank" rel="noopener">http://slhck.info/video/2017/02/24/crf-guide.html</a></li>
<li><a href="https://arxiv.org/pdf/1702.00817v1.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1702.00817v1.pdf</a></li>
<li><a href="https://trac.ffmpeg.org/wiki/Debug/MacroblocksAndMotionVectors" target="_blank" rel="noopener">https://trac.ffmpeg.org/wiki/Debug/MacroblocksAndMotionVectors</a></li>
<li><a href="http://web.ece.ucdavis.edu/cerl/ReliableJPEG/Cung/jpeg.html" target="_blank" rel="noopener">http://web.ece.ucdavis.edu/cerl/ReliableJPEG/Cung/jpeg.html</a></li>
<li><a href="http://www.adobe.com/devnet/adobe-media-server/articles/h264_encoding.html" target="_blank" rel="noopener">http://www.adobe.com/devnet/adobe-media-server/articles/h264_encoding.html</a></li>
<li><a href="https://prezi.com/8m7thtvl4ywr/mp3-and-aac-explained/" target="_blank" rel="noopener">https://prezi.com/8m7thtvl4ywr/mp3-and-aac-explained/</a></li>
</ul>
<p>测试用视频序列:</p>
<ul>
<li><a href="http://bbb3d.renderfarming.net/download.html" target="_blank" rel="noopener">http://bbb3d.renderfarming.net/download.html</a></li>
<li><a href="https://www.its.bldrdoc.gov/vqeg/video-datasets-and-organizations.aspx" target="_blank" rel="noopener">https://www.its.bldrdoc.gov/vqeg/video-datasets-and-organizations.aspx</a></li>
</ul>
<p>杂项:</p>
<ul>
<li><a href="http://stackoverflow.com/a/24890903" target="_blank" rel="noopener">http://stackoverflow.com/a/24890903</a></li>
<li><a href="http://stackoverflow.com/questions/38094302/how-to-understand-header-of-h264" target="_blank" rel="noopener">http://stackoverflow.com/questions/38094302/how-to-understand-header-of-h264</a></li>
<li><a href="http://techblog.netflix.com/2016/08/a-large-scale-comparison-of-x264-x265.html" target="_blank" rel="noopener">http://techblog.netflix.com/2016/08/a-large-scale-comparison-of-x264-x265.html</a></li>
<li><a href="http://vanseodesign.com/web-design/color-luminance/" target="_blank" rel="noopener">http://vanseodesign.com/web-design/color-luminance/</a></li>
<li><a href="http://www.biologymad.com/nervoussystem/eyenotes.htm" target="_blank" rel="noopener">http://www.biologymad.com/nervoussystem/eyenotes.htm</a></li>
<li><a href="http://www.compression.ru/video/codec_comparison/h264_2012/mpeg4_avc_h264_video_codecs_comparison.pdf" target="_blank" rel="noopener">http://www.compression.ru/video/codec_comparison/h264_2012/mpeg4_avc_h264_video_codecs_comparison.pdf</a></li>
<li><a href="http://www.csc.villanova.edu/~rschumey/csc4800/dct.html" target="_blank" rel="noopener">http://www.csc.villanova.edu/~rschumey/csc4800/dct.html</a></li>
<li><a href="http://www.explainthatstuff.com/digitalcameras.html" target="_blank" rel="noopener">http://www.explainthatstuff.com/digitalcameras.html</a></li>
<li><a href="http://www.hkvstar.com" target="_blank" rel="noopener">http://www.hkvstar.com</a></li>
<li><a href="http://www.hometheatersound.com/" target="_blank" rel="noopener">http://www.hometheatersound.com/</a></li>
<li><a href="http://www.lighterra.com/papers/videoencodingh264/" target="_blank" rel="noopener">http://www.lighterra.com/papers/videoencodingh264/</a></li>
<li><a href="http://www.red.com/learn/red-101/video-chroma-subsampling" target="_blank" rel="noopener">http://www.red.com/learn/red-101/video-chroma-subsampling</a></li>
<li><a href="http://www.slideshare.net/ManoharKuse/hevc-intra-coding" target="_blank" rel="noopener">http://www.slideshare.net/ManoharKuse/hevc-intra-coding</a></li>
<li><a href="http://www.slideshare.net/mwalendo/h264vs-hevc" target="_blank" rel="noopener">http://www.slideshare.net/mwalendo/h264vs-hevc</a></li>
<li><a href="http://www.slideshare.net/rvarun7777/final-seminar-46117193" target="_blank" rel="noopener">http://www.slideshare.net/rvarun7777/final-seminar-46117193</a></li>
<li><a href="http://www.springer.com/cda/content/document/cda_downloaddocument/9783642147029-c1.pdf" target="_blank" rel="noopener">http://www.springer.com/cda/content/document/cda_downloaddocument/9783642147029-c1.pdf</a></li>
<li><a href="http://www.streamingmedia.com/Articles/Editorial/Featured-Articles/A-Progress-Report-The-Alliance-for-Open-Media-and-the-AV1-Codec-110383.aspx" target="_blank" rel="noopener">http://www.streamingmedia.com/Articles/Editorial/Featured-Articles/A-Progress-Report-The-Alliance-for-Open-Media-and-the-AV1-Codec-110383.aspx</a></li>
<li><a href="http://www.streamingmediaglobal.com/Articles/ReadArticle.aspx?ArticleID=116505&amp;PageNum=1" target="_blank" rel="noopener">http://www.streamingmediaglobal.com/Articles/ReadArticle.aspx?ArticleID=116505&amp;PageNum=1</a></li>
<li><a href="http://yumichan.net/video-processing/video-compression/introduction-to-h264-nal-unit/" target="_blank" rel="noopener">http://yumichan.net/video-processing/video-compression/introduction-to-h264-nal-unit/</a></li>
<li><a href="https://cardinalpeak.com/blog/the-h-264-sequence-parameter-set/" target="_blank" rel="noopener">https://cardinalpeak.com/blog/the-h-264-sequence-parameter-set/</a></li>
<li><a href="https://cardinalpeak.com/blog/worlds-smallest-h-264-encoder/" target="_blank" rel="noopener">https://cardinalpeak.com/blog/worlds-smallest-h-264-encoder/</a></li>
<li><a href="https://codesequoia.wordpress.com/category/video/" target="_blank" rel="noopener">https://codesequoia.wordpress.com/category/video/</a></li>
<li><a href="https://developer.apple.com/library/content/technotes/tn2224/_index.html" target="_blank" rel="noopener">https://developer.apple.com/library/content/technotes/tn2224/_index.html</a></li>
<li><a href="https://en.wikibooks.org/wiki/MeGUI/x264_Settings" target="_blank" rel="noopener">https://en.wikibooks.org/wiki/MeGUI/x264_Settings</a></li>
<li><a href="https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming</a></li>
<li><a href="https://en.wikipedia.org/wiki/AOMedia_Video_1" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/AOMedia_Video_1</a></li>
<li><a href="https://en.wikipedia.org/wiki/Chroma_subsampling#/media/File:Colorcomp.jpg" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Chroma_subsampling#/media/File:Colorcomp.jpg</a></li>
<li><a href="https://en.wikipedia.org/wiki/Cone_cell" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Cone_cell</a></li>
<li><a href="https://en.wikipedia.org/wiki/File:H.264_block_diagram_with_quality_score.jpg" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/File:H.264_block_diagram_with_quality_score.jpg</a></li>
<li><a href="https://en.wikipedia.org/wiki/Inter_frame" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Inter_frame</a></li>
<li><a href="https://en.wikipedia.org/wiki/Intra-frame_coding" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Intra-frame_coding</a></li>
<li><a href="https://en.wikipedia.org/wiki/Photoreceptor_cell" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Photoreceptor_cell</a></li>
<li><a href="https://en.wikipedia.org/wiki/Pixel_aspect_ratio" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Pixel_aspect_ratio</a></li>
<li><a href="https://en.wikipedia.org/wiki/Presentation_timestamp" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Presentation_timestamp</a></li>
<li><a href="https://en.wikipedia.org/wiki/Rod_cell" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Rod_cell</a></li>
<li><a href="https://it.wikipedia.org/wiki/File:Pixel_geometry_01_Pengo.jpg" target="_blank" rel="noopener">https://it.wikipedia.org/wiki/File:Pixel_geometry_01_Pengo.jpg</a></li>
<li><a href="https://leandromoreira.com.br/2016/10/09/how-to-measure-video-quality-perception/" target="_blank" rel="noopener">https://leandromoreira.com.br/2016/10/09/how-to-measure-video-quality-perception/</a></li>
<li><a href="https://sites.google.com/site/linuxencoding/x264-ffmpeg-mapping" target="_blank" rel="noopener">https://sites.google.com/site/linuxencoding/x264-ffmpeg-mapping</a></li>
<li><a href="https://softwaredevelopmentperestroika.wordpress.com/2014/02/11/image-processing-with-python-numpy-scipy-image-convolution/" target="_blank" rel="noopener">https://softwaredevelopmentperestroika.wordpress.com/2014/02/11/image-processing-with-python-numpy-scipy-image-convolution/</a></li>
<li><a href="https://tools.ietf.org/html/draft-fuldseth-netvc-thor-03" target="_blank" rel="noopener">https://tools.ietf.org/html/draft-fuldseth-netvc-thor-03</a></li>
<li><a href="https://www.encoding.com/android/" target="_blank" rel="noopener">https://www.encoding.com/android/</a></li>
<li><a href="https://www.encoding.com/http-live-streaming-hls/" target="_blank" rel="noopener">https://www.encoding.com/http-live-streaming-hls/</a></li>
<li><a href="https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm" target="_blank" rel="noopener">https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm</a></li>
<li><a href="https://www.lifewire.com/cmos-image-sensor-493271" target="_blank" rel="noopener">https://www.lifewire.com/cmos-image-sensor-493271</a></li>
<li><a href="https://www.linkedin.com/pulse/brief-history-video-codecs-yoav-nativ" target="_blank" rel="noopener">https://www.linkedin.com/pulse/brief-history-video-codecs-yoav-nativ</a></li>
<li><a href="https://www.linkedin.com/pulse/video-streaming-methodology-reema-majumdar" target="_blank" rel="noopener">https://www.linkedin.com/pulse/video-streaming-methodology-reema-majumdar</a></li>
<li><a href="https://www.vcodex.com/h264avc-intra-precition/" target="_blank" rel="noopener">https://www.vcodex.com/h264avc-intra-precition/</a></li>
<li><a href="https://www.youtube.com/watch?v=9vgtJJ2wwMA" target="_blank" rel="noopener">https://www.youtube.com/watch?v=9vgtJJ2wwMA</a></li>
<li><a href="https://www.youtube.com/watch?v=LFXN9PiOGtY" target="_blank" rel="noopener">https://www.youtube.com/watch?v=LFXN9PiOGtY</a></li>
<li><a href="https://www.youtube.com/watch?v=Lto-ajuqW3w&amp;list=PLzH6n4zXuckpKAj1_88VS-8Z6yn9zX_P6" target="_blank" rel="noopener">https://www.youtube.com/watch?v=Lto-ajuqW3w&amp;list=PLzH6n4zXuckpKAj1_88VS-8Z6yn9zX_P6</a></li>
<li><a href="https://www.youtube.com/watch?v=LWxu4rkZBLw" target="_blank" rel="noopener">https://www.youtube.com/watch?v=LWxu4rkZBLw</a></li>
</ul>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>数字视频</tag>
      </tags>
  </entry>
  <entry>
    <title>如何计算MS-SSIM</title>
    <url>/2020/02/25/how-to-calculate-the-MS-SSIM/</url>
    <content><![CDATA[<h2 id="ssim的本质及其缺点">SSIM的本质及其缺点</h2>
<p>在<a href="/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/">FFMpeg如何计算图像的SSIM</a>中，详细介绍了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的相关概念，并对FFMpeg中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>实现做了详细的分析。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法基于HVS更擅长从图像中提取结构信息的事实，并且利用结构相似度来计算图像的感知质量。在Z. Wang等人的论文<strong>Multi-scale structural similarity for image quality assessment</strong>中也提到，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法要好于当时的其它的感知图像质量指标。</p>
<p>就其本质而言，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>是一种单尺度的算法，但是实际上正确的图像尺度取决于用户的观看条件，例如显示设备的分辨率，用户的观看距离等。因此，用单尺度的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法来评估图像的感知质量也存在其缺点。</p>
<a id="more"></a>
<h2 id="ms-ssim的基本概念">MS-SSIM的基本概念</h2>
<p>图像细节的可感知性取决于：</p>
<ul>
<li>图像信号的采样密度</li>
<li>用户的观看距离</li>
<li>HVS的感知能力</li>
</ul>
<p>当如上的因素发生变化时，则对给定图像的主观评估也会随之发生变化。单尺度的SSIM算法可能仅适用于某个特定的配置。为了解决该问题，论文<strong>Multi-scale structural similarity for image quality assessment</strong>在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法的基础上提出了如图1所示的多尺度的结构相似性评估算法，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法。</p>
<p><img src="/2020/02/25/how-to-calculate-the-MS-SSIM/1.jpg" alt="图1. MS-SSIM算法"></p>
<p>图1. MS-SSIM算法，L 表示低通滤波器，2↓ 表示采样间隔为2的下采样</p>
<p>因此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>实际上是一种以不同分辨率合并图像细节的图像质量评估方法。对于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>，原始图像的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">scale=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，图像的最大<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo>=</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">scale=M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo>=</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">scale=j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span></span></span>的尺度而言，其亮度、对比度、结构的相似性分别表示为：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>l</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l_j(X,Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">c_j(X,Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_j(X,Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></li>
</ul>
<p>因此，根据图1可以得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的计算方式。</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mo fence="false">[</mo><msub><mi>l</mi><mi>M</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>α</mi><mi>M</mi></msub></msup><mo>⋅</mo><munderover><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mrow><mo fence="false">[</mo><msub><mi>c</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>β</mi><mi>j</mi></msub></msup><mo fence="false">[</mo><msub><mi>s</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>γ</mi><mi>j</mi></msub></msup></mrow></mrow><annotation encoding="application/x-tex">MS-SSIM(X,Y)=\big[l_M(X,Y)\big]^{\alpha_M} \cdot \prod _{j=1}^{M}  {\big[c_j(X,Y)\big]^{\beta_j}\big[s_j(X,Y)\big]^{\gamma_j}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.254302em;vertical-align:-0.35001em;"></span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.904292em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.2421130000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000006em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.089008em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.05278em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.904292em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.05556em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>一般，令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>j</mi></msub><mo>=</mo><msub><mi>β</mi><mi>j</mi></msub><mo>=</mo><msub><mi>γ</mi><mi>j</mi></msub><mtext>  </mtext><mo separator="true">,</mo><mtext> </mtext><mi>j</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\alpha_j=\beta_j=\gamma_j \ \ , \ j \in [1, M]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9456279999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace"> </span><span class="mspace"> </span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mclose">]</span></span></span></span>，我们得到：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mo fence="false">[</mo><msub><mi>l</mi><mi>M</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>α</mi><mi>M</mi></msub></msup><mo>⋅</mo><munderover><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mrow><mo fence="false">[</mo><msub><mi>c</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>s</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>α</mi><mi>j</mi></msub></msup></mrow></mrow><annotation encoding="application/x-tex">MS-SSIM(X,Y)=\big[l_M(X,Y)\big]^{\alpha_M} \cdot \prod _{j=1}^{M}  {\big[c_j(X,Y) \cdot s_j(X,Y)\big]^{\alpha_j}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.254302em;vertical-align:-0.35001em;"></span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.904292em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.2421130000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000006em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.904292em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>Multi-scale structural similarity for image quality assessment</strong>给出了一种计算各尺度参数的方法，并同时给出不同尺度的参数值：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>1</mn></msub><mo>=</mo><mn>0.0448</mn></mrow><annotation encoding="application/x-tex">\alpha_1=0.0448</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">4</span><span class="mord">4</span><span class="mord">8</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>2</mn></msub><mo>=</mo><mn>0.2856</mn></mrow><annotation encoding="application/x-tex">\alpha_2=0.2856</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">8</span><span class="mord">5</span><span class="mord">6</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>3</mn></msub><mo>=</mo><mn>0.3001</mn></mrow><annotation encoding="application/x-tex">\alpha_3=0.3001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">3</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>4</mn></msub><mo>=</mo><mn>0.2363</mn></mrow><annotation encoding="application/x-tex">\alpha_4=0.2363</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">3</span><span class="mord">6</span><span class="mord">3</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>5</mn></msub><mo>=</mo><mn>0.1333</mn></mrow><annotation encoding="application/x-tex">\alpha_5=0.1333</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">3</span><span class="mord">3</span><span class="mord">3</span></span></span></span></li>
</ul>
<h2 id="ms-ssim算法的实现">MS-SSIM算法的实现</h2>
<p>采用FFMpeg中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的实现方式来实现<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。根据<a href="/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/">FFMpeg如何计算图像的SSIM</a>的介绍：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mo fence="false">(</mo><mfrac><mrow><mn>2</mn><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>s</mi><mn>2</mn><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>1</mn></msub></mrow><mrow><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>1</mn></msub></mrow></mfrac><msup><mo fence="false">)</mo><msub><mi>α</mi><mi>M</mi></msub></msup><mo>⋅</mo><munderover><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mo fence="false">(</mo><mfrac><mrow><mn>2</mn><mi>c</mi><mi>o</mi><mi>v</mi><mi>a</mi><mi>r</mi><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>2</mn></msub></mrow><mrow><mi>v</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>2</mn></msub></mrow></mfrac><msup><mo fence="false">)</mo><msub><mi>α</mi><mi>j</mi></msub></msup></mrow><annotation encoding="application/x-tex">MS-SSIM(X,Y)=\bigg(\frac{2s1 \cdot s2 + ssimC_{1}}{s1^2+s2^2+ssimC_{1}}\bigg)^{\alpha_{M}} \cdot \prod _{j=1}^{M}\bigg(\frac{2covar + ssimC_2}{vars + ssimC_2}\bigg)^{\alpha_j}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.454322em;vertical-align:-0.95003em;"></span><span class="mord"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord"><span class="delimsizing size3">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.504292em;"><span style="top:-3.9029000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.2421130000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000006em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord"><span class="delimsizing size3">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.5042920000000002em;"><span style="top:-3.9029000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>对于图像采样而言，采用简单的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>×</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2 \times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>的卷积核执行图像的下采样，：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
\frac{1}{4} &amp; \frac{1}{4} \\\\
\frac{1}{4} &amp; \frac{1}{4} \\\\
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.8102160000000005em;vertical-align:-2.1551080000000002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6529999999999996em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.79999em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.3959900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.4119800000000002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.653em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6551080000000002em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-2.404892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.2048919999999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1551080000000002em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6551080000000002em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.4048920000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9551079999999996em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6529999999999996em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.79999em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.3959900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.4119800000000002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.653em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>具体的采样代码如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void downsample_2x2_mean(pixel *input, int width, int height, pixel *output) &#123;</span><br><span class="line">    int downsample_width &#x3D;  width &gt;&gt; 1;</span><br><span class="line">    int downsample_height &#x3D; height &gt;&gt; 1;</span><br><span class="line"></span><br><span class="line">    for (int y &#x3D; 0; y &lt; downsample_height; y++) &#123;</span><br><span class="line">        for (int x &#x3D;0; x &lt; downsample_width; x++) &#123;</span><br><span class="line">            output[y * downsample_width + x] &#x3D; (input[2 * y * width + 2 * x] +</span><br><span class="line">                                                input[2 * y * width + 2 * x + 1] +</span><br><span class="line">                                                input[(2 * y + 1) * width + 2 * x] +</span><br><span class="line">                                                input[(2 * y + 1) * width + 2 * x + 1]) &#x2F; 4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后利用<a href="https://github.com/FFmpeg/FFmpeg/blob/master/tests/tiny_ssim.c" target="_blank" rel="noopener">tiny_ssim</a>中的<code>ssim_plane()</code>迭代计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">float ms_ssim_plane(pixel *pix1, pixel *pix2, int width, int height, int scale) &#123;</span><br><span class="line">    for (int i &#x3D; 0; i &lt; w * h; i++) &#123;</span><br><span class="line">        ori_img1[i] &#x3D; pix1[i];</span><br><span class="line">        ori_img2[i] &#x3D; pix2[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 计算每个尺度的ssim值.</span><br><span class="line">    for (int i &#x3D; 1; i &lt;&#x3D; scale; i++) &#123;</span><br><span class="line">        if (i !&#x3D; 1) &#123;</span><br><span class="line">            downsample_2x2_mean(ori_img1, w, h, sample_img1);</span><br><span class="line">            downsample_2x2_mean(ori_img2, w, h, sample_img2);</span><br><span class="line">            w &#x3D; w &gt;&gt; 1;</span><br><span class="line">            h &#x3D; h &gt;&gt; 1;</span><br><span class="line">            for (int j &#x3D; 0; j &lt; w * h; j++) &#123;</span><br><span class="line">                ori_img1[j] &#x3D; sample_img1[j];</span><br><span class="line">                ori_img2[j] &#x3D; sample_img2[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        value &#x3D; ssim_plane(ori_img1, w, ori_img2, w, w, h, temp, NULL);</span><br><span class="line">        result *&#x3D; pow(value.C_S, WEIGHT[i-1]);</span><br><span class="line">        luminance_value[i-1] &#x3D; value.L;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result *&#x3D; pow(luminance_value[scale-1], WEIGHT[scale-1]);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整的代码可以参考<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/25/how-to-calculate-the-MS-SSIM/test_msssim.cpp" target="_blank" rel="noopener">test_msssim.cpp</a>。代码的很大部分是由我的同事<em>贤杰</em>(github: <a href="https://github.com/bodhisatan" target="_blank" rel="noopener">@bodhisatan</a>)实现的，在此一并表示感谢。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>SSIM</tag>
        <tag>MS-SSIM</tag>
      </tags>
  </entry>
  <entry>
    <title>The Proof of the ssim_end1() in FFMpeg</title>
    <url>/2020/02/18/the-proof-of-the-SSIM-in-FFMpeg/</url>
    <content><![CDATA[<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><msub><mi>μ</mi><mi>a</mi></msub><msub><mi>μ</mi><mi>b</mi></msub><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>σ</mi><mrow><mi>a</mi><mi>b</mi></mrow></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>a</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>b</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mi>σ</mi><mi>a</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>b</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">SSIM(a,b)=\frac{(2\mu_a\mu_b+C_1)(2\sigma_{ab}+C_2)}{(\mu_a^2+\mu_b^2+C_1)(\sigma_a^2+\sigma_b^2+C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.414308em;vertical-align:-0.9873080000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959079999999998em;"><span style="top:-2.398692em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30130799999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959079999999998em;"><span style="top:-2.398692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30130799999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9873080000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>a</mi></msub><mo>=</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mi>f</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">\mu_a=\frac{1}{64}fs1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span></span></p>
<a id="more"></a>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>b</mi></msub><mo>=</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mi>f</mi><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\mu_b=\frac{1}{64}fs2
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>a</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>b</mi><mn>2</mn></msubsup><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mi>μ</mi><mi>a</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mi>μ</mi><mi>b</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_a^2+\sigma_b^2=\frac{1}{63}(\sum_{i,j}(a(i,j)-\mu_a)^2 + \sum_{i,j}(b(i,j)-\mu_b)^2)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.735217em;vertical-align:-1.413777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.463782em;vertical-align:-1.413777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><msubsup><mi>μ</mi><mi>a</mi><mn>2</mn></msubsup><mo>−</mo><mn>2</mn><mo>⋅</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>μ</mi><mi>a</mi></msub><mo>+</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><msubsup><mi>μ</mi><mi>b</mi><mn>2</mn></msubsup><mo>−</mo><mn>2</mn><mo>⋅</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>μ</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}\sum_{i,j}(a(i,j)^2+\mu_a^2-2 \cdot a(i,j) \cdot \mu_a+b(i,j)^2+\mu_b^2-2 \cdot b(i,j) \cdot \mu_b)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.735217em;vertical-align:-1.413777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">)</mo><mo>−</mo><mn>2</mn><mo stretchy="false">(</mo><msub><mi>μ</mi><mi>a</mi></msub><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>μ</mi><mi>b</mi></msub><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>+</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>a</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>b</mi><mn>2</mn></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}(\sum_{i,j}(a(i,j)^2+b(i,j)^2)-2(\mu_a\sum_{i,j}a(i,j)+\mu_b\sum_{i,j}b(i,j))+\sum_{i,j}
(\mu_a^2+\mu_b^2))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.735217em;vertical-align:-1.413777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.463782em;vertical-align:-1.413777em;"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.463782em;vertical-align:-1.413777em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.463782em;vertical-align:-1.413777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><mi>s</mi><mo>−</mo><mn>2</mn><mo>⋅</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}(fss-2 \cdot \frac{1}{64}(fs1^2+fs2^2)+\frac{1}{64}(fs1^2+fs2^2)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><mi>s</mi><mo>−</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}(fss-\frac{1}{64}(fs1^2+fs2^2))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mn>64</mn><mi>f</mi><mi>s</mi><mi>s</mi><mo>−</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>−</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}\frac{1}{64}(64fss-fs1^2-fs2^2)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0585479999999998em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>a</mi><mi>b</mi></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mi>μ</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mi>μ</mi><mi>b</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{ab}=\frac{1}{63}\sum_{i,j}((a(i,j)-\mu_a)(b(i,j)-\mu_b))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.735217em;vertical-align:-1.413777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msub><mi>μ</mi><mi>b</mi></msub><mo>−</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msub><mi>μ</mi><mi>a</mi></msub><mo>+</mo><msub><mi>μ</mi><mi>a</mi></msub><mo>⋅</mo><msub><mi>μ</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}\sum_{i,j}(a(i,j) \cdot b(i,j)-a(i,j)\mu_b-b(i,j)\mu_a+\mu_a \cdot \mu_b)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.735217em;vertical-align:-1.413777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.63889em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><mn>12</mn><mo>−</mo><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><msub><mi>μ</mi><mi>b</mi></msub><mo>−</mo><mi>f</mi><mi>s</mi><mn>2</mn><mo>⋅</mo><msub><mi>μ</mi><mi>a</mi></msub><mo>+</mo><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><msub><mi>μ</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}(fs12-fs1 \cdot \mu_b-fs2 \cdot \mu_a+fs1 \cdot \mu_b)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><mn>12</mn><mo>−</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>f</mi><mi>s</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}(fs12-\frac{1}{64}fs1 \cdot fs2)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mn>64</mn><mi>f</mi><mi>s</mi><mn>12</mn><mo>−</mo><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>f</mi><mi>s</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">=\frac{1}{63}\frac{1}{64}(64fs12-fs1 \cdot fs2)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∴</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>f</mi><mi>s</mi><mn>2</mn><mo>+</mo><mn>6</mn><msup><mn>4</mn><mn>2</mn></msup><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><mo>⋅</mo><mn>64</mn><mi>f</mi><mi>s</mi><mn>12</mn><mo>−</mo><mn>2</mn><mi>f</mi><mi>s</mi><mn>1</mn><mi>f</mi><mi>s</mi><mn>2</mn><mo>+</mo><mn>63</mn><mo>⋅</mo><mn>64</mn><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>6</mn><msup><mn>4</mn><mn>2</mn></msup><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>64</mn><mi>f</mi><mi>s</mi><mi>s</mi><mo>−</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>−</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>63</mn><mo>⋅</mo><mn>64</mn><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\therefore SSIM(a,b)=\frac{(2fs1 \cdot fs2+64^2C_1)(2 \cdot 64fs12-2fs1fs2+63 \cdot 64C_2)}{(fs1^2+fs2^2+64^2C_1)(64fss-fs1^2-fs2^2+63 \cdot 64C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mrel amsrm">∴</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.427108em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
]]></content>
      <tags>
        <tag>FFMpeg</tag>
        <tag>SSIM</tag>
      </tags>
  </entry>
  <entry>
    <title>FFMpeg如何计算图像的SSIM</title>
    <url>/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/</url>
    <content><![CDATA[<h2 id="ssim基本概念">SSIM基本概念</h2>
<p>关于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的具体解释，此处不再介绍，具体可以参见<a href="https://wangwei1237.gitee.io/digital-video-concept/" target="_blank" rel="noopener">数字视频相关概念</a>中的<a href="https://wangwei1237.gitee.io/digital-video-concept/docs/4_2_2_3_StructuralSimilarityBasedApproaches.html" target="_blank" rel="noopener">SSIM算法</a>一节的介绍。</p>
<p>直接给出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的计算方法：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">SSIM(x,y)=\frac{(2\mu_x\mu_y+C_1)(2\sigma_{xy}+C_2)}{(\mu_x^2+\mu_y^2+C_1)(\sigma_x^2+\sigma_y^2+C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.496108em;vertical-align:-1.069108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.069108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub><mo>=</mo><mo stretchy="false">(</mo><msub><mi>K</mi><mn>1</mn></msub><mi>L</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo separator="true">,</mo><msub><mi>C</mi><mn>2</mn></msub><mo>=</mo><mo stretchy="false">(</mo><msub><mi>K</mi><mn>2</mn></msub><mi>L</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">C_1=(K_1L)^2, C_2=(K_2L)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">L</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">L</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mn>1</mn></msub><mo>≪</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K_1\ll1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mn>2</mn></msub><mo>≪</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K_2\ll1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>均为常数，计算时，一般<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mn>1</mn></msub><mo>=</mo><mn>0.01</mn></mrow><annotation encoding="application/x-tex">K_1=0.01</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mn>2</mn></msub><mo>=</mo><mn>0.03</mn></mrow><annotation encoding="application/x-tex">K_2=0.03</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">3</span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">L</span></span></span></span>是灰度的动态范围，由图像的数据类型决定，如果数据为<em>uint8</em>，则<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>255</mn></mrow><annotation encoding="application/x-tex">L=255</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span></span></span></span>。</p>
<a id="more"></a>
<h2 id="ssim计算中的图像分割">SSIM计算中的图像分割</h2>
<p>在整幅图片的跨度上，图像亮度的均值和方差变化较为剧烈；并且图像上不同区块的失真程度也有可能不同；再者人眼睛每次只能聚焦于一处，更关注局部数据而非全局数据。因此如上的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法不能直接作用于一整副图像。</p>
<p>在论文<strong>Image quality assessment: From error visibility to structural similarity</strong>中，作者采用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>11</mn><mo>×</mo><mn>11</mn></mrow><annotation encoding="application/x-tex">11 \times 11</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">1</span></span></span></span>的滑动窗口将整副图像分割为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span>个patch，然后计算每一个patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>，最后计算所有patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>值的平均数（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>e</mi><mi>a</mi><mi>n</mi><mtext>  </mtext><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo>:</mo><mi>M</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">Mean \ \ SSIM:MSSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mspace"> </span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>）作为整副图像的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。为了避免滑动窗口带来的块效应，在计算每个patch的均值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">μ</span></span></span></span>和方差<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>时，作者采用了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>=</mo><mn>1.5</mn></mrow><annotation encoding="application/x-tex">\sigma=1.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span></span></span></span>的高斯卷积核作加权平均。</p>
<p>如果整副图像有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span>个patch，则<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MSSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的计算方式为：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">MSSIM(X,Y) = \frac{1}{N}\sum_{i=1}^{N}{SSIM(x_i, y_i)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.106005em;vertical-align:-1.277669em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SSIM(x_i, y_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>为第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>个patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<h2 id="ffmpeg中计算ssim的算法">FFMpeg中计算SSIM的算法</h2>
<p>在FFMpeg中，也提供了计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的实现：<a href="https://github.com/FFmpeg/FFmpeg/blob/master/tests/tiny_ssim.c" target="_blank" rel="noopener">tiny_ssim</a>。从代码的注释中可以看到：为了提升算法的性能，没有采用论文中的高斯加权方式计算每个patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>，而是采用了一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8 \times 8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>的块来计算每个patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * tiny_ssim.c</span><br><span class="line"> * Computes the Structural Similarity Metric between two rawYV12 video files.</span><br><span class="line"> * original algorithm:</span><br><span class="line"> * Z. Wang, A. C. Bovik, H. R. Sheikh and E. P. Simoncelli,</span><br><span class="line"> *   &quot;Image quality assessment: From error visibility to structural similarity,&quot;</span><br><span class="line"> *   IEEE Transactions on Image Processing, vol. 13, no. 4, pp. 600-612, Apr. 2004.</span><br><span class="line"> *</span><br><span class="line"> * To improve speed, this implementation uses the standard approximation of</span><br><span class="line"> * overlapped 8x8 block sums, rather than the original gaussian weights.</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="standard-approximation-of-overlapped-8x8-block-sums">standard approximation of overlapped 8x8 block sums</h3>
<p>接下来就解释一下注释中的<em>standard approximation of overlapped 8x8 block sums</em>究竟是什么含义。在解释的过程中会分解成两个部分来解释：<em>overlapped 8x8 block</em>和<em>sums</em>。</p>
<h3 id="overlapped-8x8-block的含义">overlapped 8x8 block的含义</h3>
<p>FFMpeg在计算图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>时，首先以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">4 \times 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span>的块大小把<strong>图1</strong>所示的分辨率为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>×</mo><mi>H</mi></mrow><annotation encoding="application/x-tex">W \times H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span>的图像：<br>
<img src="/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/1.jpg" alt="图1"><br>
图1：原始图像</p>
<p>分割为<strong>图2</strong>的样式。<br>
<img src="/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/2.jpg" alt="图2"></p>
<p>图2：分割后的图像</p>
<p>对于<strong>图2</strong>中的每一块用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>来表示（<em>图2中的红色块</em>），FFMpeg使用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>及其<strong>上、右、右上块</strong>（<em>图2中的绿色块</em>）来计算其<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo>:</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SSIM:SSIM(x_{ij},y_{ij})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>及其<strong>上、右、右上块</strong>构成一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>的像素块，并且该<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>的块和计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>用到的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>的块存在重合像素，这就是注释中的<strong>overlapped 8x8 block</strong>的真正含义。</p>
<p>因此，根据如上规则：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mfrac><mi>H</mi><mn>4</mn></mfrac><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>j</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">i \in [1,\frac{H}{4}],j \in [0,\frac{W}{4}-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69862em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.217331em;vertical-align:-0.345em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.217331em;vertical-align:-0.345em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>。也就是说：第0行和最后一列的块不会计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<p>最后得到FFMpeg中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>计算方式为：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo>=</mo><mi>M</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mfrac><mi>H</mi><mn>4</mn></mfrac></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mrow><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn></mrow></munderover><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">SSIM = MSSIM(X,Y) = \frac{1}{N}\sum_{i=1}^{\frac{H}{4}}\sum_{j=0}^{\frac{W}{4}-1}{SSIM(x_{ij}, y_{ij})}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.526047em;vertical-align:-1.4137769999999998em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.11227em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.451805em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1122700000000005em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.451805em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mo stretchy="false">(</mo><mfrac><mi>H</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N=(\frac{H}{4}-1)(\frac{W}{4}-1)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="sums的含义">sums的含义</h3>
<p>如前所述，我们分析了FFMpeg计算图像的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的整体思路，接下来我们继续分析FFMpeg是如何计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SSIM(x_{ij},y_{ij})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>的。</p>
<p>首先利用函数<code>ssim_4x4x2_core()</code>来计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的结构相似性指标，主要是如下的4个指标：</p>
<ul>
<li><em>s1</em>：参考图像在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的像素之和</li>
<li><em>s2</em>：受损图像在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的像素之和</li>
<li><em>ss</em>：参考图像和受损图像在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的像素平方之和</li>
<li><em>s12</em>：参考图像和受损图像在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的对应像素乘积之和</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>1</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><mrow><mi>x</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">s1=\sum_{i=0}^{3}\sum_{j=0}^{3}{x(i,j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.389826em;vertical-align:-0.43581800000000004em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>2</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><mrow><mi>y</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">s2=\sum_{i=0}^{3}\sum_{j=0}^{3}{y(i,j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.389826em;vertical-align:-0.43581800000000004em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><mrow><mo fence="false">(</mo><mo fence="false">(</mo><mi>x</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msup><mo fence="false">)</mo><mn>2</mn></msup><mo>+</mo><mo fence="false">(</mo><mi>y</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msup><mo fence="false">)</mo><mn>2</mn></msup><mo fence="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">ss=\sum_{i=0}^{3}\sum_{j=0}^{3}{\Big(\big(x(i,j)\big)^2+\big(y(i,j)\big)^2\Big)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.80002em;vertical-align:-0.65002em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="delimsizing size2">(</span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">x</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054008em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054008em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size2">)</span></span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>12</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><mrow><mo fence="false">(</mo><mi>x</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>y</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo fence="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">s12=\sum_{i=0}^{3}\sum_{j=0}^{3}{\big(x(i,j) \cdot y(i,j)\big)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.389826em;vertical-align:-0.43581800000000004em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">x</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></span></p>
<p>如上的4个指标就是我们后续会用到的sums，该sums也就是<em>overlapped 8x8 block sums</em>中的<em>sums</em>的概念。</p>
<h3 id="利用sums计算各块的ssim">利用sums计算各块的SSIM</h3>
<p>接下来利用该sums值计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<p>为了提升效率，FFMpeg会按照行来计算每一行的各个块的sums数据，并将每个行块的sums数据存储在长度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>W</mi><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{W}{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.217331em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>的数组指针sum（<code>(int(*)[4])</code>）中。</p>
<p>其中sum指针有两种：</p>
<ul>
<li>sum0：存储当前行的各块的sums结果</li>
<li>sum1：存储当前行的上一行的sums结果</li>
</ul>
<p>先计算第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>行块和第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>行块的sums结果，并分别存入<code>sum1</code>和<code>sum0</code>中。然后遍历第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>行块的每一个块，并利用<code>sum1</code>和<code>sum0</code>中计算的结果来计算每一块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<p>函数<code>ssim_end4()</code>展示了如何利用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i-1,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i-1,j+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>的sums信息来计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SSIM(x_{ij},y_{ij})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>：</p>
<ul>
<li>先对4个块的sums结果进行加和处理，得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>块的sums结果</li>
<li>然后利用该<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>块的sums来计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span></li>
</ul>
<p>函数<code>ssim_end1()</code>就展示了如何利用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>块的sums信息来计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。具体的计算方法如下。</p>
<p>将红色区块<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的图像放大一点，如图3所示。我们接下来计算其<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。<br>
<img src="/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/3.jpg" alt="图3"><br>
图3：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的示意图</p>
<p>在计算时，首先将4个区块的sums值求和，得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>区块的sums值，分别为：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>1</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>63</mn></msubsup><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s1=\sum_{i=0}^{63}{x_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>2</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>63</mn></msubsup><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s2=\sum_{i=0}^{63}{y_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>63</mn></msubsup><mrow><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>i</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>y</mi><mi>i</mi><mn>2</mn></msubsup><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">ss=\sum_{i=0}^{63}{(x_i^2+y_i^2)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>12</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>63</mn></msubsup><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">s12=\sum_{i=0}^{63}{(x_i \cdot y_i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></li>
</ul>
<p>根据如上的计算，可以得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">\mu_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">\mu_y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">\mu_x\mu_y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\mu_x^2+\mu_y^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma_x^2+\sigma_y^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\sigma_{xy}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>x</mi></msub><mo>=</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo>⋅</mo><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">\mu_x=\frac{1}{64} \cdot s1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>y</mi></msub><mo>=</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo>⋅</mo><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\mu_y=\frac{1}{64} \cdot s2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub><mo>=</mo><mfrac><mn>1</mn><mrow><mn>64</mn><mo>⋅</mo><mn>64</mn></mrow></mfrac><mo stretchy="false">(</mo><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>s</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mu_x\mu_y=\frac{1}{64 \cdot 64}(s1 \cdot s2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span><span class="mbin mtight">⋅</span><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><mn>64</mn><mo>⋅</mo><mn>64</mn></mrow></mfrac><mo fence="false">(</mo><mo stretchy="false">(</mo><mi>s</mi><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>s</mi><mn>2</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo fence="false">)</mo></mrow><annotation encoding="application/x-tex">\mu_x^2+\mu_y^2=\frac{1}{64 \cdot 64}\big((s1)^2+(s2)^2\big)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span><span class="mbin mtight">⋅</span><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><mn>64</mn><mo>⋅</mo><mn>63</mn></mrow></mfrac><mo fence="false">(</mo><mn>64</mn><mo>⋅</mo><mi>s</mi><mi>s</mi><mo>−</mo><mo stretchy="false">(</mo><mi>s</mi><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mo stretchy="false">(</mo><mi>s</mi><mn>2</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo fence="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_x^2+\sigma_y^2=\frac{1}{64 \cdot 63}\big(64 \cdot ss-(s1)^2- (s2)^2\big)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span><span class="mbin mtight">⋅</span><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mrow><mn>64</mn><mo>⋅</mo><mn>63</mn></mrow></mfrac><mo stretchy="false">(</mo><mn>64</mn><mo>⋅</mo><mi>s</mi><mn>12</mn><mo>−</mo><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>s</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{xy}=\frac{1}{64 \cdot 63}(64 \cdot s12 - s1 \cdot s2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span><span class="mbin mtight">⋅</span><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></li>
</ul>
<p>利用如上的公式（具体推导可以参考<a href="/2020/02/18/the-proof-of-the-SSIM-in-FFMpeg/">ssim_end1()的推导</a>）对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的公式进行计算可以得到：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">SSIM(x,y)=\frac{(2\mu_x\mu_y+C_1)(2\sigma_{xy}+C_2)}{(\mu_x^2+\mu_y^2+C_1)(\sigma_x^2+\sigma_y^2+C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.496108em;vertical-align:-1.069108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.069108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>s</mi><mn>1</mn><mi>s</mi><mn>2</mn><mo>+</mo><mn>6</mn><msup><mn>4</mn><mn>2</mn></msup><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><mo>⋅</mo><mn>64</mn><mi>s</mi><mn>12</mn><mo>−</mo><mn>2</mn><mi>s</mi><mn>1</mn><mi>s</mi><mn>2</mn><mo>+</mo><mn>64</mn><mo>⋅</mo><mn>63</mn><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>6</mn><msup><mn>4</mn><mn>2</mn></msup><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>64</mn><mi>s</mi><mi>s</mi><mo>−</mo><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>−</mo><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>64</mn><mo>⋅</mo><mn>63</mn><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">=\frac{(2s1s2+64^2C_1)(2\cdot64s12-2s1s2+64\cdot63C_2)}{(s1^2+s2^2+64^2C_1)(64ss-s1^2-s2^2+64\cdot63C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.427108em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">3</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">3</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>FFMpeg中，对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的定义中的因子<strong>64</strong>或<strong>63</strong>也是根据上面的公式，但是从公式看，<a href="https://trac.ffmpeg.org/ticket/8529" target="_blank" rel="noopener"><strong>FFMpeg对<code>ssim_c1</code>的计算少乘了64</strong></a>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssim_c1 &#x3D; 0.01 * 0.01 * 255 * 255 * 64 + 0.5</span><br><span class="line">ssim_c2 &#x3D; 0.03 * 0.03 * 255 * 255 * 64 * 63 + 0.5</span><br></pre></td></tr></table></figure>
<p>当然，为了简化处理，FFMpeg还做了如下的定义：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vars  &#x3D; ss  * 64 - s1 * s1 - s2 * s2;</span><br><span class="line">covar &#x3D; s12 * 64 - s1 * s2;</span><br></pre></td></tr></table></figure>
<p>因此，最终在FFMpeg中，计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的公式为：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>s</mi><mn>1</mn><mi>s</mi><mn>2</mn><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><mi>c</mi><mi>o</mi><mi>v</mi><mi>a</mi><mi>r</mi><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">SSIM(x,y)=\frac{(2s1s2+ssimC_1)(2covar+ssimC_2)}{(s1^2+s2^2+ssimC_1)(vars + ssimC_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>如上的公式就是函数<code>ssim_end1()</code>中最终的计算方式。</p>
<h3 id="利用各块的ssim计算图像的ssim">利用各块的SSIM计算图像的SSIM</h3>
<p>计算完所有块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>之后，就可以计算所有块的平均<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>并作为该图像的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mfrac><mi>H</mi><mn>4</mn></mfrac></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mrow><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn></mrow></munderover><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">SSIM(X,Y)= \frac{1}{N}\sum_{i=1}^{\frac{H}{4}}\sum_{j=0}^{\frac{W}{4}-1}{SSIM(x_{ij}, y_{ij})}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.526047em;vertical-align:-1.4137769999999998em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.11227em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.451805em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1122700000000005em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.451805em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mo stretchy="false">(</mo><mfrac><mi>H</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N=(\frac{H}{4}-1)(\frac{W}{4}-1)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="编码过程中的技巧">编码过程中的技巧</h3>
<p>在FFMpeg计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的算法实现中，为了提升效率和抽象代码逻辑，也利用了很多的编程技巧，例如：</p>
<ul>
<li>计算YUV各分量图像宽度时用<code>w &gt;&gt; !!i</code></li>
<li>为了避免对第0行的特殊处理，采用两层循环来处理</li>
<li>计算每一行的各块的sums信息时，为了降低循环次数，每次循环计算2个块的sums结果，<code>ssim_4x4x2_core</code>的函数名可能就是这么来的。</li>
<li>计算每一行的各块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>时，为了降低循环次数，每次循环计算4个块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>，<code>ssim_end4</code>的函数名可能就是这么来的。</li>
</ul>
<h2 id="感谢">感谢</h2>
<p>分析过程离不开和贤杰(github: <a href="https://github.com/bodhisatan" target="_blank" rel="noopener">@bodhisatan</a>)的不断讨论和交流，感谢@贤杰在繁忙的工作之余抽出时间来一起分析FFMpeg中SSIM算法的实现原理。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFMpeg</tag>
        <tag>SSIM</tag>
      </tags>
  </entry>
  <entry>
    <title>解决hexo-asset-image的图片地址错误问题</title>
    <url>/2020/02/05/handle-the-bug-of-hexo-asset-image-plugin/</url>
    <content><![CDATA[<p>由于<code>hexo-asset-image</code>插件存在bug，会导致博文中引用图片时无法生成正确的链接地址，进而导致图片无法访问的现象。<br>
具体解决方案为将文件<code>node_modules/hexo-asset-image/index.js</code>替换为如下的内容：</p>
<a id="more"></a>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http://stackoverflow.com/questions/14480345/how-to-get-the-nth-occurrence-in-a-string</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPosition</span>(<span class="params">str, m, i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.split(m, i).join(m).length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> version = <span class="built_in">String</span>(hexo.version).split(<span class="string">'.'</span>);</span><br><span class="line">hexo.extend.filter.register(<span class="string">'after_post_render'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> config = hexo.config;</span><br><span class="line">  <span class="keyword">if</span>(config.post_asset_folder)&#123;</span><br><span class="line">    	<span class="keyword">var</span> link = data.permalink;</span><br><span class="line">	<span class="keyword">if</span>(version.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">Number</span>(version[<span class="number">0</span>]) == <span class="number">3</span>)</span><br><span class="line">	   <span class="keyword">var</span> beginPos = getPosition(link, <span class="string">'/'</span>, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	   <span class="keyword">var</span> beginPos = getPosition(link, <span class="string">'/'</span>, <span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// In hexo 3.1.1, the permalink of "about" page is like ".../about/index.html".</span></span><br><span class="line">	<span class="keyword">var</span> endPos = link.lastIndexOf(<span class="string">'/'</span>) + <span class="number">1</span>;</span><br><span class="line">    link = link.substring(beginPos, endPos);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> toprocess = [<span class="string">'excerpt'</span>, <span class="string">'more'</span>, <span class="string">'content'</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; toprocess.length; i++)&#123;</span><br><span class="line">      <span class="keyword">var</span> key = toprocess[i];</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">var</span> $ = cheerio.load(data[key], &#123;</span><br><span class="line">        ignoreWhitespace: <span class="literal">false</span>,</span><br><span class="line">        xmlMode: <span class="literal">false</span>,</span><br><span class="line">        lowerCaseTags: <span class="literal">false</span>,</span><br><span class="line">        decodeEntities: <span class="literal">false</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      $(<span class="string">'img'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ($(<span class="keyword">this</span>).attr(<span class="string">'src'</span>))&#123;</span><br><span class="line">			<span class="comment">// For windows style path, we replace '\' to '/'.</span></span><br><span class="line">			<span class="keyword">var</span> src = $(<span class="keyword">this</span>).attr(<span class="string">'src'</span>).replace(<span class="string">'\\'</span>, <span class="string">'/'</span>);</span><br><span class="line">			<span class="keyword">if</span>(!<span class="regexp">/http[s]*.*|\/\/.*/</span>.test(src) &amp;&amp;</span><br><span class="line">			   !<span class="regexp">/^\s*\//</span>.test(src)) &#123;</span><br><span class="line">			  <span class="comment">// For "about" page, the first part of "src" can't be removed.</span></span><br><span class="line">			  <span class="comment">// In addition, to support multi-level local directory.</span></span><br><span class="line">			  <span class="keyword">var</span> linkArray = link.split(<span class="string">'/'</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">elem</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> elem != <span class="string">''</span>;</span><br><span class="line">			  &#125;);</span><br><span class="line">			  <span class="keyword">var</span> srcArray = src.split(<span class="string">'/'</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">elem</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> elem != <span class="string">''</span> &amp;&amp; elem != <span class="string">'.'</span>;</span><br><span class="line">			  &#125;);</span><br><span class="line">			  <span class="keyword">if</span>(srcArray.length &gt; <span class="number">1</span>)</span><br><span class="line">				srcArray.shift();</span><br><span class="line">			  src = srcArray.join(<span class="string">'/'</span>);</span><br><span class="line">			  $(<span class="keyword">this</span>).attr(<span class="string">'src'</span>, config.root + link + src);</span><br><span class="line">			  <span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">"update link as:--&gt;"</span>+config.root + link + src);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">"no src attr, skipped..."</span>);</span><br><span class="line">			<span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info($(<span class="keyword">this</span>));</span><br><span class="line">		&#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      data[key] = $.html();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>使用hexo和github搭建个人博客</title>
    <url>/2020/02/05/use-hexo-and-github-for-blog/</url>
    <content><![CDATA[<h2 id="创建github仓库">创建github仓库</h2>
<p>首先打开<a href="https://github.com/" target="_blank" rel="noopener">github</a>，点击<code>New repository</code>，创建一个新仓库用于存储博客的所有内容。</p>
<p>仓库名必须为：<code>账户名.github.io</code>，并且需要勾选<strong>Initialize this repository with a README</strong>。</p>
<p>在建好的仓库右侧有个<strong>settings</strong>按钮，点击<strong>settings</strong>，向下滑动到<strong>GitHub Pages</strong>，会发现有个网址，github会把该仓库中的项目部署到该网址下，该网址也是博客的默认地址。当然也可以购买域名，将其换成喜欢的地址。</p>
<a id="more"></a>
<p><img src="/2020/02/05/use-hexo-and-github-for-blog/1.jpg" alt></p>
<p><img src="/2020/02/05/use-hexo-and-github-for-blog/2.jpg" alt></p>
<h2 id="准备node-js环境">准备node.js环境</h2>
<p>由于hexo是基于<a href="https://nodejs.org/en/" target="_blank" rel="noopener">node.js</a>开发的，因此在安装hexo之前，需要先安装node.js并配置响应的node.js环境。具体如下所示：</p>
<p><img src="/2020/02/05/use-hexo-and-github-for-blog/3.jpg" alt></p>
<h2 id="准备hexo环境">准备hexo环境</h2>
<p>根据<a href="https://hexo.io/" target="_blank" rel="noopener">hexo官网</a>的提示，安装hexo。具体如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-cli -g</span><br><span class="line">$ hexo init blog</span><br><span class="line">$ cd blog</span><br><span class="line">$ npm install</span><br><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>此时hexo会在4000端口启动一个webserver，用浏览器访问<code>localhost:4000</code>则会看到初始化之后默认的站点。</p>
<h2 id="安装hexo插件">安装hexo插件</h2>
<h3 id="hexo-generator-category">hexo-generator-category</h3>
<p>该插件用于自动生成category，具体安装方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-generator-category --save</span><br><span class="line">$ hexo new page categories</span><br></pre></td></tr></table></figure>
<p>然后修改<code>source/categories/index.md</code>的内容为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2020-02-05 11:53:35</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">layout: &quot;categories&quot;</span><br><span class="line">comments: false</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<h3 id="hexo-generator-tag">hexo-generator-tag</h3>
<p>该插件用于自动生成tags，具体安装方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-generator-tag --save</span><br><span class="line">$ hexo new page tags</span><br></pre></td></tr></table></figure>
<p>然后修改<code>source/tags/index.md</code>的内容为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2020-02-05 11:53:58</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">layout: &quot;tags&quot;</span><br><span class="line">comments: false</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<h3 id="hexo-asset-image">hexo-asset-image</h3>
<p>该插件主要用于解决在文章中引用图片的场景，具体安装方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-asset-image --save</span><br></pre></td></tr></table></figure>
<p>安装该插件后，利用<code>hexo new post 'test'</code>生成新文章内容时，会在<code>source/_posts</code>目录下同时生成<code>test.md</code>和<code>test目录</code>，<code>test.md</code>中需要的图片可以存储在<code>test目录</code>下。在文档中，采用如下的方式来引用图片：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">![图片的描述信息](1.jpg)</span><br></pre></td></tr></table></figure>
<p>关于hexo-asset-image生成图片的bug，可以参考文章：<a href="/2020/02/05/handle-the-bug-of-hexo-asset-image-plugin/">解决hexo-asset-image的图片地址错误问题</a></p>
<h3 id="hexo-deployer-git">hexo-deployer-git</h3>
<p>该插件用于将编译后生成的站点内容发布到第一步创建的github仓库中，从而实现内容更新。具体安装方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm add hexo-deployer-git</span><br></pre></td></tr></table></figure>
<p>然后配置_config.yml中的<code>url</code>和<code>deploy</code>配置，以便可以通过该插件自动部署项目。具体配置如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">url:</span> <span class="string">https://wangwei1237.github.io/</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/wangwei1237/wangwei1237.github.io</span></span><br></pre></td></tr></table></figure>
<p>配置完毕之后，如果项目内容发生修改，则利用如下的命令就可以完成自动发布：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">$ hexo generate</span><br><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>github</tag>
        <tag>建站</tag>
      </tags>
  </entry>
  <entry>
    <title>凡所过往，皆是序章</title>
    <url>/2020/02/05/where-of-what-is-past-is-prologue/</url>
    <content><![CDATA[<p>凡所过往，皆是序章，新的一年，用4个关键词来讲一讲2019年自己心中的过往和序章。</p>
<p><img src="/2020/02/05/where-of-what-is-past-is-prologue/1.jpg" alt></p>
<a id="more"></a>
<h2 id="变化">变化</h2>
<p>如果要用1个词来形容2019年的话，我觉得就是 变化了。无论内部，还是外部，都在发生着翻天覆地的变化。变化这种滋味起初很痛苦，但是却蕴含着无限的机会。</p>
<p>未来，变化会是常态。工作方式要变，工具平台要变，开发语言要变……所有的事情都在向着好的方向变化、发展。</p>
<p>在这个变化的过程中，不能随波逐流，也不能固守己见。需要顺应变化，找到其中的机会，顺势而为，乘风而起。</p>
<h2 id="学习">学习</h2>
<p>在快速的变化中，怎么才能乘风而起？秘诀也就是 学习了。</p>
<p>2019年，我学习了opengl，kotlin；</p>
<p>2019年，学习了数字视频，ffmpeg，opencv；</p>
<p>2019年，学习了Android的相机系统，学习了逆向破解；</p>
<p>2019年，学习了如何写作，学习了如何演讲，学习了如何系统化思考……</p>
<p>在学校的时候，为了工作而学习。现在或者未来，要为了学习而工作，不断学习新的技能。</p>
<p>学习是应对各种变化的不二法门。学习，在路上……</p>
<h2 id="创新">创新</h2>
<p>创新这个词呢，总会和 造轮子这个词关联起来。</p>
<p>2019年， 造轮子这个词很频繁，频繁的有点令我不知所措。实际上，我个人不反对造轮子，但是反对 为了造轮子而造轮子。每种技术都有他的能力边界，在 造轮子的时候，要首先识别到能力的边界，然后找到一种快速有效的方式来解决我们的问题，这才是创新。</p>
<p>技术的进步就是一个造轮子的过程。为什么有了c++还会有java，有了java还会有kotlin？为什么有了苹果还会有安卓？为什么有了快手还会有抖音？……</p>
<p>未来，在创新的路上，需要更多的践行work smarter not work harder。</p>
<p><img src="/2020/02/05/where-of-what-is-past-is-prologue/2.jpg" alt></p>
<h2 id="突破">突破</h2>
<p>毫无疑问，未来肯定是新人的天下。</p>
<p>未来需要更多的想，怎么能够让新人可以站在巨人的肩膀上成长；也要更多的想，怎们样才能够让自己成为人老心不老的老新人。</p>
<p>工作中，更无须给自己设限，这个我可能不行呢，那个我可能也搞不定呀，这个我没接触过呀，那个我没学过呀。怕什么呢，不试试怎们知道不行，不搞一搞怎么知道搞不定，没接触过就接触嘛，没学过就学起来嘛，没有什么大不了的。</p>
<p>工程师不就是要逢山开路遇水搭桥吗？要坚信，在我们可以想象的范围内，没有技术解决不了的问题。</p>
<p>冲破牢笼，方得始终。</p>
<p>加勒比海盗中有个桥段：</p>
<blockquote>
<p>船长：扬帆！起航！<br>
水手：什么方向？<br>
船长：海盗需要什么方向？起航！</p>
</blockquote>
<p>2020，扬帆，起航！乘着梦想之风，向着星光的方向，找到最好的自己。</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>测试工作</tag>
      </tags>
  </entry>
  <entry>
    <title>对QA的思考——我的这些年</title>
    <url>/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/</url>
    <content><![CDATA[<p>2012年毕业后怀着一颗忐忑的心开始了测试工作的职业生涯，到现在也有7年啦。经历过奋斗和激情，也经历过徘徊和迷茫，勤恳却不庸碌。虽然对测试也有担忧，但是对这个行业始终保持着一种激情。</p>
<p>接下来结合自己的工作谈一下对测试的一些思考，也回顾下自己过去的测试工作中遵循的一些工作原则。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/1.jpg" alt></p>
<a id="more"></a>
<h2 id="原则1：正确的认识自己">原则1：正确的认识自己</h2>
<p>好多人，自视甚高，傲视一切。但是，实际上，牛人很多。我们能做成一件事情，能力是一个方面，但能力绝对不是全部因素。没有上级的支持，没有同事的协作和配合，没有公司提供的资源，我们是什么事情也做不成的。不能因为自己的工作时间长，对业务了解的深，就对别人横加指责，也不能因为自己职称高就给别人以压力。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/2.png" alt></p>
<h2 id="原则2：先成就别人-再成就自己">原则2：先成就别人，再成就自己</h2>
<p>我们经常问QA的价值是什么？</p>
<p>实际上有些东西是很难讲清楚的。好多QA为了证明自己的技术能力、技术价值，做了很多看似高超，但是实际上对业务快速迭代并没有用的事情。</p>
<p>我总觉得，自己的价值不是由自己体现的，而是由别人来体现的。只有先成就别人，才能最终成就自己。这就是我工作以来一直遵循的一个工作原则。不争，不抢，认真做事，认真帮别人做事，认真的帮业务做事情，帮助RD分析线上问题，解决BUG。到了后来，也颇有点：桃李不言，下自成蹊的味道。</p>
<p>好多人也会说，在这个时代，酒香也怕巷子深。如果不主动宣传自己的价值，宣传自己的影响力，别人是不会知道的。但是，实际上，影响力和价值是由别人来评估的，历史交由后人评就是这个道理。并且，影响力是处于某个圈层的，并通过圈层而扩散。我们首先在团队的圈层内做到影响力，才有可能通过圈层的扩散而扩散自己的价值。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/3.jpg" alt></p>
<h2 id="原则3：方便别人-方便自己">原则3：方便别人，方便自己</h2>
<p>做测试的同学，每天会写很多测试case，每天也会发很多测试报告，但是如果打开这些邮件，经常发现这些case很难让人理解，这些测试报告虽然篇幅很大，但是如果要从中找到接下来RD要做什么，还是要花费一点时间的。</p>
<p>在测试工作过程中，无论是测试报告，还是风险通报，首先要了解到这些内容的接收者到底是谁，然后需要思考，要以什么样的描述和组织才能方便对方快速了解到内容的含义，也就是要做到：到什么山头，唱什么歌。</p>
<p>我刚入职的时候，因为之前没有做过测试，也不知道测试报告要以什么样的格式来发，所以很害怕发测试报告。虽然学习了其他前辈的测试报告和前辈们的测试报告范式，但是总感觉还是害怕。因为，从RD的角度来看，阅读那些测试报告的成本还是很大的。</p>
<p>然后，我站在RD的角度上想，怎么组织测试报告，才能让RD一眼就知道自己接下来要做什么呢？然后我重新组织了之前测测试报告，在报告的最开始用1句话概括项目的测试结论：该项目测试是否通过，原因是什么？具体的BUG量是多少？然后接下来是详细的测试清单，清单中明确表明每一个case的测试点，前置，预期结果，实际测试结果，是否通过等信息。对于测试通过的case，用绿色来标注；对于测试失败的case，用红色标注；对于有疑问的case，比如建议等，用黄色标注。RD收到测试报告之后，先看结论，然后看非绿色的测试case修复BUG。</p>
<h2 id="原则4：消除门槛-而不是提升门槛">原则4：消除门槛，而不是提升门槛</h2>
<p>大禹治水之所以成功，最重要的思想就是：改“堵”为“疏”。</p>
<p>但是真正的测试过程中，经常会发现如下的现象：领导质疑QA的测试时间太长，QA质疑RD的提测质量太差，然后QA增加了准入打回的流程，对于RD提测的、没有通过准入的项目不予测试。</p>
<p>实际上，这种现象就是QA在项目的测试环节设置了一个门槛，而如果这种门槛设置的越来越多，那么对于业务而言也会发生“洪涝灾害”。单从测试团队的角度看，确实增加这个门槛，测试效率提升了，测试时间降低了，但是如果从整个业务的迭代来看，效率并没有提升。</p>
<p>我们提了门槛，发了准入case，增加了流程，这一点也不能说不好。但是我们有没有想过：这些准入case别人看的懂吗？我们怎么设计case能够使得RD自测的时候更加方便呢？即便看懂了，我们怎么保证RD确实执行了呢？我们怎么保证增加的这个流程每次都贯彻落实了呢？</p>
<p>QA不应该是一个门槛设置者，而应该是一种有效的武器。不能用看似合理的各种标准和要求卡住事情，而应该成为帮助团队解决问题的秘密武器。</p>
<p>QA不能只报问题，只说现象，只说RD不靠谱，上线不检查。QA需要思考：</p>
<ul>
<li>我们能为快速迭代做些什么？</li>
<li>我们能做些什么可以帮助RD快速发现自己的代码问题？</li>
<li>我们能做什么可以帮助RD快速发现上线过程异常了？</li>
</ul>
<h2 id="原则5：不断学习-不做伪学习者">原则5：不断学习，不做伪学习者</h2>
<p>现在，技术更新换代的频率很快，所以一定要不断的学习，持续的学习。还记得刚入职的时候，那时候就会c/c++，java。现在看看自己的github和内网的提交记录，发现语言层面基本上涵盖了：c/c++，java，php，python，go，javascript，shell，object-c，swift，lua。项目类型覆盖了服务端，策略端，iOS，Android，自动化等不同的方向。从原来只会用IIS的小白，到今天了解Apache，Lighttpd，Nginx等各种web服务器。从原来的服务端，到慢慢了解前端，了解策略端，了解客户端。</p>
<p>参加过好多会，和好多人沟通过，大家都希望组织提供学习的机会，提供分享的机会，希望组织能提供自己技术成长的机会。但是，实际上，成长是自己的事，学习是个人的事，为什么要求组织给提供这些机会呢？我组织过很长时间的分享，我也最反对组织大规模的技术学习和分享，因为让太多的伪学习者进入之后，效果并不理想。相反，规模较小的沙龙和讨论对个人的技术成长效果更为明显。伪学习者只是想学习而已，只是想让组织提供学习机会而已，仅此而已。</p>
<p>学习是自己的事情，白天求生存，晚上求发展。凌晨2点的时候，也曾在灯下啃过Nginx的源码，分析一个个的线上问题，没有这些个凌晨2点就不会有《Nginx沉思录》，《Nginx洗冤录》等一系列的总结。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/4.jpg" alt></p>
<h2 id="原则6：做积极的抱怨者-不做消极的抱怨者">原则6：做积极的抱怨者，不做消极的抱怨者</h2>
<p>没有“抱怨”就不会有技术的进步，但是反过来说没有“抱怨”就不会存在那么多的失败，一无是处，庸庸碌碌。关键是要看待我们对待“抱怨”的态度。当“抱怨”还仅仅是停留在嘴上，停留在思想上，被“抱怨”所控制时，基本上也就离碌碌无为不远了。当我们开始和“抱怨”对抗时，利用一切技术手段和努力消灭“抱怨”时，技术就开始进步了。所以，我一般不反对抱怨，并一直鼓励大家抱怨，但是接下来我会仔细分析抱怨的原因是什么？技术上需要什么探索才能消灭这些抱怨？</p>
<p>每一个“抱怨”都是一次机会，都是一个机遇，都是一次成长。逢山开路，遇水搭桥，勇往直前。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/5.jpg" alt></p>
<h2 id="原则7：正确认识qa和rd的异同">原则7：正确认识QA和RD的异同</h2>
<p>天分日夜黑白，季节有春夏秋冬，虽然全栈模式有他的优点，但是四季也有四季的美。文能提笔安天下，武能上马定乾坤。关键是，我们需要对QA和RD有正确的认识。</p>
<p>我们不能按照一个原则来评定事情。比如：老驴拉磨，始终走不出那个圈圈。和日行千里的良马相比，当然老驴要羞愧了。但是如果换个角度，拉磨一天，产面千斤。良马再能跑，也跑不出千斤面。</p>
<p>QA和RD虽然都是研发岗，都是技术体系，那他们的差异在哪呢？</p>
<p>我觉得有以下几点吧：</p>
<ul>
<li>从工作关系上讲，QA是RD的下游，RD是QA的客户。</li>
<li>从工作重点上讲，QA注重分析，而RD注重实践。RD要做的是解决问题，采用任何可能的方法，快速实现需求，快速上线。而QA没有太大的业务压力，可以有更多的时间来思考每一种技术的优势和劣势，有更多的时间来仔细分析和追查每一个bug的深层原因，帮助RD在快速解决问题后可以彻底解决问题，锦上添花。</li>
<li>从涵盖业务上讲，QA关注的业务广度较高，而RD关注业务的深度更高。</li>
</ul>
<p>实际上，技术是一个很广泛的概念，不能认为只有写代码，设计架构才是技术，我们的思维本身就是一种技术。关键是，我们的技术要为业务的发展而存在，而不是孤立的存在。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/6.jpg" alt></p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>测试工作</tag>
      </tags>
  </entry>
</search>
