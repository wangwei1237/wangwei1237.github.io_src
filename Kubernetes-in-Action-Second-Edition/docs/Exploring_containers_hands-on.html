
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>2.2 Exploring containers hands-on · Kubernetes实战（第二版）</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="wangwei17">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Understanding_what_makes_containers_possible.html" />
    
    
    <link rel="prev" href="Introducing_containers.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://wangwei1237.gitee.io/" target="_blank" class="custom-link">17哥的个人网站</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    前言
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Welcome</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="Welcome.html">
            
                <a href="Welcome.html">
            
                    
                    Welcome
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part 1: First Time On a Boat: Introduction to Kubernetes</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="Introducing_Kubernetes_0.html">
            
                <a href="Introducing_Kubernetes_0.html">
            
                    
                    1 Introducing Kubernetes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="Introducing_Kubernetes_1.html">
            
                <a href="Introducing_Kubernetes_1.html">
            
                    
                    1.1 Introducing Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="Understanding_Kubernetes.html">
            
                <a href="Understanding_Kubernetes.html">
            
                    
                    1.2 Understanding Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="Introducing_Kubernetes_into_your_organization.html">
            
                <a href="Introducing_Kubernetes_into_your_organization.html">
            
                    
                    1.3 Introducing Kubernetes into your organization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="Summary_1.html">
            
                <a href="Summary_1.html">
            
                    
                    1.4 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="Understanding_containers.html">
            
                <a href="Understanding_containers.html">
            
                    
                    2 Understanding containers
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="Introducing_containers.html">
            
                <a href="Introducing_containers.html">
            
                    
                    2.1 Introducing containers
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.2.2" data-path="Exploring_containers_hands-on.html">
            
                <a href="Exploring_containers_hands-on.html">
            
                    
                    2.2 Exploring containers hands-on
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="Understanding_what_makes_containers_possible.html">
            
                <a href="Understanding_what_makes_containers_possible.html">
            
                    
                    2.3 Understanding what makes containers possible
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.4" data-path="Summary_2.html">
            
                <a href="Summary_2.html">
            
                    
                    2.4 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="Deploying_your_first_application.html">
            
                <a href="Deploying_your_first_application.html">
            
                    
                    3 DEPLOYING YOUR FIRST APPLICATION
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="Deploying_a_Kubernetes_cluster.html">
            
                <a href="Deploying_a_Kubernetes_cluster.html">
            
                    
                    3.1 Deploying a Kubernetes cluster
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.2" data-path="Interacting_with_Kubernetes.html">
            
                <a href="Interacting_with_Kubernetes.html">
            
                    
                    3.2 Interacting with Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.3" data-path="Running_your_first_application_on_Kubernetes.html">
            
                <a href="Running_your_first_application_on_Kubernetes.html">
            
                    
                    3.3  Running your first application on Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.4" data-path="Summary_3.html">
            
                <a href="Summary_3.html">
            
                    
                    3.4 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part 2: Learning the Ropes: Kubernetes API Objects</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="Introducing_the_Kubernetes_API_Objects.html">
            
                <a href="Introducing_the_Kubernetes_API_Objects.html">
            
                    
                    4. Introducing the Kubernetes API Objects
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="Getting_familiar_with_the_Kubernetes_API.html">
            
                <a href="Getting_familiar_with_the_Kubernetes_API.html">
            
                    
                    4.1 Getting familiar with the Kubernetes API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="Examining_an_objects_individual_properties.html">
            
                <a href="Examining_an_objects_individual_properties.html">
            
                    
                    4.2 Examining an object’s individual properties
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="Observing_cluster_events_via_Event_objects.html">
            
                <a href="Observing_cluster_events_via_Event_objects.html">
            
                    
                    4.3 Observing cluster events via Event objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="Summary_4.html">
            
                <a href="Summary_4.html">
            
                    
                    4.4 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="Running_applications_in_Pods.html">
            
                <a href="Running_applications_in_Pods.html">
            
                    
                    5. Running applications in Pods
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="Understanding_pods.html">
            
                <a href="Understanding_pods.html">
            
                    
                    5.1  Understanding pods
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="Creating_pods_from_YAML_or_JSON_files.html">
            
                <a href="Creating_pods_from_YAML_or_JSON_files.html">
            
                    
                    5.2 Creating pods from YAML or JSON files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.3" data-path="Interacting_with_the_application_and_the_pod.html">
            
                <a href="Interacting_with_the_application_and_the_pod.html">
            
                    
                    5.3 Interacting with the application and the pod
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.4" data-path="Running_multiple_containers_in_a_pod.html">
            
                <a href="Running_multiple_containers_in_a_pod.html">
            
                    
                    5.4 Running multiple containers in a pod
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.5" data-path="Running_additional_containers_at_pod_startup.html">
            
                <a href="Running_additional_containers_at_pod_startup.html">
            
                    
                    5.5 Running additional containers at pod startup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.6" data-path="Deleting_pods_and_other_objects.html">
            
                <a href="Deleting_pods_and_other_objects.html">
            
                    
                    5.6 Deleting pods and other objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.7" data-path="Summary_5.html">
            
                <a href="Summary_5.html">
            
                    
                    5.7 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="Managing_the_lifecycle_of_the_Pods_containers.html">
            
                <a href="Managing_the_lifecycle_of_the_Pods_containers.html">
            
                    
                    6. Managing the lifecycle of the Pod’s containers
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.3.1" data-path="Understanding_the_pods_status.html">
            
                <a href="Understanding_the_pods_status.html">
            
                    
                    6.1 Understanding the pod's status
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.2" data-path="Keeping_containers_healthy.html">
            
                <a href="Keeping_containers_healthy.html">
            
                    
                    6.2 Keeping containers healthy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.3" data-path="Executing_actions_at_container_startup_and_shutdown.html">
            
                <a href="Executing_actions_at_container_startup_and_shutdown.html">
            
                    
                    6.3 Executing actions at container start-up and shutdown
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.4" data-path="Understanding_the_pod_lifecycle.html">
            
                <a href="Understanding_the_pod_lifecycle.html">
            
                    
                    6.4 Understanding the pod lifecycle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.5" data-path="Summary_6.html">
            
                <a href="Summary_6.html">
            
                    
                    6.5 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="Mounting_storage_volumes_into_the_Pods_containers.html">
            
                <a href="Mounting_storage_volumes_into_the_Pods_containers.html">
            
                    
                    7. Mounting storage volumes into the Pod’s containers
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.4.1" data-path="Introducing_volumes.html">
            
                <a href="Introducing_volumes.html">
            
                    
                    7.1 Introducing volumes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4.2" data-path="Using_volumes.html">
            
                <a href="Using_volumes.html">
            
                    
                    7.2 Using volumes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4.3" data-path="Integrating_external_storage_into_pods.html">
            
                <a href="Integrating_external_storage_into_pods.html">
            
                    
                    7.3 Integrating external storage into pods
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4.4" data-path="Accessing_files_on_the_worker_nodes_filesystem.html">
            
                <a href="Accessing_files_on_the_worker_nodes_filesystem.html">
            
                    
                    7.4 Accessing files on the worker node’s filesystem
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4.5" data-path="Summary_7.html">
            
                <a href="Summary_7.html">
            
                    
                    7.5 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="Persisting_application_data_with_PersistentVolumes.html">
            
                <a href="Persisting_application_data_with_PersistentVolumes.html">
            
                    
                    8. Persisting application data with PersistentVolumes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.5.1" data-path="Decoupling_pods_from_the_underlying_storage_technology.html">
            
                <a href="Decoupling_pods_from_the_underlying_storage_technology.html">
            
                    
                    8.1 Decoupling pods from the underlying storage technology
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5.2" data-path="Creating_persistent_volumes_and_claims.html">
            
                <a href="Creating_persistent_volumes_and_claims.html">
            
                    
                    8.2 Creating persistent volumes and claims
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5.3" data-path="Dynamic_provisioning_of_persistent_volumes.html">
            
                <a href="Dynamic_provisioning_of_persistent_volumes.html">
            
                    
                    8.3 Dynamic provisioning of persistent volumes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5.4" data-path="Nodelocal_persistent_volumes.html">
            
                <a href="Nodelocal_persistent_volumes.html">
            
                    
                    8.4 Node-local persistent volumes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5.5" data-path="Summary_8.html">
            
                <a href="Summary_8.html">
            
                    
                    8.5 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >2.2 Exploring containers hands-on</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="22-exploring-containers-hands-on">2.2 Exploring containers hands-on</h1>
<p>You now have a feel for what containers are, but I have yet to explain how they work. Before we get to that, you need to create an application, package it into a container image and run it. You&#x2019;ll need Docker, so let&#x2019;s install it and run a Hello world container first.</p>
<h2 id="installing-docker-and-running-a-hello-world-container">Installing Docker and running a Hello World container</h2>
<p>Ideally, you&#x2019;ll install Docker directly on a Linux computer, so you won&#x2019;t have to deal with the additional complexity of running containers inside a VM running within your host OS. But, if you&#x2019;re using macOS or Windows and don&#x2019;t know how to set up a Linux VM, the Docker Desktop application will set it up for you. The Docker command-line (CLI) tool that you&#x2019;ll use to run containers will be installed in your host OS, but the Docker daemon will run inside the VM, as will all the containers it creates.</p>
<p>The Docker Platform consists of many components, but you only need to install Docker Engine to run containers. If you use macOS or Windows, install Docker Desktop. For details, follow the instructions at <a href="http://docs.docker.com/install" target="_blank">http://docs.docker.com/install</a>.</p>
<p><div class="alert alert-info hints-alert"><div class="hints-container"><p>NOTE</p>
<p>Docker Desktop for Windows can run either Windows or Linux containers. Make sure that you configure it to use Linux containers.</p>
</div></div></p>
<h3 id="running-a-hello-world-container">Running a Hello World container</h3>
<p>After the installation is complete, you use the docker CLI tool to run <code>docker</code> commands. First, let&#x2019;s try pulling and running an existing image from Docker Hub, the public image registry that contains ready-to-use container images for many well-known software packages. One of them is the <code>busybox</code> image, which you&#x2019;ll use to run a simple <code>echo &quot;Hello world&quot;</code> command in your first container.</p>
<p>If you&#x2019;re unfamiliar with <code>busybox</code>, it&#x2019;s a single executable file that combines many of the standard UNIX command-line tools, such as <code>echo</code>, <code>ls</code>, <code>gzip</code>, and so on. Instead of the busybox image, you could also use any other full-fledged OS container image like Fedora, Ubuntu, or any other image that contains the <code>echo</code> executable file.</p>
<p>You don&#x2019;t need to download or install anything to run the <code>busybox</code> image. You can do everything with a single <code>docker run</code> command, by specifying the image to download and the command to run in it. To run the simple Hello world container, execute the command shown in the following listing.</p>
<pre><code class="lang-shell">Listing 2.1 Running a Hello World container with Docker
$ docker run busybox echo &quot;Hello World&quot;
Unable to find image &apos;busybox:latest&apos; locally
latest: Pulling from library/busybox
7c9d20b9b6cd: Pull complete
Digest: sha256:fe301db49df08c384001ed752dff6d52b4&#x2026;
Status: Downloaded newer image for busybox:latest
Hello World
</code></pre>
<p>This doesn&#x2019;t look too impressive, but keep in mind that the entire &#x201C;application&#x201D; was downloaded and executed with a single command, without you having to install that application or any of its dependencies.</p>
<p>In your case, the app was just a single executable file, but it could have been an incredibly complex app with dozens of libraries and additional files. The entire process of setting up and running the app would be the same. What isn&#x2019;t obvious is that the app ran in a container, isolated from the other processes on the computer. You&#x2019;ll see that this is true in the exercises that follow.</p>
<h3 id="understanding-what-happens-when-you-run-a-container">Understanding what happens when you run a container</h3>
<p>Figure 2.10 shows exactly what happened when you executed the docker run command.</p>
<p><img src="../images/2.10.png" alt=""></p>
<p>The <code>docker</code> CLI tool sent an instruction to run the container to the Docker daemon, which checked whether the <code>busybox</code> image was already present in its local image cache. It wasn&#x2019;t, so it pulled it from the Docker Hub registry.</p>
<p>After downloading the image to your computer, the Docker daemon created a container from that image and executed the <code>echo</code> command in it. The command printed the text to the standard output, the process then terminated and the container stopped.</p>
<p>If your local computer runs a Linux OS, the Docker CLI tool and the daemon both run in this OS. If it runs macOS or Windows, the daemon and the containers run in the Linux VM.</p>
<h3 id="running-other-images">Running other images</h3>
<p>Running other existing container images is much the same as running the busybox image. In fact, it&#x2019;s often even simpler, since you don&#x2019;t normally need to specify what command to execute, as with the echo command in the previous example. The command that should be executed is usually written in the image itself, but you can override it when you run it.</p>
<p>For example, if you want to run the Redis datastore, you can find the image name on <a href="http://hub.docker.com" target="_blank">http://hub.docker.com</a> or another public registry. In the case of Redis, one of the images is called <code>redis:alpine</code>, so you&#x2019;d run it like this:</p>
<pre><code class="lang-shell">$ docker run redis:alpine
</code></pre>
<p>To stop and exit the container, press Control-C (or Command-C on a Mac).</p>
<p><div class="alert alert-info hints-alert"><div class="hints-container"><p>NOTE</p>
<p>If you want to run an image from a different registry, you must specify the registry along with the image name. For example, if you want to run an image from the Quay.io registry, which is another publicly accessible image registry, run it as follows: docker run quay.io/some/image.</p>
</div></div></p>
<h3 id="understanding-image-tags">Understanding image tags</h3>
<p>If you&#x2019;ve searched for the Redis image on Docker Hub, you&#x2019;ve noticed that there are many image tags you can choose from. For Redis, the tags are latest, buster, alpine, but also <code>5.0.7-buster</code>, <code>5.0.7-alpine</code>, and so on.</p>
<p>Docker allows you to have multiple versions or variants of the same image under the same name. Each variant has a unique tag. If you refer to images without explicitly specifying the tag, Docker assumes that you&#x2019;re referring to the special <code>latest</code> tag. When uploading a new version of an image, image authors usually tag it with both the actual version number and with <code>latest</code>. When you want to run the <code>latest</code> version of an image, use the latest tag instead of specifying the version.</p>
<p><div class="alert alert-info hints-alert"><div class="hints-container"><p>NOTE</p>
<p>The <code>docker run</code> command only pulls the image if it hasn&#x2019;t already pulled it before. Using the <code>latest</code> tag ensures that you get the latest version when you first run the image. The locally cached image is used from that point on.</p>
</div></div></p>
<p>Even for a single version, there are usually several variants of an image. For Redis I mentioned <code>5.0.7-buster</code> and <code>5.0.7-alpine</code>. They both contain the same version of Redis, but differ in the base image they are built on. <code>5.0.7-buster</code> is based on Debian version &#x201C;Buster&#x201D;, while <code>5.0.7-alpine</code> is based on the Alpine Linux base image, a very stripped-down image that is only 5MB in total &#x2013; it contains only a small set of the installed binaries you see in a typical Linux distribution.</p>
<p>To run a specific version and/or variant of the image, specify the tag in the image name. For example, to run the <code>5.0.7-alpine</code> tag, you&#x2019;d execute the following command:</p>
<pre><code>$ docker run redis:5.0.7-alpine
</code></pre><h2 id="creating-a-containerized-nodejs-web-application">Creating a containerized Node.js web application</h2>
<p>Now that you have a working Docker setup, you&#x2019;ll create an app that you&#x2019;ll use throughout the book. You&#x2019;ll create a trivial Node.js web application and package it into a container image. The application will accept HTTP requests and respond with the hostname of the computer it&#x2019;s running on.</p>
<p>This way, you&#x2019;ll see that an app running in a container sees a different hostname and not that of the host computer, even though it runs on the host like any other process. This will be useful later, when you deploy the app on Kubernetes and scale it out (scale it horizontally; that is, run multiple instances of the app). You&#x2019;ll see your HTTP requests hitting different instances of the app.</p>
<p>The app consists of a single file called <code>app.js</code> whose contents are shown in the next listing.</p>
<pre><code class="lang-shell">Listing 2.2 A simple Node.js web application: app.js
const http = require(&apos;http&apos;);
const os = require(&apos;os&apos;);

const listenPort = 8080;

console.log(&quot;Kubia server starting...&quot;);
console.log(&quot;Local hostname is &quot; + os.hostname());
console.log(&quot;Listening on port &quot; + listenPort);

var handler = function(request, response) {
  let clientIP = request.connection.remoteAddress;
  console.log(&quot;Received request for &quot;+request.url+&quot; from &quot;+clientIP);
  response.writeHead(200);
  response.write(&quot;Hey there, this is &quot;+os.hostname()+&quot;. &quot;);
  response.write(&quot;Your IP is &quot;+clientIP+&quot;. &quot;);
  response.end(&quot;\n&quot;);
};

var server = http.createServer(handler);
server.listen(listenPort);
</code></pre>
<p>The code in the listing should be easy to understand. It starts an HTTP server on port 8080. For each request, it logs the request information to standard output and sends a response with status code <code>200 OK</code> and the following text:</p>
<p>Hey there, this is <server-hostname>. Your IP is <client-ip>.</client-ip></server-hostname></p>
<p><div class="alert alert-info hints-alert"><div class="hints-container"><p>NOTE&#x2003;</p>
<p>The hostname in the response is the server&#x2019;s actual hostname, not the one sent by the client in the request&#x2019;s <code>Host</code> header. This detail will be important later.</p>
</div></div></p>
<p>You could now download and install Node.js locally and test your app directly, but that&#x2019;s not necessary. It&#x2019;s easier to package it into a container image and run it with Docker. This enables you to run the app on any other Docker-enabled host without installing Node.js there either.</p>
<h2 id="creating-a-dockerfile-to-build-the-container-image">Creating a Dockerfile to build the container image</h2>
<p>To package your app into an image, you must first create a file called <code>Dockerfile</code>, which contains a list of instructions that Docker should perform when building the image. Create the file in the same directory as the <code>app.js</code> file and make sure it contains the three directives in the following listing.</p>
<pre><code class="lang-shell">Listing 2.3 A minimal Dockerfile for building a container image for your app
FROM node:12
ADD app.js /app.js
ENTRYPOINT [&quot;node&quot;, &quot;app.js&quot;]
</code></pre>
<p>The FROM line defines the container image that you&#x2019;ll use as the starting point (the base image you&#x2019;re building on top of). In your case, you use the <code>node</code> container image, tag 12. In the second line, you add the <code>app.js</code> file from your local directory into the root directory of the image, under the same name (<code>app.js</code>). Finally, in the third line, you specify the command that Docker should run when you execute the image. In your case, the command is <code>node app.js</code>.</p>
<p><div class="alert alert-info hints-alert"><div class="hints-container"><p>Choosing a base image</p>
</div></div></p>
<p>You may wonder why use this specific image as your base. Because your app is a Node.js app, you need your image to contain the <code>node</code> binary file to run the app. You could have used any image containing this binary, or you could have even used a Linux distribution base image such as <code>fedora</code> or <code>ubuntu</code> and installed Node.js into the container when building the image. But since the <code>node</code> image already contains everything needed to run Node.js apps, it doesn&#x2019;t make sense to build the image from scratch. In some organizations, however, the use of a specific base image and adding software to it at build-time may be mandatory.</p>
<h2 id="building-the-container-image">Building the container image</h2>
<p>The <code>Dockerfile</code> and the <code>app.js</code> file are everything you need to build your image. You&#x2019;ll now build the image named <code>kubia:latest</code> using the command in the next listing:</p>
<pre><code class="lang-shell">Listing 2.4 Building the image
$ docker build -t kubia:latest .
Sending build context to Docker daemon  3.072kB
Step 1/3 : FROM node:12
12: Pulling from library/node      
092586df9206: Pull complete
ef599477fae0: Pull complete
&#x2026;
89e674ac3af7: Pull complete
08df71ec9bb0: Pull complete
Digest: sha256:a919d679dd773a56acce15afa0f436055c9b9f20e1f28b4469a4bee69e0&#x2026;
Status: Downloaded newer image for node:12
 ---&gt; e498dabfee1c
Step 2/3 : ADD app.js /app.js
 ---&gt; 28d67701d6d9
Step 3/3 : ENTRYPOINT [&quot;node&quot;, &quot;app.js&quot;]
 ---&gt; Running in a01d42eda116
Removing intermediate container a01d42eda116
 ---&gt; b0ecc49d7a1d
Successfully built b0ecc49d7a1d
Successfully tagged kubia:latest
</code></pre>
<p>The <code>-t</code> option specifies the desired image name and tag and the dot at the end specifies the path to the directory that contains the Dockerfile and the build context (all artefacts needed by the build process).</p>
<p>When the build process is complete, the newly created image is available in your computer&#x2019;s local image store. You can see it by listing local images, as in the following listing.</p>
<pre><code class="lang-shell">Listing 2.5 Listing locally stored images
$ docker images
REPOSITORY   TAG      IMAGE ID           CREATED             VIRTUAL SIZE
kubia        latest   b0ecc49d7a1d       1 minute ago        908 MB
&#x2026;
</code></pre>
<h3 id="understanding-how-the-image-was-built">Understanding how the image was built</h3>
<p>Figure 2.11 shows what happens during the build process. You tell Docker to build an image called <code>kubia</code> based on the contents of the current directory. Docker reads the Dockerfile in the directory and builds the image based on the directives in the file.</p>
<p><img src="../images/2.11.png" alt=""></p>
<p>The build itself isn&#x2019;t performed by the <code>docker</code> CLI tool. Instead, the contents of the entire directory are uploaded to the Docker daemon and the image is built by it. You&#x2019;ve already learned that the CLI tool and the daemon aren&#x2019;t necessarily on the same computer. If you&#x2019;re using Docker on a non-Linux system such as macOS or Windows, the client is in your host OS, but the daemon runs inside a Linux VM. But it could also run on a remote computer.</p>
<p><div class="alert alert-info hints-alert"><div class="hints-container"><p>TIP</p>
<p>Don&#x2019;t add unnecessary files to the build directory, as they will slow down the build process&#x2014;especially if the Docker daemon is located on a remote system.</p>
</div></div></p>
<p>To build the image, Docker first pulls the base image <code>(node:12)</code> from the public image repository (Docker Hub in this case), unless the image is already stored locally. It then creates a new container from the image and executes the next directive from the Dockerfile. The container&#x2019;s final state yields a new image with its own ID. The build process continues by processing the remaining directives in the Dockerfile. Each one creates a new image. The final image is then tagged with the tag you specified with the <code>-t</code> flag in the <code>docker build</code> command.</p>
<h3 id="understanding-what-the-layers-in-the-image-are">Understanding what the layers in the image are</h3>
<p>Some pages ago, you learned that images consist of several layers. One might think that each image consists of only the layers of the base image and a single new layer on top, but that&#x2019;s not the case. When building an image, a new layer is created for each individual directive in the Dockerfile.</p>
<p>During the build of the kubia image, after it pulls all the layers of the base image, Docker creates a new layer and adds the <code>app.js</code> file into it. It then creates yet another layer that holds just the command to run when the image is executed. This last layer is then tagged as <code>kubia:latest</code>.</p>
<p>You can see the layers of an image and their size by running <code>docker history</code>, as shown in the following listing. The top layers are printed first.</p>
<pre><code class="lang-shell">Listing 2.6 Displaying the layers of a container image
$ docker history kubia:latest
IMAGE         CREATED     CREATED BY                          SIZE
b0ecc49d7a1d  7 min ago   /bin/sh -c #(nop) ENTRYPOINT [&quot;node&quot;&#x2026;   0B
28d67701d6d9  7 min ago   /bin/sh -c #(nop) ADD file:2ed5d7753&#x2026;   367B
e498dabfee1c  2 days ago  /bin/sh -c #(nop) CMD [&quot;node&quot;]          0B
&lt;missing&gt;     2 days ago  /bin/sh -c #(nop) ENTRYPOINT [&quot;docke&#x2026;   0B
&lt;missing&gt;     2 days ago  /bin/sh -c #(nop) COPY file:23873730&#x2026;   116B
&lt;missing&gt;     2 days ago  /bin/sh -c set -ex &amp;&amp; for key in 6A0&#x2026;   5.4MB
&lt;missing&gt;     2 days ago  /bin/sh -c #(nop)  ENV YARN_VERSION=&#x2026;   0B
&lt;missing&gt;     2 days ago  /bin/sh -c ARCH= &amp;&amp; dpkgArch=&quot;$(dpkg&#x2026;   67MB
&lt;missing&gt;     2 days ago  /bin/sh -c #(nop)  ENV NODE_VERSION=&#x2026;   0B
&lt;missing&gt;     3 weeks ago /bin/sh -c groupadd --gid 1000 node &#x2026;   333kB
&lt;missing&gt;     3 weeks ago /bin/sh -c set -ex;  apt-get update;&#x2026;   562MB
&lt;missing&gt;     3 weeks ago /bin/sh -c apt-get update &amp;&amp; apt-get&#x2026;   142MB
&lt;missing&gt;     3 weeks ago /bin/sh -c set -ex;  if ! command -v&#x2026;   7.8MB
&lt;missing&gt;     3 weeks ago /bin/sh -c apt-get update &amp;&amp; apt-get&#x2026;   23.2MB
&lt;missing&gt;     3 weeks ago /bin/sh -c #(nop)  CMD [&quot;bash&quot;]         0B
&lt;missing&gt;     3 weeks ago /bin/sh -c #(nop) ADD file:9788b61de&#x2026;   101MB
</code></pre>
<p>Most of the layers you see come from the <code>node:12</code> image (they also include layers of that image&#x2019;s own base image). The two uppermost layers correspond to the second and third directives in the Dockerfile (<code>ADD</code> and <code>ENTRYPOINT</code>).</p>
<p>As you can see in the <code>CREATED BY</code> column, each layer is created by executing a command in the container. In addition to adding files with the <code>ADD</code> directive, you can also use other directives in the Dockerfile. For example, the <code>RUN</code> directive executes a command in the container during the build. In the listing above, you&#x2019;ll find a layer where the apt-get update and some additional <code>apt-get</code> commands were executed. <code>apt-get</code> is part of the Ubuntu package manager used to install software packages. The command shown in the listing installs some packages onto the image&#x2019;s filesystem.</p>
<p>To learn about RUN and other directives you can use in a Dockerfile, refer to the Dockerfile reference at <a href="https://docs.docker.com/engine/reference/builder/[https://docs.docker.com/engine/reference/builder/" target="_blank">https://docs.docker.com/engine/reference/builder/[https://docs.docker.com/engine/reference/builder/</a>].</p>
<p><div class="alert alert-info hints-alert"><div class="hints-container"><p>TIP</p>
<p>Each directive creates a new layer. I have already mentioned that when you delete a file, it is only marked as deleted in the new layer and is not removed from the layers below. Therefore, deleting a file with a subsequent directive won&#x2019;t reduce the size of the image. If you use the <code>RUN</code> directive, make sure that the command it executes deletes all temporary files it creates before it terminates.</p>
</div></div></p>
<h2 id="running-the-container-image">Running the container image</h2>
<p>With the image built and ready, you can now run the container with the following command:</p>
<pre><code class="lang-shell">$ docker run --name kubia-container -p 1234:8080 -d kubia
9d62e8a9c37e056a82bb1efad57789e947df58669f94adc2006c087a03c54e02
</code></pre>
<p>This tells Docker to run a new container called <code>kubia-container</code> from the kubia image. The container is detached from the console (<code>-d</code> flag) and runs in the background. Port <code>1234</code> on the host computer is mapped to port 8080 in the container (specified by the <code>-p 1234:8080</code> option), so you can access the app at <a href="http://localhost:1234" target="_blank">http://localhost:1234</a>.</p>
<p>The following figure should help you visualize how everything fits together. Note that the Linux VM exists only if you use macOS or Windows. If you use Linux directly, there is no VM and the box depicting port <code>1234</code> is at the edge of the local computer.</p>
<p><img src="../images/2.12.png" alt=""></p>
<h3 id="accessing-your-app">Accessing your app</h3>
<p>Now access the application at <a href="http://localhost:1234" target="_blank">http://localhost:1234</a> using curl or your internet browser:</p>
<pre><code class="lang-shell">$ curl localhost:1234
Hey there, this is 44d76963e8e1. Your IP is ::ffff:172.17.0.1.
</code></pre>
<p><div class="alert alert-info hints-alert"><div class="hints-container"><p>NOTE</p>
<p>If the Docker Daemon runs on a different machine, you must replace localhost with the IP of that machine. You can look it up in the DOCKER_HOST environment variable.</p>
</div></div></p>
<p>If all went well, you should see the response sent by the application. In my case, it returns <code>44d76963e8e1</code> as its hostname. In your case, you&#x2019;ll see a different hexadecimal number. This is the ID of the container that is displayed when you list them.</p>
<h3 id="listing-all-running-containers">Listing all running containers</h3>
<p>To list all the containers that are running on your computer, run the command that appears in the following listing. The output of the command has been edited to fit on the page&#x2014;the last two lines of the output are the continuation of the first two.</p>
<pre><code class="lang-shell">Listing 2.6 Listing running containers
$ docker ps
CONTAINER ID    IMAGE           COMMAND          CREATED        ...
44d76963e8e1    kubia:latest    &quot;node app.js&quot;    6 minutes ago  ...

...  STATUS          PORTS                     NAMES
...  Up 6 minutes    0.0.0.0:1234-&gt;8080/tcp    kubia-container
</code></pre>
<p>For each container, Docker prints its ID and name, the image it uses, and the command it executes. It also shows when the container was created, what status it has, and which host ports are mapped to the container.</p>
<h3 id="getting-additional-information-about-a-container">Getting additional information about a container</h3>
<p>The <code>docker ps</code> command shows the most basic information about the containers. To see additional information, you can use <code>docker inspect</code>:</p>
<pre><code class="lang-shell">$ docker inspect kubia-container
</code></pre>
<p>Docker prints a long JSON-formatted document containing a lot of information about the container, such as its state, config, and network settings, including its IP address.</p>
<h3 id="inspecting-the-application-log">Inspecting the application log</h3>
<p>Docker captures and stores everything the application writes to the standard output and error streams. This is typically the place where applications write their logs. You can use the <code>docker logs</code> command to see the output, as shown in the next listing.</p>
<pre><code class="lang-shell">Listing 2.7 Displaying the container&#x2019;s log
$ docker logs kubia-container
Kubia server starting...
Local hostname is 44d76963e8e1
Listening on port 8080
Received request for / from ::ffff:172.17.0.1
</code></pre>
<p>You now know the basic commands for executing and inspecting an application in a container. Next, you&#x2019;ll learn how to distribute it.</p>
<h2 id="distributing-container-images">Distributing container images</h2>
<p>The image you&#x2019;ve built is currently only available locally. To run it on other computers, you must first push it to an external image registry. Let&#x2019;s push it to the public Docker Hub registry, so that you don&#x2019;t need to set up a private one. You can also use other registries, such as Quay.io, which I&#x2019;ve already mentioned, or the Google Container Registry.</p>
<p>Before you push the image, you must re-tag it according to Docker Hub&#x2019;s image naming schema. The image name must include your Docker Hub ID, which you choose when you register at <a href="http://hub.docker.com" target="_blank">http://hub.docker.com</a>. I&#x2019;ll use my own ID (<code>luksa</code>) in the following examples, so remember to replace it with your ID when trying the commands yourself.</p>
<h3 id="tagging-an-image-under-an-additional-tag">Tagging an image under an additional tag</h3>
<p>Once you have your ID, you&#x2019;re ready to add an additional tag <code>for</code> your image. Its current name is <code>kubia</code> and you&#x2019;ll now tag it also as <code>yourid/kubia:1.0</code> (replace <code>yourid</code> with your actual Docker Hub ID). This is the command I used:</p>
<pre><code class="lang-shell">$ docker tag kubia luksa/kubia:1.0
</code></pre>
<p>Confirm that your image now has two names by listing images again, as in the following listing.</p>
<pre><code class="lang-shell">Listing 2.7 A container image with multiple tags
$ docker images | head
REPOSITORY     TAG       IMAGE ID        CREATED              VIRTUAL SIZE
luksa/kubia    1.0       b0ecc49d7a1d    About an hour ago    908 MB
kubia          latest    b0ecc49d7a1d    About an hour ago    908 MB
node           12        e498dabfee1c    3 days ago           908 MB
</code></pre>
<p>As you can see, both <code>kubia</code> and <code>luksa/kubia:1.0</code> point to the same image ID, meaning that these aren&#x2019;t two images, but a single image with two names.</p>
<h3 id="pushing-the-image-to-docker-hub">Pushing the image to Docker Hub</h3>
<p>Before you can push the image to Docker Hub, you must log in with your user ID using the <code>docker login</code> command as follows:</p>
<pre><code class="lang-shell">$ docker login -u yourid -p yourpassword docker.io
</code></pre>
<p>Once logged in, push the <code>yourid/kubia:1.0</code> image to Docker Hub with the following command:</p>
<pre><code class="lang-shell">$ docker push yourid/kubia:1.0
</code></pre>
<h3 id="running-the-image-on-other-hosts">Running the image on other hosts</h3>
<p>When the push to Docker Hub is complete, the image is available to all. You can now run the image on any Docker-enabled host by running the following command:</p>
<pre><code class="lang-shell">$ docker run -p 1234:8080 -d luksa/kubia:1.0
</code></pre>
<p>If the container runs correctly on your computer, it should run on any other Linux computer, provided that the Node.js binary doesn&#x2019;t need any special Kernel features (it doesn&#x2019;t).</p>
<h2 id="stopping-and-deleting-containers">Stopping and deleting containers</h2>
<p>If you&#x2019;ve run the container on the other host, you can now terminate it, as you&#x2019;ll only need the one on your local computer for the exercises that follow.</p>
<h3 id="stopping-a-container">Stopping a container</h3>
<p>Instruct Docker to stop the container with this command:</p>
<pre><code class="lang-shell">$ docker stop kubia-container
</code></pre>
<p>This sends a termination signal to the main process in the container so that it can shut down gracefully. If the process doesn&#x2019;t respond to the termination signal or doesn&#x2019;t shut down in time, Docker kills it. When the top-level process in the container terminates, no other process runs in the container, so the container is stopped.</p>
<h3 id="deleting-a-container">Deleting a container</h3>
<p>The container is no longer running, but it still exists. Docker keeps it around in case you decide to start it again. You can see stopped containers by running <code>docker ps -a</code>. The <code>-a</code> option prints all the containers - those running and those that have been stopped. As an exercise, you can start the container again by running <code>docker start kubia-container</code>.</p>
<p>You can safely delete the container on the other host, because you no longer need it. To delete it, run the following <code>docker rm</code> command:</p>
<pre><code class="lang-shell">$ docker rm kubia-container
</code></pre>
<p>This deletes the container. All its contents are removed and it can no longer be started. The image is still there, though. If you decide to create the container again, the image won&#x2019;t need to be downloaded again. If you also want to delete the image, use the <code>docker rmi</code> command:</p>
<pre><code class="lang-shell">$ docker rmi kubia:latest
</code></pre>
<p>To remove all dangling images, you can also use the docker image prune command.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Introducing_containers.html" class="navigation navigation-prev " aria-label="Previous page: 2.1 Introducing containers">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Understanding_what_makes_containers_possible.html" class="navigation navigation-next " aria-label="Next page: 2.3 Understanding what makes containers possible">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"2.2 Exploring containers hands-on","level":"3.2.2","depth":2,"next":{"title":"2.3 Understanding what makes containers possible","level":"3.2.3","depth":2,"path":"docs/Understanding_what_makes_containers_possible.md","ref":"docs/Understanding_what_makes_containers_possible.md","articles":[]},"previous":{"title":"2.1 Introducing containers","level":"3.2.1","depth":2,"path":"docs/Introducing_containers.md","ref":"docs/Introducing_containers.md","articles":[]},"dir":"ltr"},"config":{"plugins":["page-toc-button","cnzz","hints","sitemap-general"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"search":{},"cnzz":{"style":"1","visible":true,"siteid":"1278605528"},"hints":{"danger":"fa fa-bug","info":"fa fa-info-circle","tip":"fa fa-sticky-note","working":"fa fa-cog fa-spin"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sitemap-general":{"prefix":"https://wangwei1237.gitee.io/kubernetes-in-action-second-edition"},"fontsettings":{"theme":"white","family":"serif","size":2},"highlight":{},"page-toc-button":{"maxTocDepth":2,"minTocSize":2},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"wangwei17","pdf":{"pageBreaksBefore":"/","headerTemplate":null,"paperSize":"a4","margin":{"right":62,"left":62,"top":36,"bottom":36},"fontSize":16,"fontFamily":"Arial","footerTemplate":null,"chapterMark":"pagebreak","pageNumbers":true},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"isbn":"","variables":{},"title":"Kubernetes实战（第二版）","links":{"sharing":{"all":null,"facebook":null,"google":null,"twitter":null,"weibo":null},"sidebar":{"17哥的个人网站":"https://wangwei1237.gitee.io/"}},"gitbook":"*","description":"Kubernetes实战（第二版）","extension":null},"file":{"path":"docs/Exploring_containers_hands-on.md","mtime":"2020-12-09T06:48:15.085Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-12-10T08:08:07.100Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-cnzz/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

